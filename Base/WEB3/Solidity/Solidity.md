

[solidityå­¦ä¹ -ä¸€äº›åŸºç¡€æ”»å‡»_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1th4y1V7iG/)

# 0 ä»‹ç»

[ä¸­æ–‡ç‰ˆ Solidity develop æ–‡æ¡£ (solidity-cn.readthedocs.io)](https://solidity-cn.readthedocs.io/zh/develop/introduction-to-smart-contracts.html)


**é¢è¯•**ï¼š
### åˆçº¦å‘é€toçš„ç±»å‹
| ç±»å‹                | æè¿°                |
| ----------------- | ----------------- |
| `address`         | æ™®é€šåœ°å€ï¼Œä¸å¯è°ƒç”¨åˆçº¦æ–¹æ³•     |
| `address payable` | å¯æ¥æ”¶ ETH çš„åœ°å€ï¼ˆæ¨èä½¿ç”¨ï¼‰ |

| æ–¹æ³•         | æ˜¯å¦è‡ªåŠ¨å›é€€ | é™åˆ¶Gas  | æŠ¥é”™æ–¹å¼            | æ¨èç¨‹åº¦          |
| ---------- | ------ | ------ | --------------- | ------------- |
| `transfer` | âœ… æ˜¯    | å›ºå®š2300 | è‡ªåŠ¨revert        | âš ï¸ ä¸æ¨èï¼ˆgasé™åˆ¶ï¼‰ |
| `send`     | âœ… æ˜¯    | å›ºå®š2300 | è¿”å›bool          | ğŸš« ä¸æ¨èï¼ˆä¸å®‰å…¨ï¼‰   |
| `call`     | âŒ å¦    | å¯è‡ªå®šä¹‰   | æ¨èç”¨æ³•éœ€æ£€æŸ¥ success | âœ… æ¨è          |
### å‘é€äº¤æ˜“ä¸­çš„æ‰§è¡Œå­—æ®µ

| å­—æ®µå                    | ä½œç”¨æè¿°                                         |
| ---------------------- | -------------------------------------------- |
| `from`                 | å‘èµ·äº¤æ˜“çš„åœ°å€ï¼ˆå‘é€æ–¹ï¼‰                                 |
| `to`                   | æ¥æ”¶åœ°å€ï¼ˆåˆçº¦æˆ–ç”¨æˆ·åœ°å€ï¼Œåˆçº¦éƒ¨ç½²æ—¶ä¸º `null`ï¼‰                  |
| `value`                | å‘é€çš„ ETH æ•°é‡ï¼ˆä»¥ wei ä¸ºå•ä½ï¼‰                        |
| `data`                 | è¦è°ƒç”¨çš„åˆçº¦å‡½æ•°çš„ç¼–ç ï¼ˆæˆ–éƒ¨ç½²åˆçº¦æ—¶çš„åˆçº¦å­—èŠ‚ç ï¼‰                    |
| `gas`                  | æœ€å¤§ gas é™é¢ï¼ˆé™åˆ¶æ­¤äº¤æ˜“æœ€å¤šæ¶ˆè€—å¤šå°‘ gasï¼‰                   |
| `gasPrice`             | æ¯å•ä½ gas çš„ä»·æ ¼ï¼ˆåœ¨ EIP-1559 å‰æ˜¯å›ºå®šä»·æ ¼ï¼‰               |
| `nonce`                | äº¤æ˜“è®¡æ•°å™¨ï¼ˆé˜²æ­¢é‡æ”¾æ”»å‡»ï¼Œæ¯ä¸ªåœ°å€å”¯ä¸€é€’å¢ï¼‰                       |
| `chainId`              | æ‰€åœ¨é“¾çš„ IDï¼ˆç”¨äºé˜²é‡æ”¾æ”»å‡»ï¼ŒEIP-155 ç­¾åæœºåˆ¶ï¼‰                |
| `accessList`           | ï¼ˆå¯é€‰ï¼‰EIP-2930 æå‡ºçš„å­—æ®µï¼Œé¢„å£°æ˜éœ€è¦è®¿é—®çš„ storageï¼ˆä¼˜åŒ– gasï¼‰  |
| `maxPriorityFeePerGas` | ç”¨æˆ·æ„¿æ„æ”¯ä»˜ç»™çŸ¿å·¥çš„â€œå°è´¹â€ï¼ŒEIP-1559 å¼•å…¥                   |
| `maxFeePerGas`         | ç”¨æˆ·æ„¿æ„æ”¯ä»˜çš„æœ€å¤š gas è´¹ç”¨ï¼ˆåŒ…å« baseFee å’Œå°è´¹ï¼‰ï¼ŒEIP-1559 å¼•å…¥ |
| `signature`            | ç­¾åï¼ˆç”±ç§é’¥ç­¾å‡ºçš„ï¼ŒåŒ…å« `v`, `r`, `s` ä¸‰ä¸ªéƒ¨åˆ†ï¼‰             |

## EIPåè®®

^77d770

### EIP-721
ï¼ˆä¹Ÿå« ERC-721ï¼‰æ˜¯ **ä»¥å¤ªåŠä¸Šç¬¬ä¸€ä¸ªè¢«å¹¿æ³›ä½¿ç”¨çš„â€œéåŒè´¨åŒ–ä»£å¸æ ‡å‡†â€**ï¼Œé€šå¸¸ç”¨äºè¡¨ç¤º NFTï¼ˆéåŒè´¨åŒ–ä»£å¸ï¼ŒNon-Fungible Tokenï¼‰ã€‚

### EIP1155

EIP-1155 æ˜¯ä¸€ç§**å¤šä»£å¸æ ‡å‡†**ï¼Œå…¨ç§°æ˜¯ **"Multi Token Standard"**ï¼Œç”± Enjin æå‡ºï¼Œä¸»è¦ç›®æ ‡æ˜¯ç»Ÿä¸€ç®¡ç†**åŒä¸€ä¸ªåˆçº¦ä¸­å¤šä¸ªç±»å‹çš„ä»£å¸**ï¼ˆåŒ…æ‹¬ FTã€NFTï¼‰â€”â€”æ¯” EIP-20ï¼ˆERC20ï¼‰æˆ– EIP-721ï¼ˆERC721ï¼‰æ›´é«˜æ•ˆã€‚

---

**ğŸ§± ç®€å•ç†è§£**
- **ä¸€ä¸ªåˆçº¦ï¼Œå¤šä¸ªä»£å¸ ID**ã€‚
- æ¯ä¸ª `tokenId` å¯ä»£è¡¨ä¸åŒä»£å¸ï¼š
    - `tokenId=1`: æŸç§ Fungible Tokenï¼ˆå¯åˆ†ï¼‰
    - `tokenId=2`: æŸä¸ª NFTï¼ˆä¸å¯åˆ†ï¼‰
- æ”¯æŒ **æ‰¹é‡è½¬è´¦ã€æŸ¥è¯¢ã€æˆæƒ**ï¼ŒèŠ‚çœ Gas æˆæœ¬ã€‚



**ğŸ§ª å¯¹æ¯” ERC20 å’Œ ERC721**

| ç‰¹æ€§     | ERC20  | ERC721   | ERC1155       |
| ------ | ------ | -------- | ------------- |
| å¤šèµ„äº§ç®¡ç†  | âŒ ä¸€ç§ä»£å¸ | âŒ ä¸€ç§ NFT | âœ… å¤šä¸ª ID å¤šç§èµ„äº§  |
| æ˜¯å¦å¯åˆ†   | âœ… å¯åˆ†   | âŒ ä¸å¯åˆ†    | âœ… æˆ– âŒ å–å†³äºä»£å¸è®¾è®¡ |
| æ‰¹é‡æ“ä½œ   | âŒ ä¸æ”¯æŒ  | âŒ ä¸æ”¯æŒ    | âœ… æ‰¹é‡è½¬è´¦ã€æˆæƒç­‰    |
| Gas æˆæœ¬ | ğŸ’¸ åé«˜  | ğŸ’¸ åé«˜    | ğŸ’° æ›´çœ Gas     |


### EIP-4337
EIP-4337 æ˜¯ä»¥å¤ªåŠæå‡ºçš„ä¸€é¡¹å…³é”®æ‰©å±•ææ¡ˆï¼Œæ­£å¼åç§°æ˜¯ï¼š

> **"Account Abstraction via Entry Point Contract specification"**  
> ï¼ˆé€šè¿‡å…¥å£åˆçº¦å®ç°è´¦æˆ·æŠ½è±¡ï¼‰

å®ƒçš„ç›®æ ‡æ˜¯ï¼š**ä¸æ”¹åŠ¨ä»¥å¤ªåŠæ ¸å¿ƒåè®®ï¼ˆå…±è¯†å±‚ï¼‰ï¼Œåœ¨åˆçº¦å±‚å®ç°â€œè´¦æˆ·æŠ½è±¡â€ï¼ˆAccount Abstractionï¼‰**ã€‚


 **ğŸ§  ä»€ä¹ˆæ˜¯è´¦æˆ·æŠ½è±¡ï¼ˆAccount Abstractionï¼‰ï¼Ÿ**

ä»¥å¤ªåŠä¸­è´¦æˆ·åˆ†ä¸ºä¸¤ç±»ï¼š

- **EOAï¼ˆExternally Owned Accountï¼‰ï¼šå¤–éƒ¨è´¦æˆ·**ï¼Œå¦‚æ™®é€šé’±åŒ…ï¼ˆMetaMaskã€ç¡¬ä»¶é’±åŒ…ç­‰ï¼‰
    
- **åˆçº¦è´¦æˆ·**ï¼Œæ™ºèƒ½åˆçº¦æ§åˆ¶çš„é’±åŒ…
    

ç›®å‰ï¼ŒEOA å¿…é¡»ä½¿ç”¨ç§é’¥ç­¾åäº¤æ˜“ï¼Œæµç¨‹å’ŒåŠŸèƒ½å›ºå®šã€ä¸å¯æ‰©å±•ã€‚è€Œè´¦æˆ·æŠ½è±¡çš„ç›®æ ‡æ˜¯ï¼š

> **æ‰“ç ´â€œEOAå¿…é¡»é ç§é’¥ç­¾åâ€çš„é™åˆ¶ï¼Œè®©ç”¨æˆ·è´¦æˆ·ä¹Ÿåƒåˆçº¦ä¸€æ ·çµæ´»ã€‚**

---

 **âœ… EIP-4337 çš„æ ¸å¿ƒæœºåˆ¶**

EIP-4337 çš„æ ¸å¿ƒæ˜¯é€šè¿‡ä¸€ä¸ªç§°ä¸º **EntryPoint åˆçº¦** çš„â€œä¸­æ¢æ§åˆ¶å™¨â€æ¥æ¥ç®¡äº¤æ˜“å¤„ç†æµç¨‹ï¼š

1. **UserOperation å¯¹è±¡**

ä¼ ç»Ÿäº¤æ˜“å« `Transaction`ï¼ŒEIP-4337 å®šä¹‰äº†ä¸€ä¸ªæ–°ç»“æ„å« **`UserOperation`**ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ç§æ‰©å±•ç‰ˆäº¤æ˜“ç»“æ„ï¼ŒåŒ…å«ï¼š
- ç”¨æˆ·æ„å›¾ï¼ˆfromã€toã€dataã€valueï¼‰
- ç­¾å
- éªŒè¯é€»è¾‘
- æ”¯ä»˜é€»è¾‘ï¼ˆæ”¯æŒä»£ä»˜ï¼‰

2. **Bundlerï¼ˆæ‰“åŒ…è€…ï¼‰**
ç±»ä¼¼çŸ¿å·¥ï¼Œä½†ä¸“é—¨å¤„ç† `UserOperation`ï¼Œæ‰“åŒ…ä¸€å †æ“ä½œå‘é€åˆ° EntryPoint åˆçº¦ã€‚

3. **EntryPoint åˆçº¦**
ç»Ÿä¸€æ¥æ”¶ UserOperationï¼Œè°ƒç”¨é’±åŒ…çš„éªŒè¯ä¸æ‰§è¡Œé€»è¾‘ã€‚

 4. **æ™ºèƒ½åˆçº¦é’±åŒ…ï¼ˆSmart Contract Walletï¼‰**
è´¦æˆ·ç”±åˆçº¦æ§åˆ¶ï¼Œæ¯ä¸ªé’±åŒ…åˆçº¦éœ€å®ç° `validateUserOp` å’Œ `executeUserOp` æ¥å£ï¼Œç”¨äºéªŒè¯ç­¾åå’Œæ‰§è¡Œäº¤æ˜“ã€‚

**ğŸ” å®ƒå¸¦æ¥äº†å“ªäº›å¥½å¤„ï¼Ÿ**

| åŠŸèƒ½      | EIP-4337 èƒ½åŠ›è¯´æ˜                      |
| ------- | ---------------------------------- |
| è‡ªå®šä¹‰ç­¾åæœºåˆ¶ | ä¸å†å¼ºä¾èµ– ECDSAï¼Œå¯æ”¯æŒ Passkeyã€ç¤¾äº¤æ¢å¤ã€MPC ç­‰ |
| Gas ä»£ä»˜  | å¯ç”¨ç¬¬ä¸‰æ–¹ï¼ˆPaymasterï¼‰ä»£ä¸ºæ”¯ä»˜ gasï¼Œé™ä½ç”¨æˆ·é—¨æ§›    |
| æ‰¹é‡æ“ä½œ    | å¤šç¬”äº¤æ˜“ä¸€æ¬¡æ€§æäº¤ï¼Œä¾‹å¦‚æ‰¹å‡† + è½¬è´¦                |
| é™åˆ¶æƒé™    | é™å®šæ¯å¤©æœ€å¤šè½¬å¤šå°‘ ETHã€é™åˆ¶è½¬è´¦åœ°å€ç­‰              |
| ç¤¾äº¤æ¢å¤    | é’±åŒ…å¯ä»¥å†…ç½®â€œæœ‹å‹æŠ•ç¥¨æ¢å¤â€æœºåˆ¶                   |
| æ— éœ€åŠ©è®°è¯   | é’±åŒ…å¯ç»‘å®šç”Ÿç‰©è¯†åˆ«/ç¡¬ä»¶/MPC ç­‰æ–¹å¼ï¼ŒçœŸæ­£ç”¨æˆ·å‹å¥½        |


# 1 åŸºç¡€

## 1.1 æ•°æ®ç±»å‹

### 1.1.1 æ•°æ®ç±»å‹



| ç±»å‹   | ç¤ºä¾‹                                              | å­˜å‚¨æ–¹å¼ï¼ˆé»˜è®¤ï¼‰                | ä¼ å€¼/ä¼ å¼•ç”¨ | ç‰¹æ®Šè¯´æ˜                         |
| ---- | ----------------------------------------------- | ----------------------- | ------ | ---------------------------- |
| å€¼ç±»å‹  | `uint`, `bool`                                  | stack                   | âœ… ä¼ å€¼   | å­˜åœ¨å‡½æ•°å†…éƒ¨å¿«é€Ÿè®¿é—®                   |
| å¼•ç”¨ç±»å‹ | `string`, `bytes`, `array`, `mapping`, `struct` | storage/memory/calldata | âœ… ä¼ å¼•ç”¨  | éœ€è¦æ˜¾å¼å£°æ˜ `memory` æˆ– `calldata` |
> åœ¨ Solidity ä¸­ï¼Œ**å€¼ç±»å‹å˜é‡é»˜è®¤åˆ†é…åœ¨ EVM çš„æ ˆä¸Š**ï¼Œæ”¯æŒå¿«é€Ÿè¯»å†™ï¼Œä½†æœ€å¤šåªèƒ½å®¹çº³ 1024 ä¸ªï¼›å¼•ç”¨ç±»å‹åˆ™éœ€è¦æ˜¾å¼å£°æ˜ memory æˆ– calldataï¼Œ**è€ŒçŠ¶æ€å˜é‡éƒ½ä¿å­˜åœ¨ storage ä¸­**ï¼Œå¯¹åº”é“¾ä¸Šæ°¸ä¹…å­˜å‚¨ã€‚åˆçº¦æ‰§è¡ŒæœŸé—´ memory æ˜¯å¯å˜ä¸´æ—¶å­˜å‚¨ï¼Œcalldata æ˜¯å¤–éƒ¨åªè¯»è¾“å…¥ï¼Œç†è§£è¿™äº›ä½ç½®ä¸ä»…æœ‰åŠ©äºæ€§èƒ½ä¼˜åŒ–ï¼Œä¹Ÿèƒ½è§„é¿å¦‚ stack too deepã€storage collision ç­‰å¸¸è§é—®é¢˜ã€‚


1ã€**boolean**

2ã€**unit**

> æ­£æ•°ï¼Œè·Ÿc++çš„ç±»ä¼¼ã€‚è¿™ä¸ªæ¯”è¾ƒç‰¹æ®Šï¼Œå½“å®šä¹‰å˜é‡çš„æ—¶å€™å¯ä»¥ä½¿ç”¨`unit8`-`unit256`å…¶ä¸­çš„æ•°ï¼Œå•ä½æ˜¯8ï¼ˆä¸€ä¸ªå­—èŠ‚8æ¯”ç‰¹ï¼‰ï¼Œé»˜è®¤æ˜¯256.
>
> `uint256 favoriteNumber = 5;`

3ã€**int**

> è·Ÿunitçš„ç‰¹æ®Šç›¸åŒï¼Œå¯ä»¥ä½¿ç”¨`int256`å®šä¹‰å˜é‡ã€‚
>
> `int256 favoriteNumber = -5;`

4ã€**address**

> åœ°å€
>
> åœ°å€ç±»å‹æœ‰ä¸¤ç§åŸºæœ¬ç›¸åŒçš„ç±»å‹ï¼š
>
> - `address`: ä¿å­˜ä¸€ä¸ª20å­—èŠ‚çš„å€¼ï¼ˆä¸€ä¸ªä»¥å¤ªåŠåœ°å€çš„å¤§å°ï¼‰ã€‚
> - `address payable`: ä¸ `address` ç±»å‹ç›¸åŒï¼Œä½†æœ‰é¢å¤–çš„æ–¹æ³• `transfer` å’Œ `send`ã€‚
>
> è¿™ç§åŒºåˆ«èƒŒåçš„æƒ³æ³•æ˜¯ï¼Œ `address payable` æ˜¯ä¸€ä¸ªæ‚¨å¯ä»¥å‘é€ä»¥å¤ªå¸çš„åœ°å€ï¼Œ è€Œæ‚¨ä¸åº”è¯¥å‘é€ä»¥å¤ªå¸ç»™ä¸€ä¸ªæ™®é€šçš„ `address`ï¼Œä¾‹å¦‚ï¼Œå› ä¸ºå®ƒå¯èƒ½æ˜¯ä¸€ä¸ªæ™ºèƒ½åˆçº¦ï¼Œ è€Œè¿™ä¸ªåˆçº¦ä¸æ˜¯ä¸ºæ¥å—ä»¥å¤ªå¸è€Œå»ºç«‹çš„ã€‚
>
> ç±»å‹è½¬æ¢ï¼š
>
> å…è®¸ä» `address payable` åˆ° `address` çš„éšå¼è½¬æ¢ï¼Œ è€Œä» `address` åˆ° `address payable` çš„è½¬æ¢å¿…é¡»é€šè¿‡ `payable(<address>)` æ¥æ˜ç¡®ã€‚
>
> `address myAddress = 0x1066618d189731Fe13897cC1;`

5ã€**bytes**

> å­—èŠ‚æ•°ç»„`bytes`åˆ†ä¸¤ç§ï¼Œä¸€ç§å®šé•¿ï¼ˆ`byte`, `bytes8`, `bytes32`ï¼‰ï¼Œå¦ä¸€ç§ä¸å®šé•¿ã€‚å®šé•¿çš„å±äºæ•°å€¼ç±»å‹ï¼Œä¸å®šé•¿çš„æ˜¯å¼•ç”¨ç±»å‹ã€‚ å®šé•¿`bytes`å¯ä»¥å­˜ä¸€äº›æ•°æ®ï¼Œæ¶ˆè€—`gas`æ¯”è¾ƒå°‘ã€‚
>
> åŒuintç‰¹æ®Šã€‚
>
> `bytes32 public _byte32 = "MiniSolidity"; `
>
> `bytes1 public _byte = _byte32[0]; `
>
> `MiniSolidity`å˜é‡ä»¥å­—èŠ‚çš„æ–¹å¼å­˜å‚¨è¿›å˜é‡`_byte32`ï¼Œè½¬æ¢æˆ16è¿›åˆ¶ä¸ºï¼š`0x4d696e69536f6c69646974790000000000000000000000000000000000000000`
> `_byte`å˜é‡å­˜å‚¨`_byte32`çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œä¸º`0x4d`

6ã€**stirng**

>`string favoriteNumberIntext = "five";`

7ã€**struct**

> ç»“æ„ä½“
>
> ```solidity
>  People public people = People({favoriteNumber: 2, name: "congmu"});
> 
>  struct People {
>      uint256 favoriteNumber;
>      string name;
>  }
> ```
>
> ç»“æ„ä½“å±æ€§çš„å®šä¹‰ä¸çŠ¶æ€å˜é‡çš„å®šä¹‰ç›¸åŒï¼Œåªæ˜¯æ²¡æœ‰ä½œç”¨åŸŸè¿™ä¸ªæ¦‚å¿µã€‚

8ã€**æ•°ç»„ç±»å‹**

> ```solidity
> People[] public people;
>  //æ·»åŠ æ•°ç»„å…ƒç´ 
>  function addPeople(string memory _name, uint256 _favoriteNumber) public {
>      People memory newPeople = People({favoriteNumber: _favoriteNumber, name: _name});
>      people.push(newPeople);
>  }
> ```
>
> è¿™é‡Œå¦‚æœæƒ³è¦å®šä¹‰ï¼Œæœ‰ä¸¤ç§å®šä¹‰ï¼š
>
> 1ã€å›ºå®šé•¿åº¦`uint[10]`ï¼šåœ¨å£°æ˜æ—¶æŒ‡å®šæ•°ç»„çš„é•¿åº¦
>
> 2ã€åŠ¨æ€æ•°ç»„`address[]`ï¼šåœ¨å£°æ˜æ—¶ä¸æŒ‡å®šæ•°ç»„çš„é•¿åº¦
>
> `bytes`æ¯”è¾ƒç‰¹æ®Šï¼Œæ˜¯æ•°ç»„ï¼Œä½†æ˜¯ä¸ç”¨åŠ `[]`ã€‚å¦å¤–ï¼Œä¸èƒ½ç”¨`byte[]`å£°æ˜å•å­—èŠ‚æ•°ç»„ï¼Œå¯ä»¥ä½¿ç”¨`bytes`æˆ–`bytes1[]`ã€‚åœ¨gasä¸Šï¼Œ`bytes`æ¯”`bytes1[]`ä¾¿å®œã€‚å› ä¸º`bytes1[]`åœ¨`memory`ä¸­è¦å¢åŠ 31ä¸ªå­—èŠ‚è¿›è¡Œå¡«å……ï¼Œä¼šäº§ç”Ÿé¢å¤–çš„gasã€‚ä½†æ˜¯åœ¨`storage`ä¸­ï¼Œç”±äºå†…å­˜ç´§å¯†æ‰“åŒ…ï¼Œä¸å­˜åœ¨å­—èŠ‚å¡«å……ã€‚

9ã€**æ˜ å°„mapping**

> ```solidity
>  mapping(string => uint256) public nameToFavoriteNumber;
>      //æ·»åŠ æ•°ç»„å…ƒç´ 
>  function addPeople(string memory _name, uint256 _favoriteNumber) public {
>      nameToFavoriteNumber[_name ] = _favoriteNumber;
>  }
> ```
>
> - **è§„åˆ™1**ï¼šæ˜ å°„çš„`_Key`åªèƒ½é€‰æ‹©`solidity`é»˜è®¤çš„ç±»å‹ï¼Œæ¯”å¦‚`uint`ï¼Œ`address`ç­‰ï¼Œä¸èƒ½ç”¨è‡ªå®šä¹‰çš„ç»“æ„ä½“ã€‚è€Œ`_Value`å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„ç±»å‹ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­ä¼šæŠ¥é”™ï¼Œå› ä¸º`_Keyä½¿ç”¨äº†æˆ‘ä»¬è‡ªå®šä¹‰çš„ç»“æ„ä½“ï¼š
> - **è§„åˆ™2**ï¼šæ˜ å°„é€šå¸¸ç”¨äºå­˜å‚¨å¤§é‡çš„é”®å€¼å¯¹æ•°æ®ï¼Œæ˜ å°„çš„å­˜å‚¨ä½ç½®å¿…é¡»æ˜¯`storage`ï¼Œå› æ­¤å¯ä»¥ç”¨äºåˆçº¦çš„çŠ¶æ€å˜é‡ï¼Œå‡½æ•°ä¸­çš„`storage`å˜é‡ï¼Œå’Œlibraryå‡½æ•°çš„å‚æ•°ã€‚ä¸èƒ½ç”¨äº`public`å‡½æ•°çš„å‚æ•°æˆ–è¿”å›ç»“æœä¸­ï¼Œå› ä¸º`mapping`è®°å½•çš„æ˜¯ä¸€ç§å…³ç³» (key - value pair)ã€‚
> - **è§„åˆ™3**ï¼šå¦‚æœæ˜ å°„å£°æ˜ä¸º`public`ï¼Œé‚£ä¹ˆ`solidity`ä¼šè‡ªåŠ¨ç»™ä½ åˆ›å»ºä¸€ä¸ª`getter`å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡`Key`æ¥æŸ¥è¯¢å¯¹åº”çš„`Value`ã€‚
> - **è§„åˆ™4**ï¼šç»™æ˜ å°„æ–°å¢çš„é”®å€¼å¯¹çš„è¯­æ³•ä¸º`_Var[_Key] = _Value`ï¼Œå…¶ä¸­`_Var`æ˜¯æ˜ å°„å˜é‡åï¼Œ`_Key`å’Œ`_Value`å¯¹åº”æ–°å¢çš„é”®å€¼å¯¹ã€‚ä¾‹å­

**10ã€æšä¸¾ enum**

> æšä¸¾ï¼ˆ`enum`ï¼‰æ˜¯`solidity`ä¸­ç”¨æˆ·å®šä¹‰çš„æ•°æ®ç±»å‹ã€‚å®ƒä¸»è¦ç”¨äºä¸º`uint`åˆ†é…åç§°ï¼Œä½¿ç¨‹åºæ˜“äºé˜…è¯»å’Œç»´æŠ¤ã€‚å®ƒä¸`Cè¯­è¨€`ä¸­çš„`enum`ç±»ä¼¼ï¼Œä½¿ç”¨åç§°æ¥ä»£æ›¿ä»`0`å¼€å§‹çš„`uint`ï¼š
>
> ```solidity
>     // ç”¨enumå°†uint 0ï¼Œ 1ï¼Œ 2è¡¨ç¤ºä¸ºBuy, Hold, Sell
>     enum ActionSet { Buy, Hold, Sell }
>     // åˆ›å»ºenumå˜é‡ action
>     ActionSet action = ActionSet.Buy;
> ```
>
> 
>
> å®ƒå¯ä»¥æ˜¾å¼çš„å’Œ`uint`ç›¸äº’è½¬æ¢ï¼Œå¹¶ä¼šæ£€æŸ¥è½¬æ¢çš„æ­£æ•´æ•°æ˜¯å¦åœ¨æšä¸¾çš„é•¿åº¦å†…ï¼Œä¸ç„¶ä¼šæŠ¥é”™ï¼š
>
> ```solidity
>     // enumå¯ä»¥å’Œuintæ˜¾å¼çš„è½¬æ¢
>     function enumToUint() external view returns(uint){
>         return uint(action);
>     }
> ```
>
> 
>
> `enum`æ˜¯ä¸€ä¸ªæ¯”è¾ƒå†·é—¨çš„å˜é‡ï¼Œå‡ ä¹æ²¡ä»€ä¹ˆäººç”¨ã€‚

### 1.1.2 Solidityä¸­çš„å¼•ç”¨ç±»å‹

**å¼•ç”¨ç±»å‹(Reference Type)**ï¼šåŒ…æ‹¬æ•°ç»„ï¼ˆ`array`ï¼‰ï¼Œç»“æ„ä½“ï¼ˆ`struct`ï¼‰å’Œæ˜ å°„ï¼ˆ`mapping`ï¼‰ï¼Œè¿™ç±»å˜é‡å ç©ºé—´å¤§ï¼Œèµ‹å€¼æ—¶å€™ç›´æ¥ä¼ é€’åœ°å€ï¼ˆç±»ä¼¼æŒ‡é’ˆï¼‰ã€‚ç”±äºè¿™ç±»å˜é‡æ¯”è¾ƒå¤æ‚ï¼Œå ç”¨å­˜å‚¨ç©ºé—´å¤§ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨æ—¶å¿…é¡»è¦å£°æ˜æ•°æ®å­˜å‚¨çš„ä½ç½®ã€‚

### 1.1.3 å˜é‡çš„åˆå§‹å€¼

- `boolean`: `false`

- `string`: `""`

- `int`: `0`

- `uint`: `0`

- `enum`: æšä¸¾ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ 

- `address`: `0x0000000000000000000000000000000000000000` (æˆ– `address(0)`)

- ```
  function
  ```

  - `internal`: ç©ºç™½æ–¹ç¨‹
  - `external`: ç©ºç™½æ–¹ç¨‹

**`delete`æ“ä½œç¬¦ï¼š**

`delete a`ä¼šè®©å˜é‡`a`çš„å€¼å˜ä¸ºåˆå§‹å€¼ã€‚



### 1.1.4 å¸¸é‡

`constant`ï¼ˆå¸¸é‡ï¼‰å’Œ`immutable`ï¼ˆä¸å˜é‡ï¼‰

> çŠ¶æ€å˜é‡å£°æ˜è¿™ä¸ªä¸¤ä¸ªå…³é”®å­—ä¹‹åï¼Œä¸èƒ½åœ¨åˆçº¦åæ›´æ”¹æ•°å€¼ï¼›å¹¶ä¸”è¿˜å¯ä»¥èŠ‚çœ`gas`ã€‚å¦å¤–ï¼Œåªæœ‰æ•°å€¼å˜é‡å¯ä»¥å£°æ˜`constant`å’Œ`immutable`ï¼›`string`å’Œ`bytes`å¯ä»¥å£°æ˜ä¸º`constant`ï¼Œä½†ä¸èƒ½ä¸º`immutable`ã€‚

`constant`å˜é‡å¿…é¡»åœ¨å£°æ˜çš„æ—¶å€™åˆå§‹åŒ–ï¼Œä¹‹åå†ä¹Ÿä¸èƒ½æ”¹å˜ã€‚å°è¯•æ”¹å˜çš„è¯ï¼Œç¼–è¯‘ä¸é€šè¿‡ã€‚

`immutable`å˜é‡å¯ä»¥åœ¨å£°æ˜æ—¶æˆ–æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œå› æ­¤æ›´åŠ çµæ´»ã€‚





## 1.2 æ•°æ®å­˜å‚¨çš„ä½ç½®

### 1.2.1 å­˜å‚¨ä½ç½®

1ã€**Stack**

> ä¸èƒ½è¢«ä¿®æ”¹çš„ä¸´æ—¶å˜é‡

2ã€**Memory**

> å¯ä»¥è¢«ä¿®æ”¹çš„ä¸´æ—¶å˜é‡ï¼Œæ•°æ®åœ¨å‡½æ•°è°ƒç”¨ç»“æŸåä¼šè¢«æ¸…é™¤ã€‚
>
> å¤§æ¦‚æ˜¯3

3ã€**Storage**

> å¯ä»¥è¢«ä¿®æ”¹çš„æ°¸ä¹…å˜é‡ï¼Œæ•°æ®åœ¨åˆçº¦çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜ï¼Œé™¤éæ˜¾å¼ä¿®æ”¹ã€‚çŠ¶æ€å˜é‡é»˜è®¤å­˜å‚¨åœ¨ `storage` ä¸­ã€‚
>
> å­˜å‚¨åœ¨`storage`ä¸­çš„æ•°æ®æ˜¯æ°¸ä¹…æ€§çš„ï¼Œåªè¦æ™ºèƒ½åˆçº¦å­˜åœ¨ï¼Œè¿™äº›æ•°æ®å°±ä¼šä¸€ç›´ä¿å­˜åœ¨åŒºå—é“¾ä¸Šã€‚å³ä½¿æ™ºèƒ½åˆçº¦çš„å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œç”šè‡³æ˜¯åˆçº¦æš‚åœæˆ–é”€æ¯ï¼ˆå¦‚æœæœ‰è‡ªæˆ‘é”€æ¯æœºåˆ¶çš„è¯ï¼‰ï¼Œå­˜å‚¨åœ¨`storage`ä¸­çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œé™¤éé€šè¿‡åˆçº¦ä»£ç æ˜ç¡®åœ°ä¿®æ”¹æˆ–åˆ é™¤
>
> **åˆçº¦å†…çš„è¯»å†™éƒ½éœ€è¦æ¶ˆè€—gaså¤§æ¦‚æ˜¯100**è¯¦æƒ…è¯·çœ‹[EVM Codes](https://www.evm.codes/)
>
> å¦‚`uint public value;`

4ã€**Calldata**

> ä¸èƒ½è¢«ä¿®æ”¹çš„ä¸´æ—¶æ•°æ®ã€‚
>
> **ä½œç”¨**: å‡½æ•°å‚æ•°çš„åªè¯»å­˜å‚¨ä½ç½®ï¼Œç‰¹åˆ«æ˜¯å¯¹äº `external` å‡½æ•°ã€‚
>
> **ç”¨é€”**: ä¼ é€’å‡½æ•°è°ƒç”¨ä¸­çš„å‚æ•°æ•°æ®ï¼Œç‰¹åˆ«é€‚ç”¨äºä¼ é€’è¾ƒå¤§çš„æ•°ç»„æˆ–å­—ç¬¦ä¸²ã€‚

7ã€**Logs**

> **ç»“æ„ä½“**ã€**æ˜ å°„**å’Œ**æ•°ç»„**åœ¨ä½œä¸ºå‚æ•°è¢«æ·»åŠ åˆ°ä¸åŒå‡½æ•°æ—¶éœ€è¦ç»™å®šä¸€ä¸ª`memory`æˆ–`calldata`å…³é”®å­—



solidityæ•°æ®å­˜å‚¨ä½ç½®æœ‰ä¸‰ç±»ï¼š`storage`ï¼Œ`memory`å’Œ`calldata`ã€‚ä¸åŒå­˜å‚¨ä½ç½®çš„`gas`æˆæœ¬ä¸åŒã€‚`storage`ç±»å‹çš„æ•°æ®å­˜åœ¨é“¾ä¸Šï¼Œç±»ä¼¼è®¡ç®—æœºçš„ç¡¬ç›˜ï¼Œæ¶ˆè€—`gas`å¤šï¼›`memory`å’Œ`calldata`ç±»å‹çš„ä¸´æ—¶å­˜åœ¨å†…å­˜é‡Œï¼Œæ¶ˆè€—`gas`å°‘ã€‚å¤§è‡´ç”¨æ³•ï¼š

1. `storage`ï¼šåˆçº¦é‡Œçš„**çŠ¶æ€å˜é‡é»˜è®¤éƒ½æ˜¯**`storage`ï¼Œå­˜å‚¨åœ¨é“¾ä¸Šã€‚
2. `memory`ï¼šå‡½æ•°é‡Œçš„å‚æ•°å’Œä¸´æ—¶å˜é‡ä¸€èˆ¬ç”¨`memory`ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä¸ä¸Šé“¾ã€‚
3. `calldata`ï¼šå’Œ`memory`ç±»ä¼¼ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä¸ä¸Šé“¾ã€‚ä¸`memory`çš„ä¸åŒç‚¹åœ¨äº`calldata`å˜é‡ä¸èƒ½ä¿®æ”¹ï¼ˆ`immutable`ï¼‰ï¼Œä¸€èˆ¬ç”¨äºå‡½æ•°çš„å‚æ•°ã€‚ä¾‹å­ï¼š

```solidity
    function fCalldata(uint[] calldata _x) public pure returns(uint[] calldata){
        //å‚æ•°ä¸ºcalldataæ•°ç»„ï¼Œä¸èƒ½è¢«ä¿®æ”¹
        // _x[0] = 0 //è¿™æ ·ä¿®æ”¹ä¼šæŠ¥é”™
        return(_x);
    }
```





### 1.2.2 èµ‹å€¼è§„åˆ™(èµ‹å€¼æ˜¯å¦å¼•ç”¨)

1. `storage`ï¼ˆåˆçº¦çš„çŠ¶æ€å˜é‡ï¼‰èµ‹å€¼ç»™æœ¬åœ°`storage`ï¼ˆå‡½æ•°é‡Œçš„ï¼‰æ—¶å€™ï¼Œä¼šåˆ›å»ºå¼•ç”¨ï¼Œæ”¹å˜æ–°å˜é‡ä¼šå½±å“åŸå˜é‡ã€‚ä¾‹å­ï¼š

   ```solidity
       uint[] x = [1,2,3]; // çŠ¶æ€å˜é‡ï¼šæ•°ç»„ x
   
       function fStorage() public{
           //å£°æ˜ä¸€ä¸ªstorageçš„å˜é‡ xStorageï¼ŒæŒ‡å‘xã€‚ä¿®æ”¹xStorageä¹Ÿä¼šå½±å“x
           uint[] storage xStorage = x;
           xStorage[0] = 100;
       }
   ```

2. `storage`èµ‹å€¼ç»™`memory`ï¼Œä¼šåˆ›å»ºç‹¬ç«‹çš„å‰¯æœ¬ï¼Œä¿®æ”¹å…¶ä¸­ä¸€ä¸ªä¸ä¼šå½±å“å¦ä¸€ä¸ªï¼›åä¹‹äº¦ç„¶ã€‚ä¾‹å­ï¼š

   ```solidity
       uint[] x = [1,2,3]; // çŠ¶æ€å˜é‡ï¼šæ•°ç»„ x
       
       function fMemory() public view{
           //å£°æ˜ä¸€ä¸ªMemoryçš„å˜é‡xMemoryï¼Œå¤åˆ¶xã€‚ä¿®æ”¹xMemoryä¸ä¼šå½±å“x
           uint[] memory xMemory = x;
           xMemory[0] = 100;
           xMemory[1] = 200;
           uint[] memory xMemory2 = x;
           xMemory2[0] = 300;
       }
   ```

3. `memory`èµ‹å€¼ç»™`memory`ï¼Œä¼šåˆ›å»ºå¼•ç”¨ï¼Œæ”¹å˜æ–°å˜é‡ä¼šå½±å“åŸå˜é‡ã€‚
4. å…¶ä»–æƒ…å†µï¼Œå˜é‡èµ‹å€¼ç»™`storage`ï¼Œä¼šåˆ›å»ºç‹¬ç«‹çš„å‰¯æœ¬ï¼Œä¿®æ”¹å…¶ä¸­ä¸€ä¸ªä¸ä¼šå½±å“å¦ä¸€ä¸ªã€‚



## 1.3 é»˜è®¤ç±»å‹å’Œå­˜å‚¨ä½ç½®

### 1.3.1 å˜é‡çš„é»˜è®¤ç±»å‹å’Œå­˜å‚¨ä½ç½®

#### 1.3.1.1 çŠ¶æ€å˜é‡

- **é»˜è®¤å­˜å‚¨ä½ç½®**: çŠ¶æ€å˜é‡é»˜è®¤å­˜å‚¨åœ¨ `storage` ä¸­ã€‚
- **é»˜è®¤å¯è§æ€§**: å¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šå¯è§æ€§ä¿®é¥°ç¬¦ï¼ˆå¦‚ `public`ã€`internal`ã€`private`ï¼‰ï¼ŒçŠ¶æ€å˜é‡çš„é»˜è®¤å¯è§æ€§æ˜¯ `internal`ã€‚

#### 1.3.1.2 å±€éƒ¨å˜é‡

- **é»˜è®¤å­˜å‚¨ä½ç½®**: å±€éƒ¨å˜é‡é»˜è®¤å­˜å‚¨åœ¨ `memory` ä¸­ã€‚å±€éƒ¨å˜é‡æ˜¯å‡½æ•°å†…éƒ¨å£°æ˜çš„å˜é‡ã€‚
- **é»˜è®¤å¯è§æ€§**: å±€éƒ¨å˜é‡ä¸æ¶‰åŠå¯è§æ€§ä¿®é¥°ç¬¦ï¼Œå› ä¸ºå®ƒä»¬åªèƒ½åœ¨å£°æ˜å®ƒä»¬çš„å‡½æ•°å†…éƒ¨è®¿é—®ã€‚

### 1.3.2 å‡½æ•°çš„é»˜è®¤å¯è§æ€§å’Œä¿®é¥°ç¬¦

- **é»˜è®¤å¯è§æ€§**: å¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šå¯è§æ€§ä¿®é¥°ç¬¦ï¼ˆå¦‚ `public`ã€`internal`ã€`private`ã€`external`ï¼‰ï¼Œå‡½æ•°çš„é»˜è®¤å¯è§æ€§æ˜¯ `internal`ã€‚
- **é»˜è®¤çŠ¶æ€ä¿®é¥°ç¬¦**: å¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šçŠ¶æ€ä¿®é¥°ç¬¦ï¼ˆå¦‚ `view`ã€`pure`ã€`payable`ï¼‰ï¼Œå‡½æ•°é»˜è®¤æ—¢ä¸æ˜¯ `view` ä¹Ÿä¸æ˜¯ `pure` æˆ– `payable`ã€‚å®ƒå¯ä»¥è¯»å–å’Œä¿®æ”¹çŠ¶æ€å˜é‡ï¼Œä¹Ÿä¸èƒ½æ¥æ”¶ä»¥å¤ªå¸ã€‚





## 1.4 æ‰§è¡Œä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸ




### 1.4.1 åˆçº¦è¢«è°ƒç”¨æˆ–äº¤æ˜“è¢«å‘é€

å½“ä¸€ä¸ªåˆçº¦è¢«å¤–éƒ¨è°ƒç”¨ï¼ˆä¾‹å¦‚é€šè¿‡äº¤æ˜“æˆ–æ¶ˆæ¯è°ƒç”¨ï¼‰æ—¶ï¼Œæˆ–è€…ä¸€ä¸ªäº¤æ˜“è¢«å‘é€åˆ°åŒºå—é“¾ç½‘ç»œï¼Œå¼€å§‹æ‰§è¡Œè¯¥äº¤æ˜“ä¸­çš„åˆçº¦ä»£ç æ—¶ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡å¼€å§‹åˆå§‹åŒ–ã€‚

### 1.4.2 åˆå§‹åŒ–é˜¶æ®µ

åœ¨åˆå§‹åŒ–é˜¶æ®µï¼ŒSolidity è¿è¡Œæ—¶ä¼šè®¾ç½®æ‰§è¡Œç¯å¢ƒï¼ŒåŒ…æ‹¬ï¼š

- **gas å’Œ gasprice**: æŒ‡å®šäº¤æ˜“å¯ä½¿ç”¨çš„ gas æ•°é‡å’Œ gas çš„ä»·æ ¼ã€‚
- **msg å¯¹è±¡**: æä¾›å…³äºå½“å‰äº¤æ˜“æˆ–æ¶ˆæ¯çš„ä¿¡æ¯ï¼Œå¦‚å‘é€è€…åœ°å€ `msg.sender`ã€å‘é€çš„ ETH æ•°é‡ `msg.value` ç­‰ã€‚
- **block å¯¹è±¡**: æä¾›å…³äºå½“å‰åŒºå—çš„ä¿¡æ¯ï¼Œå¦‚åŒºå—çš„å“ˆå¸Œå€¼ `blockhash(block.number)`ã€åŒºå—çš„æ—¶é—´æˆ³ `block.timestamp` ç­‰ã€‚

### 1.4.3 å‡½æ•°è°ƒç”¨

å½“æ‰§è¡Œåˆ°åˆçº¦ä¸­çš„å‡½æ•°è°ƒç”¨æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecution Contextï¼‰ï¼Œå¹¶ä¸”åœ¨è°ƒç”¨å †æ ˆä¸­æ¨å…¥ä¸€ä¸ªæ–°çš„å¸§ï¼ˆframeï¼‰ã€‚è¿™ä¸ªå¸§åŒ…å«äº†å‡½æ•°è°ƒç”¨çš„å‚æ•°ã€å±€éƒ¨å˜é‡ã€è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚

### 1.4.4 æ‰§è¡Œå‡½æ•°ä½“

åœ¨å‡½æ•°æ‰§è¡ŒæœŸé—´ï¼ŒSolidity å¼•æ“ä¼šæŒ‰ç…§å‡½æ•°çš„é€»è¾‘æ‰§è¡Œä»£ç ã€‚åœ¨å‡½æ•°å†…éƒ¨å¯ä»¥è®¿é—®åˆ°ï¼š

- **çŠ¶æ€å˜é‡**ï¼šå­˜å‚¨åœ¨åˆçº¦å­˜å‚¨ä¸­çš„æ•°æ®ã€‚
- **å±€éƒ¨å˜é‡**ï¼šåœ¨å‡½æ•°è°ƒç”¨æœŸé—´å¯ç”¨çš„ä¸´æ—¶å˜é‡ï¼Œé€šå¸¸å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚
- **å‡½æ•°å‚æ•°**ï¼šè°ƒç”¨å‡½æ•°æ—¶ä¼ å…¥çš„å‚æ•°å€¼ã€‚

### 1.4.5 gas å’Œ gas æ¶ˆè€—

åœ¨æ‰§è¡Œå‡½æ•°ä½“çš„è¿‡ç¨‹ä¸­ï¼Œä¼šæ¶ˆè€— gasã€‚æ¯ä¸ªæ“ä½œï¼ˆå¦‚ç®—æœ¯è¿ç®—ã€å­˜å‚¨è¯»å†™ã€äº‹ä»¶è§¦å‘ç­‰ï¼‰éƒ½æœ‰å¯¹åº”çš„ gas æˆæœ¬ã€‚å¦‚æœ gas ç”¨å°½æˆ–è€…é‡åˆ°å¼‚å¸¸ï¼Œæ‰§è¡Œä¼šä¸­æ–­ï¼Œå¹¶ä¸”å·²æ¶ˆè€—çš„ gas ä¸ä¼šé€€è¿˜ã€‚

### 1.4.6 å®Œæˆå‡½æ•°è°ƒç”¨

å½“å‡½æ•°æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œä¼šä»è°ƒç”¨å †æ ˆä¸­å¼¹å‡ºå½“å‰çš„æ‰§è¡Œå¸§ï¼Œè¿”å›åˆ°ä¸Šä¸€ä¸ªè°ƒç”¨å¸§ä¸­ç»§ç»­æ‰§è¡Œã€‚å¦‚æœå‡½æ•°æœ‰è¿”å›å€¼ï¼Œå®ƒå°†è¢«å­˜å‚¨åœ¨è°ƒç”¨å¸§ä¸­ï¼Œå¹¶ä¸”å¯ä»¥è¢«ä¸Šå±‚è°ƒç”¨å‡½æ•°è®¿é—®ã€‚

### 1.4.7 äº‹ä»¶è®°å½•

å¦‚æœåœ¨å‡½æ•°æ‰§è¡ŒæœŸé—´è§¦å‘äº†äº‹ä»¶ï¼ˆä½¿ç”¨ `emit` å…³é”®å­—è§¦å‘ï¼‰ï¼Œäº‹ä»¶æ•°æ®å°†è¢«è®°å½•åœ¨äº¤æ˜“æ—¥å¿—ä¸­ï¼Œå¯ä»¥è¢«åŒºå—é“¾æµè§ˆå™¨æˆ–å…¶ä»–å·¥å…·æŸ¥çœ‹ã€‚

### 1.4.8 å®Œæˆäº¤æ˜“æˆ–è°ƒç”¨

å½“äº¤æ˜“æˆ–æ¶ˆæ¯è°ƒç”¨å®Œæˆæ‰€æœ‰çš„å‡½æ•°è°ƒç”¨å¹¶æ‰§è¡Œå®Œæ‰€æœ‰çš„æ“ä½œåï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡ä¼šè¢«é”€æ¯ã€‚è¿™åŒ…æ‹¬å¯¹ gas çš„æœ€ç»ˆç»“ç®—ã€çŠ¶æ€å˜æ›´çš„æœ€ç»ˆç¡®è®¤ï¼ˆå¦‚æœæœ‰ï¼‰ç­‰æ“ä½œã€‚

### 1.4.9 æ€»ç»“

æ‰§è¡Œä¸Šä¸‹æ–‡çš„ç”Ÿå‘½å‘¨æœŸæ¶µç›–äº†ä»åˆçº¦è¢«è°ƒç”¨åˆ°æ‰§è¡Œå®Œæ¯•çš„æ•´ä¸ªè¿‡ç¨‹ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–ã€å‡½æ•°è°ƒç”¨ã€gas æ¶ˆè€—ã€äº‹ä»¶è®°å½•å’Œæœ€ç»ˆç»“ç®—ç­‰é˜¶æ®µã€‚ç†è§£è¿™äº›é˜¶æ®µå¯¹äºç¼–å†™å’Œç†è§£ Solidity åˆçº¦éå¸¸é‡è¦ï¼Œå°¤å…¶æ˜¯åœ¨ä¼˜åŒ– gas ä½¿ç”¨å’Œç¡®ä¿åˆçº¦è¡Œä¸ºæ­£ç¡®æ€§æ–¹é¢ã€‚



## 1.5 å‘½å style guide

[Style Guide â€” Solidity 0.8.28 documentation (soliditylang.org)](https://docs.soliditylang.org/en/latest/style-guide.html)

[Make a doc that has the solidity style guide + the Chainlink style guide Â· Issue #13 Â· smartcontractkit/full-blockchain-solidity-course-js (github.com)](https://github.com/smartcontractkit/full-blockchain-solidity-course-js/issues/13)



[9.2 Solidit çš„å¸ƒå±€i](https://www.bilibili.com/video/BV13a4y1F7V3/?p=109)

### Order of Layout



- **Contract elements should be laid out in the following order:**
  Pragma statements
  Import statements
  Events
  Errors
  Interfaces
  Libraries
  Contracts
- **Inside each contract, library or interface, use the following order:**
  - Type declarations
  - State variables
  - Events
  - Errors
  - Modifiers
  - Functions
- **Functions should be grouped according to their visibility and ordered:**
  constructor
  receive function (if exists)
  fallback function (if exists)
  external
  public
  internal
  private







# 2 æå‡

## 2.1 å‡½æ•°åŸºç¡€

åŸºäºè¿™ä¸ªä¾‹å­è¿›è¡Œè®²è§£ï¼š

```solidity
function <function name>(<parameter types>) {internal|external|public|private} [pure|view|payable] [returns (<return types>)]
```

```solidity
function test() public pure returns (unint256) {

}
```



1. `function`ï¼šå£°æ˜å‡½æ•°æ—¶çš„å›ºå®šç”¨æ³•ï¼Œæƒ³å†™å‡½æ•°ï¼Œå°±è¦ä»¥functionå…³é”®å­—å¼€å¤´ã€‚
2. `<function name>`ï¼šå‡½æ•°åã€‚
3. `(<parameter types>)`ï¼šåœ†æ‹¬å·é‡Œå†™å‡½æ•°çš„å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¦è¾“å…¥åˆ°å‡½æ•°çš„å˜é‡ç±»å‹å’Œåå­—ã€‚
4. `[returns ()]`ï¼šå‡½æ•°è¿”å›çš„å˜é‡ç±»å‹å’Œåç§°ã€‚

### 2.1.1 å¯è§æ€§ï¼ˆæƒé™ï¼‰

`{internal|external|public|private}`ï¼šå‡½æ•°å¯è§æ€§è¯´æ˜ç¬¦ï¼Œä¸€å…±4ç§ã€‚æ²¡æ ‡æ˜å‡½æ•°ç±»å‹çš„ï¼Œé»˜è®¤`public`ã€‚åˆçº¦ä¹‹å¤–çš„å‡½æ•°ï¼Œå³"è‡ªç”±å‡½æ•°"ï¼Œå§‹ç»ˆå…·æœ‰éšå«`internal`å¯è§æ€§ã€‚

- **public**ï¼šåªæœ‰ public ç±»å‹çš„å‡½æ•°æ‰å¯ä»¥ä¾›å¤–éƒ¨è®¿é—®ï¼Œå½“ä¸€ä¸ªçŠ¶æ€å˜é‡çš„æƒé™ä¸º public ç±»å‹æ—¶ï¼Œå®ƒå°±ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå¯ä¾›å¤–éƒ¨è°ƒç”¨çš„ get å‡½æ•°ã€‚
- **private**ï¼šåªèƒ½åœ¨å½“å‰ç±»ä¸­è¿›è¡Œè®¿é—®ï¼Œå­ç±»æ— æ³•ç»§æ‰¿ï¼Œä¹Ÿæ— æ³•è°ƒç”¨æˆ–è®¿é—®ã€‚
- **internal**ï¼šå­ç±»ç»§æ‰¿çˆ¶ç±»ï¼Œå­ç±»å¯ä»¥è®¿é—®çˆ¶ç±»çš„ internal å‡½æ•°ï¼ŒåŒæ—¶ï¼Œä½¿ç”¨ using for å…³é”®å­—åï¼Œæœ¬ç±»å¯ä»¥ä½¿ç”¨è¢«è°ƒç”¨ç±»çš„ internal å‡½æ•°ã€‚å†…éƒ¨è°ƒç”¨æ—¶éœ€è¦é€šè¿‡ `this`ã€‚
- **external**ï¼šè¢«å£°æ˜çš„å‡½æ•°åªèƒ½åœ¨åˆçº¦å¤–éƒ¨è°ƒç”¨ã€‚

**Note 1**: å½“å‡½æ•°å£°æ˜æ—¶ï¼Œå®ƒé»˜è®¤ä¸ºæ˜¯ public ç±»å‹ï¼Œè€ŒçŠ¶æ€å˜é‡å£°æ˜æ—¶ï¼Œé»˜è®¤ä¸º internal ç±»å‹ã€‚

**Note 2**: `public|private|internal` ä¹Ÿå¯ç”¨äºä¿®é¥°çŠ¶æ€å˜é‡ã€‚ `public`å˜é‡ä¼šè‡ªåŠ¨ç”ŸæˆåŒåçš„`getter`å‡½æ•°ï¼Œç”¨äºæŸ¥è¯¢æ•°å€¼ã€‚



### 2.1.2 ä¿®é¥°ç¬¦ï¼ˆå…³é”®å­—ï¼‰

- `pure` for functionsï¼šä¸å…è®¸ä¿®æ”¹æˆ–è®¿é—®é“¾ä¸ŠçŠ¶æ€ã€‚
- `view` for functionsï¼šèƒ½çœ‹ä½†ä¸å…è®¸ä¿®æ”¹çŠ¶æ€ã€‚
- `payable` for functioinsï¼š æ˜¯ä¸€ä¸ªå…³é”®å­—å’Œä¿®é¥°ç¬¦ï¼Œç”¨äºæŒ‡ç¤ºå‡½æ•°æˆ–åˆçº¦å¯ä»¥æ¥æ”¶ä»¥å¤ªå¸ï¼ˆEtherï¼‰æˆ–å‘é€ä»¥å¤ªå¸ã€‚


- **constant**ï¼šè¢«å£°æ˜ä¸º constant çš„çŠ¶æ€å˜é‡åªèƒ½ä½¿ç”¨é‚£äº›åœ¨ç¼–è¯‘æ—¶æœ‰ç¡®å®šå€¼çš„è¡¨è¾¾å¼æ¥ç»™å®ƒä»¬èµ‹å€¼ã€‚ä»»ä½•é€šè¿‡è®¿é—®å†…å­˜ã€åŒºå—é“¾æ•°æ®ï¼ˆä¾‹å¦‚ nowï¼Œthis.balance æˆ– block.numberï¼‰æˆ–æ‰§è¡Œæ•°æ®ï¼ˆmsg.gasï¼‰æˆ–å¯¹å¤–éƒ¨åˆçº¦çš„è°ƒç”¨æ¥ç»™å®ƒä»¬èµ‹å€¼éƒ½æ˜¯ä¸å…è®¸çš„ã€‚ä¸æ˜¯æ‰€æœ‰ç±»å‹çš„çŠ¶æ€å˜é‡éƒ½æ”¯æŒç”¨ constant æ¥ä¿®é¥°ï¼Œå½“å‰æ”¯æŒçš„ä»…æœ‰å€¼ç±»å‹å’Œå­—ç¬¦ä¸²ã€‚
- **Storage**Â å˜é‡æ˜¯æŒ‡æ°¸ä¹…å­˜å‚¨åœ¨åŒºå—é“¾ä¸­çš„å˜é‡ã€‚
- **Memory**Â å˜é‡åˆ™æ˜¯ä¸´æ—¶çš„ï¼Œå½“å¤–éƒ¨å‡½æ•°å¯¹æŸåˆçº¦è°ƒç”¨å®Œæˆæ—¶ï¼Œå†…å­˜å‹å˜é‡å³è¢«ç§»é™¤ã€‚


> 1ã€**ä»£ç ç¤ºä¾‹**
>
> æˆ‘ä»¬åœ¨åˆçº¦é‡Œå®šä¹‰ä¸€ä¸ªçŠ¶æ€å˜é‡ `number = 5`ã€‚
>
> ```solidity
>     // SPDX-License-Identifier: MIT
>     pragma solidity ^0.8.4;
>     contract FunctionTypes{
>         uint256 public number = 5;
> ```
>
> å®šä¹‰ä¸€ä¸ª`add()`å‡½æ•°ï¼Œæ¯æ¬¡è°ƒç”¨ï¼Œæ¯æ¬¡ç»™`number + 1`ã€‚
>
> ```solidity
>     // é»˜è®¤
>     function add() external{
>         number = number + 1;
>     }
> ```
>
> å¦‚æœ`add()`åŒ…å«äº†`pure`å…³é”®å­—ï¼Œä¾‹å¦‚ `function add() external pure`ï¼Œå°±ä¼šæŠ¥é”™ã€‚å› ä¸º`pure`ï¼ˆçº¯çº¯ç‰›é©¬ï¼‰æ˜¯ä¸é…è¯»å–åˆçº¦é‡Œçš„çŠ¶æ€å˜é‡çš„ï¼Œæ›´ä¸é…æ”¹å†™ã€‚é‚£`pure`å‡½æ•°èƒ½åšäº›ä»€ä¹ˆï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥ç»™å‡½æ•°ä¼ é€’ä¸€ä¸ªå‚æ•° `_number`ï¼Œç„¶åè®©ä»–è¿”å› `_number+1`ã€‚
>
> ```solidity
>     // pure: çº¯çº¯ç‰›é©¬
>     function addPure(uint256 _number) external pure returns(uint256 new_number){
>         new_number = _number + 1;
>     }
> ```
>
> è¿™é‡Œé¢å¯ä»¥åœ¨é¡¹ç›®ä¸­ä½¿ç”¨pureè¿›è¡Œè¿ç®—ï¼Œè¿™æ ·æ˜¯ä¸èŠ±è´¹gasçš„ã€‚
>
> 2ã€**æ³¨æ„**
>
> æ¯”è¾ƒéš¾ç†è§£çš„æ˜¯`pure`å’Œ`view`ï¼Œåœ¨å…¶ä»–è¯­è¨€ä¸­æ²¡å‡ºç°è¿‡ã€‚`solidity`å¼•å…¥`pure`å’Œ`view`å…³é”®å­—ä¸»è¦æ˜¯ä¸ºäº†èŠ‚çœ`gas`å’Œæ§åˆ¶å‡½æ•°æƒé™ï¼šå¦‚æœç”¨æˆ·ç›´æ¥è°ƒç”¨`pure`/`view`æ–¹ç¨‹æ˜¯ä¸æ¶ˆè€—`gas`çš„ï¼ˆåˆçº¦ä¸­é`pure`/`view`å‡½æ•°è°ƒç”¨å®ƒä»¬åˆ™ä¼šæ”¹å†™é“¾ä¸ŠçŠ¶æ€ï¼Œéœ€è¦ä»˜gasï¼‰ã€‚

å®Œæ•´çš„ä¿®æ”¹å™¨ï¼š

- `pure` ä¿®é¥°å‡½æ•°æ—¶ï¼šä¸å…è®¸ä¿®æ”¹æˆ–è®¿é—®çŠ¶æ€ã€‚
- `view` ä¿®é¥°å‡½æ•°æ—¶ï¼šä¸å…è®¸ä¿®æ”¹çŠ¶æ€ã€‚
- `payable` ä¿®é¥°å‡½æ•°æ—¶ï¼šå…è®¸ä»è°ƒç”¨ä¸­æ¥æ”¶ä»¥å¤ªå¸ã€‚
- `constant` ä¿®é¥°çŠ¶æ€å˜é‡æ—¶ï¼šä¸å…è®¸èµ‹å€¼ï¼ˆé™¤åˆå§‹åŒ–ä»¥å¤–ï¼‰ï¼Œä¸ä¼šå æ® å­˜å‚¨æ’æ§½ï¼ˆstorage slotï¼‰ã€‚
- `immutable` ä¿®é¥°çŠ¶æ€å˜é‡æ—¶ï¼šåœ¨æ„é€ æ—¶å…è®¸æœ‰ä¸€ä¸ªç¡®åˆ‡çš„èµ‹å€¼ï¼Œä¹‹åæ˜¯æ’å®šçš„ã€‚è¢«å­˜å‚¨åœ¨ä»£ç ä¸­ã€‚
- `anonymous` ä¿®é¥°äº‹ä»¶æ—¶ï¼šä¸æŠŠäº‹ä»¶ç­¾åä½œä¸º topic å­˜å‚¨ã€‚
- `indexed` ä¿®é¥°äº‹ä»¶å‚æ•°æ—¶ï¼šå°†å‚æ•°ä½œä¸º topic å­˜å‚¨ã€‚
- `virtual` ä¿®é¥°å‡½æ•°å’Œä¿®æ”¹æ—¶ï¼šå…è®¸åœ¨æ´¾ç”Ÿåˆçº¦ä¸­æ”¹å˜å‡½æ•°æˆ–ä¿®æ”¹å™¨çš„è¡Œä¸ºã€‚
- `override` è¡¨ç¤ºè¯¥å‡½æ•°ã€ä¿®æ”¹å™¨æˆ–å…¬å…±çŠ¶æ€å˜é‡æ”¹å˜äº†åŸºç±»åˆçº¦ä¸­çš„å‡½æ•°æˆ–ä¿®æ”¹å™¨çš„è¡Œä¸ºã€‚





### 2.1.3 è¿”å›å€¼

`Solidity`æœ‰ä¸¤ä¸ªå…³é”®å­—ä¸å‡½æ•°è¾“å‡ºç›¸å…³ï¼š`return`å’Œ`returns`ï¼Œä»–ä»¬çš„åŒºåˆ«åœ¨äºï¼š

- `returns`åŠ åœ¨å‡½æ•°ååé¢ï¼Œç”¨äºå£°æ˜è¿”å›çš„å˜é‡ç±»å‹åŠå˜é‡åï¼›
- `return`ç”¨äºå‡½æ•°ä¸»ä½“ä¸­ï¼Œè¿”å›æŒ‡å®šçš„å˜é‡ã€‚



#### 2.1.3.1 å‘½åå¼è¿”å›

æˆ‘ä»¬å¯ä»¥åœ¨`returns`ä¸­æ ‡æ˜è¿”å›å˜é‡çš„åç§°ï¼Œè¿™æ ·`solidity`ä¼šè‡ªåŠ¨ç»™è¿™äº›å˜é‡åˆå§‹åŒ–ï¼Œå¹¶ä¸”è‡ªåŠ¨è¿”å›è¿™äº›å‡½æ•°çš„å€¼ï¼Œä¸éœ€è¦åŠ `return`ã€‚

```solidity
    // å‘½åå¼è¿”å›
    function returnNamed() public pure returns(uint256 _number, bool _bool, uint256[3] memory _array){
        _number = 2;
        _bool = false; 
        _array = [uint256(3),2,1];
    }
```

#### 2.1.3.2 è§£æ„å¼èµ‹å€¼

`solidity`ä½¿ç”¨è§£æ„å¼èµ‹å€¼çš„è§„åˆ™ï¼Œæ”¯æŒè¯»å–å‡½æ•°çš„å…¨éƒ¨æˆ–éƒ¨åˆ†è¿”å›å€¼ã€‚

- è¯»å–æ‰€æœ‰è¿”å›å€¼ï¼šå£°æ˜å˜é‡ï¼Œå¹¶ä¸”å°†è¦èµ‹å€¼çš„å˜é‡ç”¨`,`éš”å¼€ï¼ŒæŒ‰é¡ºåºæ’åˆ—ã€‚

```solidity
        uint256 _number;
        bool _bool;
        uint256[3] memory _array;
        (_number, _bool, _array) = returnNamed();
```

> è¿™é‡Œï¼Œ`returnNamed()`è¿™é‡Œæ˜¯ä¸Šé¢çš„å‡½æ•°ï¼Œå°±æ˜¯è·å–å‡½æ•°è¿”å›å€¼ã€‚

- è¯»å–éƒ¨åˆ†è¿”å›å€¼ï¼šå£°æ˜è¦è¯»å–çš„è¿”å›å€¼å¯¹åº”çš„å˜é‡ï¼Œä¸è¯»å–çš„ç•™ç©ºã€‚ä¸‹é¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åªè¯»å–`_bool`ï¼Œè€Œä¸è¯»å–è¿”å›çš„`_number`å’Œ`_array`ï¼š

```solidity
        (, _bool2, ) = returnNamed();
```



### 2.1.4 ä½œç”¨åŸŸ

`Solidity`ä¸­å˜é‡æŒ‰ä½œç”¨åŸŸåˆ’åˆ†æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯çŠ¶æ€å˜é‡ï¼ˆstate variableï¼‰ï¼Œå±€éƒ¨å˜é‡ï¼ˆlocal variableï¼‰å’Œå…¨å±€å˜é‡(global variable)

#### 2.1.4.1. çŠ¶æ€å˜é‡

çŠ¶æ€å˜é‡æ˜¯æ•°æ®å­˜å‚¨åœ¨é“¾ä¸Šçš„å˜é‡ï¼Œæ‰€æœ‰åˆçº¦å†…å‡½æ•°éƒ½å¯ä»¥è®¿é—® ï¼Œ**`gas`æ¶ˆè€—é«˜**ã€‚çŠ¶æ€å˜é‡åœ¨**åˆçº¦å†…ã€å‡½æ•°å¤–å£°æ˜**ï¼š

```solidity
contract Variables {
    uint public x = 1;
    uint public y;
    string public z;
}
```



æˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°é‡Œæ›´æ”¹çŠ¶æ€å˜é‡çš„å€¼ï¼š

```solidity
    function foo() external{
        // å¯ä»¥åœ¨å‡½æ•°é‡Œæ›´æ”¹çŠ¶æ€å˜é‡çš„å€¼
        x = 5;
        y = 2;
        z = "0xAA";
    }
```



#### 2.1.4.2. å±€éƒ¨å˜é‡

å±€éƒ¨å˜é‡æ˜¯ä»…åœ¨å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æœ‰æ•ˆçš„å˜é‡ï¼Œå‡½æ•°é€€å‡ºåï¼Œå˜é‡æ— æ•ˆã€‚å±€éƒ¨å˜é‡çš„æ•°æ®å­˜å‚¨åœ¨å†…å­˜é‡Œï¼Œä¸ä¸Šé“¾ï¼Œ`gas`ä½ã€‚å±€éƒ¨å˜é‡åœ¨å‡½æ•°å†…å£°æ˜ï¼š

```solidity
    function bar() external pure returns(uint){
        uint xx = 1;
        uint yy = 3;
        uint zz = xx + yy;
        return(zz);
    }
```



#### 2.1.4.3 å…¨å±€å˜é‡

å…¨å±€å˜é‡æ˜¯å…¨å±€èŒƒå›´å·¥ä½œçš„å˜é‡ï¼Œéƒ½æ˜¯`solidity`é¢„ç•™å…³é”®å­—ã€‚ä»–ä»¬å¯ä»¥åœ¨å‡½æ•°å†…ä¸å£°æ˜ç›´æ¥ä½¿ç”¨ï¼š

```solidity
    function global() external view returns(address, uint, bytes memory){
        address sender = msg.sender;
        uint blockNum = block.number;
        bytes memory data = msg.data;
        return(sender, blockNum, data);
    }
```



åœ¨ä¸Šé¢ä¾‹å­é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†3ä¸ªå¸¸ç”¨çš„å…¨å±€å˜é‡ï¼š`msg.sender`, `block.number`å’Œ`msg.data`ï¼Œä»–ä»¬åˆ†åˆ«ä»£è¡¨è¯·æ±‚å‘èµ·åœ°å€ï¼Œå½“å‰åŒºå—é«˜åº¦ï¼Œå’Œè¯·æ±‚æ•°æ®ã€‚ä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„å…¨å±€å˜é‡ï¼Œæ›´å®Œæ•´çš„åˆ—è¡¨è¯·çœ‹è¿™ä¸ª[é“¾æ¥](https://learnblockchain.cn/docs/solidity/units-and-global-variables.html#special-variables-and-functions)ï¼š

- `blockhash(uint blockNumber)`: (`bytes32`)ç»™å®šåŒºå—çš„å“ˆå¸Œå€¼ â€“ åªé€‚ç”¨äº256æœ€è¿‘åŒºå—, ä¸åŒ…å«å½“å‰åŒºå—ã€‚
- `block.coinbase`: (`address payable`) å½“å‰åŒºå—çŸ¿å·¥çš„åœ°å€
- `block.gaslimit`: (`uint`) å½“å‰åŒºå—çš„gaslimit
- `block.number`: (`uint`) å½“å‰åŒºå—çš„number
- `block.timestamp`: (`uint`) å½“å‰åŒºå—çš„æ—¶é—´æˆ³ï¼Œä¸ºunixçºªå…ƒä»¥æ¥çš„ç§’
- `gasleft()`: (`uint256`) å‰©ä½™ gas
- `msg.data`: (`bytes calldata`) å®Œæ•´call data
- `msg.sender`: (`address payable`) æ¶ˆæ¯å‘é€è€… (å½“å‰ caller)
- `msg.sig`: (`bytes4`) calldataçš„å‰å››ä¸ªå­—èŠ‚ (function identifier)
- `msg.value`: (`uint`) å½“å‰äº¤æ˜“å‘é€çš„`wei`å€¼

### 2.1.4 è°ƒç”¨å‡½æ•°å¹¶å‘é€eth

è°ƒç”¨ **convert** å‡½æ•°ï¼Œå¹¶é™„åŠ *10* wei çš„ ETH 

```solidity
convert{value: 10}();
```



## 2.2 æ„é€ å‡½æ•°å’Œä¿®é¥°å™¨

### 2.2.1 æ„é€ å‡½æ•°

æ„é€ å‡½æ•°ï¼ˆ`constructor`ï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„å‡½æ•°ï¼Œæ¯ä¸ªåˆçº¦å¯ä»¥å®šä¹‰ä¸€ä¸ªï¼Œå¹¶åœ¨éƒ¨ç½²åˆçº¦çš„æ—¶å€™è‡ªåŠ¨è¿è¡Œä¸€æ¬¡ã€‚å®ƒå¯ä»¥ç”¨æ¥åˆå§‹åŒ–åˆçº¦çš„ä¸€äº›å‚æ•°ï¼Œä¾‹å¦‚åˆå§‹åŒ–åˆçº¦çš„`owner`åœ°å€ï¼š

```solidity
   address owner; // å®šä¹‰ownerå˜é‡

   // æ„é€ å‡½æ•°
   constructor() {
      owner = msg.sender; // åœ¨éƒ¨ç½²åˆçº¦çš„æ—¶å€™ï¼Œå°†ownerè®¾ç½®ä¸ºéƒ¨ç½²è€…çš„åœ°å€
   }
```



### 2.2.2 ä¿®é¥°å™¨(åˆçº¦æƒé™)`modifier`

ä¿®é¥°å™¨ï¼ˆ`modifier`ï¼‰æ˜¯`solidity`ç‰¹æœ‰çš„è¯­æ³•ï¼Œç±»ä¼¼äºé¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„`decorator`ï¼Œå£°æ˜å‡½æ•°æ‹¥æœ‰çš„ç‰¹æ€§ï¼Œå¹¶å‡å°‘ä»£ç å†—ä½™ã€‚`modifier`çš„ä¸»è¦ä½¿ç”¨åœºæ™¯æ˜¯è¿è¡Œå‡½æ•°å‰çš„æ£€æŸ¥ï¼Œä¾‹å¦‚åœ°å€ï¼Œå˜é‡ï¼Œä½™é¢ç­‰ã€‚

*modifier* çš„æ‰§è¡Œæ˜¯åœ¨å‡½æ•°æ‰§è¡Œä¹‹å‰çš„ã€‚**_;** è¡¨ç¤ºç»§ç»­æ‰§è¡Œè¢«ä¿®é¥°çš„å‡½æ•°

å®šä¹‰ä¸€ä¸ªå«åšonlyOwnerçš„modifierï¼š

```solidity
   // å®šä¹‰modifier
   modifier onlyOwner {
      require(msg.sender == owner); // æ£€æŸ¥è°ƒç”¨è€…æ˜¯å¦ä¸ºowneråœ°å€
      _; // å¦‚æœæ˜¯çš„è¯ï¼Œç»§ç»­è¿è¡Œå‡½æ•°ä¸»ä½“ï¼›å¦åˆ™æŠ¥é”™å¹¶revertäº¤æ˜“
   }
```



å¸¦æœ‰`onlyOwner`ä¿®é¥°ç¬¦çš„å‡½æ•°åªèƒ½è¢«`owner`åœ°å€è°ƒç”¨ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼š

```solidity
   function changeOwner(address _newOwner) external onlyOwner{
      owner = _newOwner; // åªæœ‰owneråœ°å€è¿è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå¹¶æ”¹å˜owner
   }
```

æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª`changeOwner`å‡½æ•°ï¼Œè¿è¡Œä»–å¯ä»¥æ”¹å˜åˆçº¦çš„`owner`ï¼Œä½†æ˜¯ç”±äº`onlyOwner`ä¿®é¥°ç¬¦çš„å­˜åœ¨ï¼Œåªæœ‰åŸå…ˆçš„`owner`å¯ä»¥è°ƒç”¨ï¼Œåˆ«äººè°ƒç”¨å°±ä¼šæŠ¥é”™ã€‚è¿™ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æ§åˆ¶æ™ºèƒ½åˆçº¦æƒé™çš„æ–¹æ³•ã€‚



## 2.3 äº‹ä»¶

`Solidity`ä¸­çš„äº‹ä»¶ï¼ˆ`event`ï¼‰æ˜¯`EVM`ä¸Šæ—¥å¿—çš„æŠ½è±¡ï¼Œå®ƒå…·æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š

- å“åº”ï¼šåº”ç”¨ç¨‹åºï¼ˆ[`ethers.js`](https://learnblockchain.cn/docs/ethers.js/api-contract.html#id18)ï¼‰å¯ä»¥é€šè¿‡`RPC`æ¥å£è®¢é˜…å’Œç›‘å¬è¿™äº›äº‹ä»¶ï¼Œå¹¶åœ¨å‰ç«¯åšå“åº”ã€‚
- ç»æµï¼šäº‹ä»¶æ˜¯`EVM`ä¸Šæ¯”è¾ƒç»æµçš„å­˜å‚¨æ•°æ®çš„æ–¹å¼ï¼Œæ¯ä¸ªå¤§æ¦‚æ¶ˆè€—2,000 `gas`ï¼›ç›¸æ¯”ä¹‹ä¸‹ï¼Œé“¾ä¸Šå­˜å‚¨ä¸€ä¸ªæ–°å˜é‡è‡³å°‘éœ€è¦20,000 `gas`ã€‚

äº‹ä»¶å¯ä»¥é€šçŸ¥é“¾å¤–çš„ç›‘å¬è€…åˆçº¦ä¸­å‘ç”Ÿçš„ç‰¹å®šæ“ä½œã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·æˆåŠŸå®ŒæˆæŸä¸ªäº¤æ˜“æˆ–è€…æ“ä½œå¯ä»¥é€šè¿‡äº‹ä»¶é€šçŸ¥å‰ç«¯ã€‚

### 2.3.1 å£°æ˜äº‹ä»¶

äº‹ä»¶çš„å£°æ˜ç”±`event`å…³é”®å­—å¼€å¤´ï¼Œæ¥ç€æ˜¯äº‹ä»¶åç§°ï¼Œæ‹¬å·é‡Œé¢å†™å¥½äº‹ä»¶éœ€è¦è®°å½•çš„å˜é‡ç±»å‹å’Œå˜é‡åã€‚ä»¥`ERC20`ä»£å¸åˆçº¦çš„`Transfer`äº‹ä»¶ä¸ºä¾‹ï¼š

```solidity
event Transfer(address indexed from, address indexed to, uint256 value);
```



æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`Transfer`äº‹ä»¶å…±è®°å½•äº†3ä¸ªå˜é‡`from`ï¼Œ`to`å’Œ`value`ï¼Œåˆ†åˆ«å¯¹åº”ä»£å¸çš„è½¬è´¦åœ°å€ï¼Œæ¥æ”¶åœ°å€å’Œè½¬è´¦æ•°é‡ï¼Œå…¶ä¸­`from`å’Œ`to`å‰é¢å¸¦æœ‰`indexed`å…³é”®å­—ï¼Œä»–ä»¬ä¼šä¿å­˜åœ¨ä»¥å¤ªåŠè™šæ‹Ÿæœºæ—¥å¿—çš„`topics`ä¸­ï¼Œæ–¹ä¾¿ä¹‹åæ£€ç´¢ã€‚

### 2.3.2 é‡Šæ”¾äº‹ä»¶

æˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°é‡Œé‡Šæ”¾äº‹ä»¶ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæ¯æ¬¡ç”¨`_transfer()`å‡½æ•°è¿›è¡Œè½¬è´¦æ“ä½œçš„æ—¶å€™ï¼Œéƒ½ä¼šé‡Šæ”¾`Transfer`äº‹ä»¶ï¼Œå¹¶è®°å½•ç›¸åº”çš„å˜é‡ã€‚

```solidity
    // å®šä¹‰_transferå‡½æ•°ï¼Œæ‰§è¡Œè½¬è´¦é€»è¾‘
    function _transfer(
        address from,
        address to,
        uint256 amount
    ) external {

        _balances[from] = 10000000; // ç»™è½¬è´¦åœ°å€ä¸€äº›åˆå§‹ä»£å¸

        _balances[from] -=  amount; // fromåœ°å€å‡å»è½¬è´¦æ•°é‡
        _balances[to] += amount; // toåœ°å€åŠ ä¸Šè½¬è´¦æ•°é‡

        // é‡Šæ”¾äº‹ä»¶
        emit Transfer(from, to, amount);
    }
```



![image-20241008212158008](assets/image-20241008212158008.png)

![image-20241008212200714](assets/image-20241008212200714.png)

## 2.4 æ—¥å¿—

```solidity
event Transfer(address indexed from, address indexed to, uint256 value);
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`Transfer`äº‹ä»¶å…±è®°å½•äº†3ä¸ªå˜é‡`from`ï¼Œ`to`å’Œ`value`ï¼Œåˆ†åˆ«å¯¹åº”ä»£å¸çš„è½¬è´¦åœ°å€ï¼Œæ¥æ”¶åœ°å€å’Œè½¬è´¦æ•°é‡ï¼Œå…¶ä¸­`from`å’Œ`to`å‰é¢å¸¦æœ‰`indexed`å…³é”®å­—ï¼Œä»–ä»¬ä¼šä¿å­˜åœ¨ä»¥å¤ªåŠè™šæ‹Ÿæœºæ—¥å¿—çš„`topics`ä¸­ï¼Œæ–¹ä¾¿ä¹‹åæ£€ç´¢ã€‚



ä»¥å¤ªåŠè™šæ‹Ÿæœºï¼ˆEVMï¼‰ç”¨æ—¥å¿—`Log`æ¥å­˜å‚¨`Solidity`äº‹ä»¶ï¼Œæ¯æ¡æ—¥å¿—è®°å½•éƒ½åŒ…å«ä¸»é¢˜`topics`å’Œæ•°æ®`data`ä¸¤éƒ¨åˆ†ã€‚

### 2.4.1 ä¸»é¢˜ `Topics`

æ—¥å¿—çš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯ä¸»é¢˜æ•°ç»„ï¼Œç”¨äºæè¿°äº‹ä»¶ï¼Œé•¿åº¦ä¸èƒ½è¶…è¿‡`4`ã€‚å®ƒçš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯äº‹ä»¶çš„ç­¾åï¼ˆå“ˆå¸Œï¼‰ã€‚å¯¹äºä¸Šé¢çš„`Transfer`äº‹ä»¶ï¼Œå®ƒçš„ç­¾åå°±æ˜¯ï¼š

```solidity
keccak256("Transfer(addrses,address,uint256)")

//0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef
```

é™¤äº†äº‹ä»¶ç­¾åï¼Œä¸»é¢˜è¿˜å¯ä»¥åŒ…å«è‡³å¤š`3`ä¸ª`indexed`å‚æ•°ï¼Œä¹Ÿå°±æ˜¯`Transfer`äº‹ä»¶ä¸­çš„`from`å’Œ`to`ã€‚

`indexed`æ ‡è®°çš„å‚æ•°å¯ä»¥ç†è§£ä¸ºæ£€ç´¢äº‹ä»¶çš„ç´¢å¼•â€œé”®â€ï¼Œæ–¹ä¾¿ä¹‹åæœç´¢ã€‚æ¯ä¸ª `indexed` å‚æ•°çš„å¤§å°ä¸ºå›ºå®šçš„256æ¯”ç‰¹ï¼Œå¦‚æœå‚æ•°å¤ªå¤§äº†ï¼ˆæ¯”å¦‚å­—ç¬¦ä¸²ï¼‰ï¼Œå°±ä¼šè‡ªåŠ¨è®¡ç®—å“ˆå¸Œå­˜å‚¨åœ¨ä¸»é¢˜ä¸­ã€‚

æ²¡æœ‰`indexed`å…³é”®è¯çš„ä¼šè¢«ç¼–ç ï¼Œä¸æ–¹ä¾¿æ£€ç´¢ã€‚



### 2.4.2 æ•°æ® `Data`

äº‹ä»¶ä¸­ä¸å¸¦ `indexed`çš„å‚æ•°ä¼šè¢«å­˜å‚¨åœ¨ `data` éƒ¨åˆ†ä¸­ï¼Œå¯ä»¥ç†è§£ä¸ºäº‹ä»¶çš„â€œå€¼â€ã€‚`data` éƒ¨åˆ†çš„å˜é‡ä¸èƒ½è¢«ç›´æ¥æ£€ç´¢ï¼Œä½†å¯ä»¥å­˜å‚¨ä»»æ„å¤§å°çš„æ•°æ®ã€‚å› æ­¤ä¸€èˆ¬ `data` éƒ¨åˆ†å¯ä»¥ç”¨æ¥å­˜å‚¨å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚æ•°ç»„å’Œå­—ç¬¦ä¸²ç­‰ç­‰ï¼Œå› ä¸ºè¿™äº›æ•°æ®è¶…è¿‡äº†256æ¯”ç‰¹ï¼Œå³ä½¿å­˜å‚¨åœ¨äº‹ä»¶çš„ `topic` éƒ¨åˆ†ä¸­ï¼Œä¹Ÿæ˜¯ä»¥å“ˆå¸Œçš„æ–¹å¼å­˜å‚¨ã€‚å¦å¤–ï¼Œ`data` éƒ¨åˆ†çš„å˜é‡åœ¨å­˜å‚¨ä¸Šæ¶ˆè€—çš„gasç›¸æ¯”äº `topic` æ›´å°‘ã€‚

### 2.4.3 åœ¨etherscanä¸ŠæŸ¥è¯¢äº‹ä»¶

æˆ‘ä»¬å°è¯•ç”¨`_transfer()`å‡½æ•°åœ¨`Rinkeby`æµ‹è¯•ç½‘ç»œä¸Šè½¬è´¦100ä»£å¸ï¼Œå¯ä»¥åœ¨`etherscan`ä¸ŠæŸ¥è¯¢åˆ°ç›¸åº”çš„`tx`ï¼š[ç½‘å€](https://rinkeby.etherscan.io/tx/0x8cf87215b23055896d93004112bbd8ab754f081b4491cb48c37592ca8f8a36c7)ã€‚

ç‚¹å‡»`Logs`æŒ‰é’®ï¼Œå°±èƒ½çœ‹åˆ°äº‹ä»¶æ˜ç»†ï¼š



## 2.5 å¼‚å¸¸

ä¸‰ç§æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•ï¼š`error`ï¼Œ`require`å’Œ`assert`

å†™æ™ºèƒ½åˆçº¦ç»å¸¸ä¼šå‡º`bug`ï¼Œ`solidity`ä¸­çš„å¼‚å¸¸å‘½ä»¤å¸®åŠ©æˆ‘ä»¬`debug`ã€‚

### 2.5.1 Error

`error`æ˜¯`solidity 0.8.4ç‰ˆæœ¬`æ–°åŠ çš„å†…å®¹ï¼Œæ–¹ä¾¿ä¸”é«˜æ•ˆï¼ˆçœ`gas`ï¼‰åœ°å‘ç”¨æˆ·è§£é‡Šæ“ä½œå¤±è´¥çš„åŸå› ï¼ŒåŒæ—¶è¿˜å¯ä»¥åœ¨æŠ›å‡ºå¼‚å¸¸çš„åŒæ—¶æºå¸¦å‚æ•°ï¼Œå¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°è°ƒè¯•ã€‚äººä»¬å¯ä»¥åœ¨`contract`ä¹‹å¤–å®šä¹‰å¼‚å¸¸ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª`TransferNotOwner`å¼‚å¸¸ï¼Œå½“ç”¨æˆ·ä¸æ˜¯ä»£å¸`owner`çš„æ—¶å€™å°è¯•è½¬è´¦ï¼Œä¼šæŠ›å‡ºé”™è¯¯ï¼š

```solidity
error TransferNotOwner(); // è‡ªå®šä¹‰error
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰ä¸€ä¸ªæºå¸¦å‚æ•°çš„å¼‚å¸¸ï¼Œæ¥æç¤ºå°è¯•è½¬è´¦çš„è´¦æˆ·åœ°å€

```solidity
error TransferNotOwner(address sender); // è‡ªå®šä¹‰çš„å¸¦å‚æ•°çš„error
```



åœ¨æ‰§è¡Œå½“ä¸­ï¼Œ`error`å¿…é¡»æ­é…`revert`ï¼ˆå›é€€ï¼‰å‘½ä»¤ä½¿ç”¨ã€‚

```solidity
    function transferOwner1(uint256 tokenId, address newOwner) public {
        if(_owners[tokenId] != msg.sender){
            revert TransferNotOwner();
            // revert TransferNotOwner(msg.sender);
        }
        _owners[tokenId] = newOwner;
    }
```



æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª`transferOwner1()`å‡½æ•°ï¼Œå®ƒä¼šæ£€æŸ¥ä»£å¸çš„`owner`æ˜¯ä¸æ˜¯å‘èµ·äººï¼Œå¦‚æœä¸æ˜¯ï¼Œå°±ä¼šæŠ›å‡º`TransferNotOwner`å¼‚å¸¸ï¼›å¦‚æœæ˜¯çš„è¯ï¼Œå°±ä¼šè½¬è´¦ã€‚

### 2.5.2 Require

`require`å‘½ä»¤æ˜¯`solidity 0.8ç‰ˆæœ¬`ä¹‹å‰æŠ›å‡ºå¼‚å¸¸çš„å¸¸ç”¨æ–¹æ³•ï¼Œç›®å‰å¾ˆå¤šä¸»æµåˆçº¦ä»ç„¶è¿˜åœ¨ä½¿ç”¨å®ƒã€‚å®ƒå¾ˆå¥½ç”¨ï¼Œå”¯ä¸€çš„ç¼ºç‚¹å°±æ˜¯`gas`éšç€æè¿°å¼‚å¸¸çš„å­—ç¬¦ä¸²é•¿åº¦å¢åŠ ï¼Œæ¯”`error`å‘½ä»¤è¦é«˜ã€‚ä½¿ç”¨æ–¹æ³•ï¼š`require(æ£€æŸ¥æ¡ä»¶ï¼Œ"å¼‚å¸¸çš„æè¿°")`ï¼Œå½“æ£€æŸ¥æ¡ä»¶ä¸æˆç«‹çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

æˆ‘ä»¬ç”¨`require`å‘½ä»¤é‡å†™ä¸€ä¸‹ä¸Šé¢çš„`transferOwner`å‡½æ•°ï¼š

```solidity
    function transferOwner2(uint256 tokenId, address newOwner) public {
        require(_owners[tokenId] == msg.sender, "Transfer Not Owner");
        _owners[tokenId] = newOwner;
    }
```



### 2.5.3 Assert

`assert`å‘½ä»¤ä¸€èˆ¬ç”¨äºç¨‹åºå‘˜å†™ç¨‹åº`debug`ï¼Œå› ä¸ºå®ƒä¸èƒ½è§£é‡ŠæŠ›å‡ºå¼‚å¸¸çš„åŸå› ï¼ˆæ¯”`require`å°‘ä¸ªå­—ç¬¦ä¸²ï¼‰ã€‚å®ƒçš„ç”¨æ³•å¾ˆç®€å•ï¼Œ`assert(æ£€æŸ¥æ¡ä»¶ï¼‰`ï¼Œå½“æ£€æŸ¥æ¡ä»¶ä¸æˆç«‹çš„æ—¶å€™ï¼Œå°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

æˆ‘ä»¬ç”¨`assert`å‘½ä»¤é‡å†™ä¸€ä¸‹ä¸Šé¢çš„`transferOwner`å‡½æ•°ï¼š

```solidity
    function transferOwner3(uint256 tokenId, address newOwner) public {
        assert(_owners[tokenId] == msg.sender);
        _owners[tokenId] = newOwner;
    }
```



### 2.5.4 ä¸‰ç§æ–¹æ³•çš„gasæ¯”è¾ƒ

æˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹ä¸‰ç§æŠ›å‡ºå¼‚å¸¸çš„`gas`æ¶ˆè€—ï¼Œé€šè¿‡remixæ§åˆ¶å°çš„DebugæŒ‰é’®ï¼Œèƒ½æŸ¥åˆ°æ¯æ¬¡å‡½æ•°è°ƒç”¨çš„`gas`æ¶ˆè€—åˆ†åˆ«å¦‚ä¸‹ï¼š ï¼ˆä½¿ç”¨0.8.17ç‰ˆæœ¬ç¼–è¯‘ï¼‰

1. **`error`æ–¹æ³•`gas`æ¶ˆè€—**ï¼š24457 (**åŠ å…¥å‚æ•°å`gas`æ¶ˆè€—**ï¼š24660)
2. **`require`æ–¹æ³•`gas`æ¶ˆè€—**ï¼š24755
3. **`assert`æ–¹æ³•`gas`æ¶ˆè€—**ï¼š24473

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`error`æ–¹æ³•`gas`æœ€å°‘ï¼Œå…¶æ¬¡æ˜¯`assert`ï¼Œ`require`æ–¹æ³•æ¶ˆè€—`gas`æœ€å¤šï¼å› æ­¤ï¼Œ`error`æ—¢å¯ä»¥å‘ŠçŸ¥ç”¨æˆ·æŠ›å‡ºå¼‚å¸¸çš„åŸå› ï¼Œåˆèƒ½çœ`gas`ï¼Œå¤§å®¶è¦å¤šç”¨ï¼ï¼ˆæ³¨æ„ï¼Œç”±äºéƒ¨ç½²æµ‹è¯•æ—¶é—´çš„ä¸åŒï¼Œæ¯ä¸ªå‡½æ•°çš„`gas`æ¶ˆè€—ä¼šæœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯æ¯”è¾ƒç»“æœä¼šæ˜¯ä¸€è‡´çš„ã€‚ï¼‰



### 2.5.5 Try Catch

åœ¨`solidity`ä¸­ï¼Œ`try-catch`åªèƒ½è¢«ç”¨äº`external`å‡½æ•°æˆ–åˆ›å»ºåˆçº¦æ—¶`constructor`ï¼ˆè¢«è§†ä¸º`external`å‡½æ•°ï¼‰çš„è°ƒç”¨ã€‚åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š

```solidity
        try externalContract.f() {
            // callæˆåŠŸçš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
        } catch {
            // callå¤±è´¥çš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
        }
```



å…¶ä¸­`externalContract.f()`æ˜¯æŸä¸ªå¤–éƒ¨åˆçº¦çš„å‡½æ•°è°ƒç”¨ï¼Œ`try`æ¨¡å—åœ¨è°ƒç”¨æˆåŠŸçš„æƒ…å†µä¸‹è¿è¡Œï¼Œè€Œ`catch`æ¨¡å—åˆ™åœ¨è°ƒç”¨å¤±è´¥æ—¶è¿è¡Œã€‚

åŒæ ·å¯ä»¥ä½¿ç”¨`this.f()`æ¥æ›¿ä»£`externalContract.f()`ï¼Œ`this.f()`ä¹Ÿè¢«è§†ä½œä¸ºå¤–éƒ¨è°ƒç”¨ï¼Œä½†ä¸å¯åœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨ï¼Œå› ä¸ºæ­¤æ—¶åˆçº¦è¿˜æœªåˆ›å»ºã€‚

å¦‚æœè°ƒç”¨çš„å‡½æ•°æœ‰è¿”å›å€¼ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨`try`ä¹‹åå£°æ˜`returns(returnType val)`ï¼Œå¹¶ä¸”åœ¨`try`æ¨¡å—ä¸­å¯ä»¥ä½¿ç”¨è¿”å›çš„å˜é‡ï¼›å¦‚æœæ˜¯åˆ›å»ºåˆçº¦ï¼Œé‚£ä¹ˆè¿”å›å€¼æ˜¯æ–°åˆ›å»ºçš„åˆçº¦å˜é‡ã€‚

```solidity
        try externalContract.f() returns(returnType val){
            // callæˆåŠŸçš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
        } catch {
            // callå¤±è´¥çš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
        }
```



å¦å¤–ï¼Œ`catch`æ¨¡å—æ”¯æŒæ•è·ç‰¹æ®Šçš„å¼‚å¸¸åŸå› ï¼š

```solidity
        try externalContract.f() returns(returnType){
            // callæˆåŠŸçš„æƒ…å†µä¸‹ è¿è¡Œä¸€äº›ä»£ç 
        } catch Error(string memory reason) {
            // æ•è·å¤±è´¥çš„ revert() å’Œ require()
        } catch (bytes memory reason) {
            // æ•è·å¤±è´¥çš„ assert()
        }
```



**å®æˆ˜**ï¼š

æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå¤–éƒ¨åˆçº¦`OnlyEven`ï¼Œå¹¶ä½¿ç”¨`try-catch`æ¥å¤„ç†å¼‚å¸¸ï¼š

```solidity
contract OnlyEven{
    constructor(uint a){
        require(a != 0, "invalid number");
        assert(a != 1);
    }

    function onlyEven(uint256 b) external pure returns(bool success){
        // è¾“å…¥å¥‡æ•°æ—¶revert
        require(b % 2 == 0, "Ups! Reverting");
        success = true;
    }
}
```



`OnlyEven`åˆçº¦åŒ…å«ä¸€ä¸ªæ„é€ å‡½æ•°å’Œä¸€ä¸ª`onlyEven`å‡½æ•°ã€‚

- æ„é€ å‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°`a`ï¼Œå½“`a=0`æ—¶ï¼Œ`require`ä¼šæŠ›å‡ºå¼‚å¸¸ï¼›å½“`a=1`æ—¶ï¼Œ`assert`ä¼šæŠ›å‡ºå¼‚å¸¸ï¼›å…¶ä»–æƒ…å†µå‡æ­£å¸¸ã€‚
- `onlyEven`å‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°`b`ï¼Œå½“`b`ä¸ºå¥‡æ•°æ—¶ï¼Œ`require`ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚

#### 2.5.5.1 å¤„ç†å¤–éƒ¨å‡½æ•°è°ƒç”¨å¼‚å¸¸

é¦–å…ˆï¼Œåœ¨`TryCatch`åˆçº¦ä¸­å®šä¹‰ä¸€äº›äº‹ä»¶å’ŒçŠ¶æ€å˜é‡ï¼š

```solidity
    // æˆåŠŸevent
    event SuccessEvent();

    // å¤±è´¥event
    event CatchEvent(string message);
    event CatchByte(bytes data);

    // å£°æ˜OnlyEvenåˆçº¦å˜é‡
    OnlyEven even;

    constructor() {
        even = new OnlyEven(2);
    }
```

`SuccessEvent`æ˜¯è°ƒç”¨æˆåŠŸä¼šé‡Šæ”¾çš„äº‹ä»¶ï¼Œè€Œ`CatchEvent`å’Œ`CatchByte`æ˜¯æŠ›å‡ºå¼‚å¸¸æ—¶ä¼šé‡Šæ”¾çš„äº‹ä»¶ï¼Œåˆ†åˆ«å¯¹åº”`require/revert`å’Œ`assert`å¼‚å¸¸çš„æƒ…å†µã€‚`even`æ˜¯ä¸ª`OnlyEven`åˆçº¦ç±»å‹çš„çŠ¶æ€å˜é‡ã€‚

ç„¶åæˆ‘ä»¬åœ¨`execute`å‡½æ•°ä¸­ä½¿ç”¨`try-catch`å¤„ç†è°ƒç”¨å¤–éƒ¨å‡½æ•°`onlyEven`ä¸­çš„å¼‚å¸¸ï¼š

```solidity
    // åœ¨external callä¸­ä½¿ç”¨try-catch
    function execute(uint amount) external returns (bool success) {
        try even.onlyEven(amount) returns(bool _success){
            // callæˆåŠŸçš„æƒ…å†µä¸‹
            emit SuccessEvent();
            return _success;
        } catch Error(string memory reason){
            // callä¸æˆåŠŸçš„æƒ…å†µä¸‹
            emit CatchEvent(reason);
        }
```



#### 2.5.5.2 å¤„ç†åˆçº¦åˆ›å»ºå¼‚å¸¸

è¿™é‡Œï¼Œæˆ‘ä»¬åˆ©ç”¨`try-catch`æ¥å¤„ç†åˆçº¦åˆ›å»ºæ—¶çš„å¼‚å¸¸ã€‚åªéœ€è¦æŠŠ`try`æ¨¡å—æ”¹å†™ä¸º`OnlyEven`åˆçº¦çš„åˆ›å»ºå°±è¡Œï¼š

```solidity
    // åœ¨åˆ›å»ºæ–°åˆçº¦ä¸­ä½¿ç”¨try-catch ï¼ˆåˆçº¦åˆ›å»ºè¢«è§†ä¸ºexternal callï¼‰
    // executeNew(0)ä¼šå¤±è´¥å¹¶é‡Šæ”¾`CatchEvent`
    // executeNew(1)ä¼šå¤±è´¥å¹¶é‡Šæ”¾`CatchByte`
    // executeNew(2)ä¼šæˆåŠŸå¹¶é‡Šæ”¾`SuccessEvent`
    function executeNew(uint a) external returns (bool success) {
        try new OnlyEven(a) returns(OnlyEven _even){
            // callæˆåŠŸçš„æƒ…å†µä¸‹
            emit SuccessEvent();
            success = _even.onlyEven(a);
        } catch Error(string memory reason) {
            // catchå¤±è´¥çš„ revert() å’Œ require()
            emit CatchEvent(reason);
        } catch (bytes memory reason) {
            // catchå¤±è´¥çš„ assert()
            emit CatchByte(reason);
        }
    }
```



# 3 é¢å‘å¯¹è±¡

> åˆçº¦çš„å…³é”®å­—æ˜¯`contract`ï¼Œ ç±»ä¼¼javaçš„`calss`

## 3.1 å°è£…

```solidity
// I'm a comment!
// SPDX-License-Identifier: MIT

pragma solidity ^0.8.8;
// pragma solidity ^0.8.0;
// pragma solidity >=0.8.0 <0.9.0;

contract SimpleStorage {

    uint256 favoriteNumber;

    struct People {
        uint256 favoriteNumber;
        string name;
    }
    // uint256[] public anArray;
    People[] public people;

    mapping(string => uint256) public nameToFavoriteNumber;

    function store(uint256 _favoriteNumber) public {
        favoriteNumber = _favoriteNumber;
    }
    
    function retrieve() public view returns (uint256){
        return favoriteNumber;
    }

    function addPerson(string memory _name, uint256 _favoriteNumber) public {
        people.push(People(_favoriteNumber, _name));
        nameToFavoriteNumber[_name] = _favoriteNumber;
    }
}

```

> å°±æ˜¯æ­£å¸¸çš„å†™å‡½æ•°



## 3.2 ç»§æ‰¿

### 3.2.1 åŸºæœ¬

- `virtual`: çˆ¶åˆçº¦ä¸­çš„å‡½æ•°ï¼Œå¦‚æœå¸Œæœ›å­åˆçº¦é‡å†™ï¼Œéœ€è¦åŠ ä¸Š`virtual`å…³é”®å­—ã€‚
- `override`ï¼šå­åˆçº¦é‡å†™äº†çˆ¶åˆçº¦ä¸­çš„å‡½æ•°ï¼Œéœ€è¦åŠ ä¸Š`override`å…³é”®å­—ã€‚

**æ³¨æ„**ï¼šç”¨`override`ä¿®é¥°`public`å˜é‡ï¼Œä¼šé‡å†™ä¸å˜é‡åŒåçš„`getter`å‡½æ•°ï¼Œä¾‹å¦‚ï¼š

```solidity
mapping(address => uint256) public override balanceOf;
```



```solidity
import "./SimpleStorage.sol";

contract ExtraStorage is SimpleStorage{

}
```

> å…³é”®è¯æ˜¯`is`ï¼Œä½¿ç”¨å‰éœ€è¦å¯¼å…¥

### 3.2.2 ç®€å•ç»§æ‰¿

æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç®€å•çš„çˆ·çˆ·åˆçº¦`Yeye`ï¼Œé‡Œé¢åŒ…å«1ä¸ª`Log`äº‹ä»¶å’Œ3ä¸ª`function`: `hip()`, `pop()`, `yeye()`ï¼Œè¾“å‡ºéƒ½æ˜¯â€Yeyeâ€ã€‚

```solidity
contract Yeye {
    event Log(string msg);

    // å®šä¹‰3ä¸ªfunction: hip(), pop(), man()ï¼ŒLogå€¼ä¸ºYeyeã€‚
    function hip() public virtual{
        emit Log("Yeye");
    }

    function pop() public virtual{
        emit Log("Yeye");
    }

    function yeye() public virtual {
        emit Log("Yeye");
    }
}
```



æˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ªçˆ¸çˆ¸åˆçº¦`Baba`ï¼Œè®©ä»–ç»§æ‰¿`Yeye`åˆçº¦ï¼Œè¯­æ³•å°±æ˜¯`contract Baba is Yeye`ï¼Œéå¸¸ç›´è§‚ã€‚åœ¨`Baba`åˆçº¦é‡Œï¼Œæˆ‘ä»¬é‡å†™ä¸€ä¸‹`hip()`å’Œ`pop()`è¿™ä¸¤ä¸ªå‡½æ•°ï¼ŒåŠ ä¸Š`override`å…³é”®å­—ï¼Œå¹¶å°†ä»–ä»¬çš„è¾“å‡ºæ”¹ä¸º`â€Babaâ€`ï¼›å¹¶ä¸”åŠ ä¸€ä¸ªæ–°çš„å‡½æ•°`baba`ï¼Œè¾“å‡ºä¹Ÿæ˜¯`â€Babaâ€`ã€‚

```solidity
contract Baba is Yeye{
    // ç»§æ‰¿ä¸¤ä¸ªfunction: hip()å’Œpop()ï¼Œè¾“å‡ºæ”¹ä¸ºBabaã€‚
    function hip() public virtual override{
        emit Log("Baba");
    }

    function pop() public virtual override{
        emit Log("Baba");
    }

    function baba() public virtual{
        emit Log("Baba");
    }
}
```



æˆ‘ä»¬éƒ¨ç½²åˆçº¦ï¼Œå¯ä»¥çœ‹åˆ°`Baba`åˆçº¦é‡Œæœ‰4ä¸ªå‡½æ•°ï¼Œå…¶ä¸­`hip()`å’Œ`pop()`çš„è¾“å‡ºè¢«æˆåŠŸæ”¹å†™æˆ`â€Babaâ€`ï¼Œè€Œç»§æ‰¿æ¥çš„`yeye()`çš„è¾“å‡ºä»ç„¶æ˜¯`â€Yeyeâ€`ã€‚

### 3.2.3 å¤šé‡ç»§æ‰¿

`solidity`çš„åˆçº¦å¯ä»¥ç»§æ‰¿å¤šä¸ªåˆçº¦ã€‚è§„åˆ™ï¼š

1. ç»§æ‰¿æ—¶è¦æŒ‰è¾ˆåˆ†æœ€é«˜åˆ°æœ€ä½çš„é¡ºåºæ’ã€‚æ¯”å¦‚æˆ‘ä»¬å†™ä¸€ä¸ª`Erzi`åˆçº¦ï¼Œç»§æ‰¿`Yeye`åˆçº¦å’Œ`Baba`åˆçº¦ï¼Œé‚£ä¹ˆå°±è¦å†™æˆ`contract Erzi is Yeye, Baba`ï¼Œè€Œä¸èƒ½å†™æˆ`contract Erzi is Baba, Yeye`ï¼Œä¸ç„¶å°±ä¼šæŠ¥é”™ã€‚
2. å¦‚æœæŸä¸€ä¸ªå‡½æ•°åœ¨å¤šä¸ªç»§æ‰¿çš„åˆçº¦é‡Œéƒ½å­˜åœ¨ï¼Œæ¯”å¦‚ä¾‹å­ä¸­çš„`hip()`å’Œ`pop()`ï¼Œåœ¨å­åˆçº¦é‡Œå¿…é¡»é‡å†™ï¼Œä¸ç„¶ä¼šæŠ¥é”™ã€‚
3. é‡å†™åœ¨å¤šä¸ªçˆ¶åˆçº¦ä¸­éƒ½é‡åçš„å‡½æ•°æ—¶ï¼Œ`override`å…³é”®å­—åé¢è¦åŠ ä¸Šæ‰€æœ‰çˆ¶åˆçº¦åå­—ï¼Œä¾‹å¦‚`override(Yeye, Baba)`ã€‚

ä¾‹å­ï¼š

```solidity
contract Erzi is Yeye, Baba{
    // ç»§æ‰¿ä¸¤ä¸ªfunction: hip()å’Œpop()ï¼Œè¾“å‡ºå€¼ä¸ºErziã€‚
    function hip() public virtual override(Yeye, Baba){
        emit Log("Erzi");
    }

    function pop() public virtual override(Yeye, Baba) {
        emit Log("Erzi");
    }
```



æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`Erzi`åˆçº¦é‡Œé¢é‡å†™äº†`hip()`å’Œ`pop()`ä¸¤ä¸ªå‡½æ•°ï¼Œå°†è¾“å‡ºæ”¹ä¸º`â€Erziâ€`ï¼Œå¹¶ä¸”è¿˜åˆ†åˆ«ä»`Yeye`å’Œ`Baba`åˆçº¦ç»§æ‰¿äº†`yeye()`å’Œ`baba()`ä¸¤ä¸ªå‡½æ•°ã€‚

### 3.2.4 ä¿®é¥°å™¨çš„ç»§æ‰¿

`Solidity`ä¸­çš„ä¿®é¥°å™¨ï¼ˆ`Modifier`ï¼‰åŒæ ·å¯ä»¥ç»§æ‰¿ï¼Œç”¨æ³•ä¸å‡½æ•°ç»§æ‰¿ç±»ä¼¼ï¼Œåœ¨ç›¸åº”çš„åœ°æ–¹åŠ `virtual`å’Œ`override`å…³é”®å­—å³å¯ã€‚

```solidity
contract Base1 {
    modifier exactDividedBy2And3(uint _a) virtual {
        require(_a % 2 == 0 && _a % 3 == 0);
        _;
    }
}

contract Identifier is Base1 {

    //è®¡ç®—ä¸€ä¸ªæ•°åˆ†åˆ«è¢«2é™¤å’Œè¢«3é™¤çš„å€¼ï¼Œä½†æ˜¯ä¼ å…¥çš„å‚æ•°å¿…é¡»æ˜¯2å’Œ3çš„å€æ•°
    function getExactDividedBy2And3(uint _dividend) public exactDividedBy2And3(_dividend) pure returns(uint, uint) {
        return getExactDividedBy2And3WithoutModifier(_dividend);
    }

    //è®¡ç®—ä¸€ä¸ªæ•°åˆ†åˆ«è¢«2é™¤å’Œè¢«3é™¤çš„å€¼
    function getExactDividedBy2And3WithoutModifier(uint _dividend) public pure returns(uint, uint){
        uint div2 = _dividend / 2;
        uint div3 = _dividend / 3;
        return (div2, div3);
    }
}
```



`Identifier`åˆçº¦å¯ä»¥ç›´æ¥åœ¨ä»£ç ä¸­ä½¿ç”¨çˆ¶åˆçº¦ä¸­çš„`exactDividedBy2And3`ä¿®é¥°å™¨ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨`override`å…³é”®å­—é‡å†™ä¿®é¥°å™¨ï¼š

```solidity
    modifier exactDividedBy2And3(uint _a) override {
        _;
        require(_a % 2 == 0 && _a % 3 == 0);
    }
```



### 3.2.5 æ„é€ å‡½æ•°çš„ç»§æ‰¿

å­åˆçº¦æœ‰ä¸¤ç§æ–¹æ³•ç»§æ‰¿çˆ¶åˆçº¦çš„æ„é€ å‡½æ•°ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œçˆ¶åˆçº¦`A`é‡Œé¢æœ‰ä¸€ä¸ªçŠ¶æ€å˜é‡`a`ï¼Œå¹¶ç”±æ„é€ å‡½æ•°çš„å‚æ•°æ¥ç¡®å®šï¼š

```solidity
// æ„é€ å‡½æ•°çš„ç»§æ‰¿
abstract contract A {
    uint public a;

    constructor(uint _a) {
        a = _a;
    }
}
```



1. åœ¨ç»§æ‰¿æ—¶å£°æ˜çˆ¶æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š`contract B is A(1)`
2. åœ¨å­åˆçº¦çš„æ„é€ å‡½æ•°ä¸­å£°æ˜æ„é€ å‡½æ•°çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼š

```solidity
contract C is A {
    constructor(uint _c) A(_c * _c) {}
}
```



### 3.2.6 è°ƒç”¨çˆ¶åˆçº¦çš„å‡½æ•°

å­åˆçº¦æœ‰ä¸¤ç§æ–¹å¼è°ƒç”¨çˆ¶åˆçº¦çš„å‡½æ•°ï¼Œç›´æ¥è°ƒç”¨å’Œåˆ©ç”¨`super`å…³é”®å­—ã€‚

1. ç›´æ¥è°ƒç”¨ï¼šå­åˆçº¦å¯ä»¥ç›´æ¥ç”¨`çˆ¶åˆçº¦å.å‡½æ•°å()`çš„æ–¹å¼æ¥è°ƒç”¨çˆ¶åˆçº¦å‡½æ•°ï¼Œä¾‹å¦‚`Yeye.pop()`ã€‚

```solidity
    function callParent() public{
        Yeye.pop();
    }
```



1. `super`å…³é”®å­—ï¼šå­åˆçº¦å¯ä»¥åˆ©ç”¨`super.å‡½æ•°å()`æ¥è°ƒç”¨æœ€è¿‘çš„çˆ¶åˆçº¦å‡½æ•°ã€‚`solidity`ç»§æ‰¿å…³ç³»æŒ‰å£°æ˜æ—¶ä»å³åˆ°å·¦çš„é¡ºåºæ˜¯ï¼š`contract Erzi is Yeye, Baba`ï¼Œé‚£ä¹ˆ`Baba`æ˜¯æœ€è¿‘çš„çˆ¶åˆçº¦ï¼Œ`super.pop()`å°†è°ƒç”¨`Baba.pop()`è€Œä¸æ˜¯`Yeye.pop()`ï¼š

```solidity
    function callParentSuper() public{
        // å°†è°ƒç”¨æœ€è¿‘çš„çˆ¶åˆçº¦å‡½æ•°ï¼ŒBaba.pop()
        super.pop();
    }
```



### 3.2.7 é’»çŸ³ç»§æ‰¿

åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œé’»çŸ³ç»§æ‰¿ï¼ˆè±å½¢ç»§æ‰¿ï¼‰æŒ‡ä¸€ä¸ªæ´¾ç”Ÿç±»åŒæ—¶æœ‰ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„åŸºç±»ã€‚

åœ¨å¤šé‡+è±å½¢ç»§æ‰¿é“¾æ¡ä¸Šä½¿ç”¨`super`å…³é”®å­—æ—¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä½¿ç”¨`super`ä¼šè°ƒç”¨ç»§æ‰¿é“¾æ¡ä¸Šçš„æ¯ä¸€ä¸ªåˆçº¦çš„ç›¸å…³å‡½æ•°ï¼Œè€Œä¸æ˜¯åªè°ƒç”¨æœ€è¿‘çš„çˆ¶åˆçº¦ã€‚

æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªåˆçº¦`God`ï¼Œå†å†™`Adam`å’Œ`Eve`ä¸¤ä¸ªåˆçº¦ç»§æ‰¿`God`åˆçº¦ï¼Œæœ€åè®©åˆ›å»ºåˆçº¦`people`ç»§æ‰¿è‡ª`Adam`å’Œ`Eve`ï¼Œæ¯ä¸ªåˆçº¦éƒ½æœ‰`foo`å’Œ`bar`ä¸¤ä¸ªå‡½æ•°ã€‚

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.13;

/* ç»§æ‰¿æ ‘ï¼š
  God
 /  \
Adam Eve
 \  /
people
*/

contract God {
    event Log(string message);

    function foo() public virtual {
        emit Log("God.foo called");
    }

    function bar() public virtual {
        emit Log("God.bar called");
    }
}

contract Adam is God {
    function foo() public virtual override {
        emit Log("Adam.foo called");
    }

    function bar() public virtual override {
        emit Log("Adam.bar called");
        super.bar();
    }
}

contract Eve is God {
    function foo() public virtual override {
        emit Log("Eve.foo called");
        super.foo();
    }

    function bar() public virtual override {
        emit Log("Eve.bar called");
        super.bar();
    }
}

contract people is Adam, Eve {
    function foo() public override(Adam, Eve) {
        super.foo();
    }

    function bar() public override(Adam, Eve) {
        super.bar();
    }
}
```



åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œè°ƒç”¨åˆçº¦`people`ä¸­çš„`super.bar()`ä¼šä¾æ¬¡è°ƒç”¨`Eve`ã€`Adam`ï¼Œæœ€åæ˜¯`God`åˆçº¦ã€‚

è™½ç„¶`Eve`ã€`Adam`éƒ½æ˜¯`God`çš„å­åˆçº¦ï¼Œä½†æ•´ä¸ªè¿‡ç¨‹ä¸­`God`åˆçº¦åªä¼šè¢«è°ƒç”¨ä¸€æ¬¡ã€‚åŸå› æ˜¯Solidityå€Ÿé‰´äº†Pythonçš„æ–¹å¼ï¼Œå¼ºåˆ¶ä¸€ä¸ªç”±åŸºç±»æ„æˆçš„DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰ä½¿å…¶ä¿è¯ä¸€ä¸ªç‰¹å®šçš„é¡ºåºã€‚æ›´å¤šç»†èŠ‚ä½ å¯ä»¥æŸ¥é˜…[Solidityçš„å®˜æ–¹æ–‡æ¡£](https://solidity-cn.readthedocs.io/zh/develop/contracts.html?highlight=ç»§æ‰¿#index-16)ã€‚





## 3.3 æŠ½è±¡åˆçº¦

æŠ½è±¡åˆçº¦ï¼ˆ`abstract`ï¼‰

å¦‚æœä¸€ä¸ªæ™ºèƒ½åˆçº¦é‡Œè‡³å°‘æœ‰ä¸€ä¸ªæœªå®ç°çš„å‡½æ•°ï¼Œå³æŸä¸ªå‡½æ•°ç¼ºå°‘ä¸»ä½“`{}`ä¸­çš„å†…å®¹ï¼Œåˆ™å¿…é¡»å°†è¯¥åˆçº¦æ ‡ä¸º`abstract`ï¼Œä¸ç„¶ç¼–è¯‘ä¼šæŠ¥é”™ï¼›å¦å¤–ï¼Œæœªå®ç°çš„å‡½æ•°éœ€è¦åŠ `virtual`ï¼Œä»¥ä¾¿å­åˆçº¦é‡å†™ã€‚æ‹¿æˆ‘ä»¬ä¹‹å‰çš„[æ’å…¥æ’åºåˆçº¦](https://github.com/AmazingAng/WTFSolidity/tree/main/07_InsertionSort)ä¸ºä¾‹ï¼Œå¦‚æœæˆ‘ä»¬è¿˜æ²¡æƒ³å¥½å…·ä½“æ€ä¹ˆå®ç°æ’å…¥æ’åºå‡½æ•°ï¼Œé‚£ä¹ˆå¯ä»¥æŠŠåˆçº¦æ ‡ä¸º`abstract`ï¼Œä¹‹åè®©åˆ«äººè¡¥å†™ä¸Šã€‚

```solidity
abstract contract InsertionSort{
    function insertionSort(uint[] memory a) public pure virtual returns(uint[] memory);
}
```



## 3.4 æ¥å£

æ¥å£`interface`ç±»ä¼¼äºæŠ½è±¡åˆçº¦ï¼Œä½†å®ƒä¸å®ç°ä»»ä½•åŠŸèƒ½ã€‚æ¥å£çš„è§„åˆ™ï¼š

1. ä¸èƒ½åŒ…å«çŠ¶æ€å˜é‡
2. ä¸èƒ½åŒ…å«æ„é€ å‡½æ•°
3. ä¸èƒ½ç»§æ‰¿é™¤æ¥å£å¤–çš„å…¶ä»–åˆçº¦
4. æ‰€æœ‰å‡½æ•°éƒ½å¿…é¡»æ˜¯externalä¸”ä¸èƒ½æœ‰å‡½æ•°ä½“
5. ç»§æ‰¿æ¥å£çš„åˆçº¦å¿…é¡»å®ç°æ¥å£å®šä¹‰çš„æ‰€æœ‰åŠŸèƒ½

è™½ç„¶æ¥å£ä¸å®ç°ä»»ä½•åŠŸèƒ½ï¼Œä½†å®ƒéå¸¸é‡è¦ã€‚æ¥å£æ˜¯æ™ºèƒ½åˆçº¦çš„éª¨æ¶ï¼Œå®šä¹‰äº†åˆçº¦çš„åŠŸèƒ½ä»¥åŠå¦‚ä½•è§¦å‘å®ƒä»¬ï¼šå¦‚æœæ™ºèƒ½åˆçº¦å®ç°äº†æŸç§æ¥å£ï¼ˆæ¯”å¦‚`ERC20`æˆ–`ERC721`ï¼‰ï¼Œå…¶ä»–Dappså’Œæ™ºèƒ½åˆçº¦å°±çŸ¥é“å¦‚ä½•ä¸å®ƒäº¤äº’ã€‚å› ä¸ºæ¥å£æä¾›äº†ä¸¤ä¸ªé‡è¦çš„ä¿¡æ¯ï¼š

1. åˆçº¦é‡Œæ¯ä¸ªå‡½æ•°çš„`bytes4`é€‰æ‹©å™¨ï¼Œä»¥åŠå‡½æ•°ç­¾å`å‡½æ•°å(æ¯ä¸ªå‚æ•°ç±»å‹ï¼‰`ã€‚
2. æ¥å£idï¼ˆæ›´å¤šä¿¡æ¯è§[EIP165](https://eips.ethereum.org/EIPS/eip-165)ï¼‰

å¦å¤–ï¼Œæ¥å£ä¸åˆçº¦`ABI`ï¼ˆApplication Binary Interfaceï¼‰ç­‰ä»·ï¼Œå¯ä»¥ç›¸äº’è½¬æ¢ï¼šç¼–è¯‘æ¥å£å¯ä»¥å¾—åˆ°åˆçº¦çš„`ABI`ï¼Œåˆ©ç”¨[abi-to-solå·¥å…·](https://gnidan.github.io/abi-to-sol/)ä¹Ÿå¯ä»¥å°†`ABI json`æ–‡ä»¶è½¬æ¢ä¸º`æ¥å£sol`æ–‡ä»¶ã€‚

æˆ‘ä»¬ä»¥`ERC721`æ¥å£åˆçº¦`IERC721`ä¸ºä¾‹ï¼Œå®ƒå®šä¹‰äº†3ä¸ª`event`å’Œ9ä¸ª`function`ï¼Œæ‰€æœ‰`ERC721`æ ‡å‡†çš„NFTéƒ½å®ç°äº†è¿™äº›å‡½æ•°ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¥å£å’Œå¸¸è§„åˆçº¦çš„åŒºåˆ«åœ¨äºæ¯ä¸ªå‡½æ•°éƒ½ä»¥`;`ä»£æ›¿å‡½æ•°ä½“`{ }`ç»“å°¾ã€‚

```solidity
interface IERC721 is IERC165 {
    event Transfer(address indexed from, address indexed to, uint256 indexed tokenId);
    event Approval(address indexed owner, address indexed approved, uint256 indexed tokenId);
    event ApprovalForAll(address indexed owner, address indexed operator, bool approved);
    
    function balanceOf(address owner) external view returns (uint256 balance);

    function ownerOf(uint256 tokenId) external view returns (address owner);

    function safeTransferFrom(address from, address to, uint256 tokenId) external;

    function transferFrom(address from, address to, uint256 tokenId) external;

    function approve(address to, uint256 tokenId) external;

    function getApproved(uint256 tokenId) external view returns (address operator);

    function setApprovalForAll(address operator, bool _approved) external;

    function isApprovedForAll(address owner, address operator) external view returns (bool);

    function safeTransferFrom( address from, address to, uint256 tokenId, bytes calldata data) external;
}
```



### 3.4.1 IERC721äº‹ä»¶

`IERC721`åŒ…å«3ä¸ªäº‹ä»¶ï¼Œå…¶ä¸­`Transfer`å’Œ`Approval`äº‹ä»¶åœ¨`ERC20`ä¸­ä¹Ÿæœ‰ã€‚

- `Transfer`äº‹ä»¶ï¼šåœ¨è½¬è´¦æ—¶è¢«é‡Šæ”¾ï¼Œè®°å½•ä»£å¸çš„å‘å‡ºåœ°å€`from`ï¼Œæ¥æ”¶åœ°å€`to`å’Œ`tokenid`ã€‚
- `Approval`äº‹ä»¶ï¼šåœ¨æˆæƒæ—¶é‡Šæ”¾ï¼Œè®°å½•æˆæƒåœ°å€`owner`ï¼Œè¢«æˆæƒåœ°å€`approved`å’Œ`tokenid`ã€‚
- `ApprovalForAll`äº‹ä»¶ï¼šåœ¨æ‰¹é‡æˆæƒæ—¶é‡Šæ”¾ï¼Œè®°å½•æ‰¹é‡æˆæƒçš„å‘å‡ºåœ°å€`owner`ï¼Œè¢«æˆæƒåœ°å€`operator`å’Œæˆæƒä¸å¦çš„`approved`ã€‚

### 3.4.2 IERC721å‡½æ•°

- `balanceOf`ï¼šè¿”å›æŸåœ°å€çš„NFTæŒæœ‰é‡`balance`ã€‚
- `ownerOf`ï¼šè¿”å›æŸ`tokenId`çš„ä¸»äºº`owner`ã€‚
- `transferFrom`ï¼šæ™®é€šè½¬è´¦ï¼Œå‚æ•°ä¸ºè½¬å‡ºåœ°å€`from`ï¼Œæ¥æ”¶åœ°å€`to`å’Œ`tokenId`ã€‚
- `safeTransferFrom`ï¼šå®‰å…¨è½¬è´¦ï¼ˆå¦‚æœæ¥æ”¶æ–¹æ˜¯åˆçº¦åœ°å€ï¼Œä¼šè¦æ±‚å®ç°`ERC721Receiver`æ¥å£ï¼‰ã€‚å‚æ•°ä¸ºè½¬å‡ºåœ°å€`from`ï¼Œæ¥æ”¶åœ°å€`to`å’Œ`tokenId`ã€‚
- `approve`ï¼šæˆæƒå¦ä¸€ä¸ªåœ°å€ä½¿ç”¨ä½ çš„NFTã€‚å‚æ•°ä¸ºè¢«æˆæƒåœ°å€`approve`å’Œ`tokenId`ã€‚
- `getApproved`ï¼šæŸ¥è¯¢`tokenId`è¢«æ‰¹å‡†ç»™äº†å“ªä¸ªåœ°å€ã€‚
- `setApprovalForAll`ï¼šå°†è‡ªå·±æŒæœ‰çš„è¯¥ç³»åˆ—NFTæ‰¹é‡æˆæƒç»™æŸä¸ªåœ°å€`operator`ã€‚
- `isApprovedForAll`ï¼šæŸ¥è¯¢æŸåœ°å€çš„NFTæ˜¯å¦æ‰¹é‡æˆæƒç»™äº†å¦ä¸€ä¸ª`operator`åœ°å€ã€‚
- `safeTransferFrom`ï¼šå®‰å…¨è½¬è´¦çš„é‡è½½å‡½æ•°ï¼Œå‚æ•°é‡Œé¢åŒ…å«äº†`data`ã€‚

### 3.4.3 ä»€ä¹ˆæ—¶å€™ä½¿ç”¨æ¥å£ï¼Ÿ

å¦‚æœæˆ‘ä»¬çŸ¥é“ä¸€ä¸ªåˆçº¦å®ç°äº†`IERC721`æ¥å£ï¼Œæˆ‘ä»¬ä¸éœ€è¦çŸ¥é“å®ƒå…·ä½“ä»£ç å®ç°ï¼Œå°±å¯ä»¥ä¸å®ƒäº¤äº’ã€‚

æ— èŠçŒ¿`BAYC`å±äº`ERC721`ä»£å¸ï¼Œå®ç°äº†`IERC721`æ¥å£çš„åŠŸèƒ½ã€‚æˆ‘ä»¬ä¸éœ€è¦çŸ¥é“å®ƒçš„æºä»£ç ï¼Œåªéœ€çŸ¥é“å®ƒçš„åˆçº¦åœ°å€ï¼Œç”¨`IERC721`æ¥å£å°±å¯ä»¥ä¸å®ƒäº¤äº’ï¼Œæ¯”å¦‚ç”¨`balanceOf()`æ¥æŸ¥è¯¢æŸä¸ªåœ°å€çš„`BAYC`ä½™é¢ï¼Œç”¨`safeTransferFrom()`æ¥è½¬è´¦`BAYC`ã€‚

```solidity
contract interactBAYC {
    // åˆ©ç”¨BAYCåœ°å€åˆ›å»ºæ¥å£åˆçº¦å˜é‡ï¼ˆETHä¸»ç½‘ï¼‰
    IERC721 BAYC = IERC721(0xBC4CA0EdA7647A8aB7C2061c2E118A18a936f13D);

    // é€šè¿‡æ¥å£è°ƒç”¨BAYCçš„balanceOf()æŸ¥è¯¢æŒä»“é‡
    function balanceOfBAYC(address owner) external view returns (uint256 balance){
        return BAYC.balanceOf(owner);
    }

    // é€šè¿‡æ¥å£è°ƒç”¨BAYCçš„safeTransferFrom()å®‰å…¨è½¬è´¦
    function safeTransferFromBAYC(address from, address to, uint256 tokenId) external{
        BAYC.safeTransferFrom(from, to, tokenId);
    }
}
```









# 4 é«˜é˜¶

## 4.1 å‡½æ•°é‡è½½

`solidity`ä¸­å…è®¸å‡½æ•°è¿›è¡Œé‡è½½ï¼ˆ`overloading`ï¼‰ï¼Œå³åå­—ç›¸åŒä½†è¾“å…¥å‚æ•°ç±»å‹ä¸åŒçš„å‡½æ•°å¯ä»¥åŒæ—¶å­˜åœ¨ï¼Œä»–ä»¬è¢«è§†ä¸ºä¸åŒçš„å‡½æ•°ã€‚æ³¨æ„ï¼Œ`solidity`ä¸å…è®¸ä¿®é¥°å™¨ï¼ˆ`modifier`ï¼‰é‡è½½ã€‚

### 4.1.1 å‡½æ•°é‡è½½

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸¤ä¸ªéƒ½å«`saySomething()`çš„å‡½æ•°ï¼Œä¸€ä¸ªæ²¡æœ‰ä»»ä½•å‚æ•°ï¼Œè¾“å‡º`"Nothing"`ï¼›å¦ä¸€ä¸ªæ¥æ”¶ä¸€ä¸ª`string`å‚æ•°ï¼Œè¾“å‡ºè¿™ä¸ª`string`ã€‚

```solidity
function saySomething() public pure returns(string memory){
    return("Nothing");
}

function saySomething(string memory something) public pure returns(string memory){
    return(something);
}
```

æœ€ç»ˆé‡è½½å‡½æ•°åœ¨ç»è¿‡ç¼–è¯‘å™¨ç¼–è¯‘åï¼Œç”±äºä¸åŒçš„å‚æ•°ç±»å‹ï¼Œéƒ½å˜æˆäº†ä¸åŒçš„å‡½æ•°é€‰æ‹©å™¨ï¼ˆselectorï¼‰ã€‚å…³äºå‡½æ•°é€‰æ‹©å™¨çš„å…·ä½“å†…å®¹å¯å‚è€ƒ[Solidityæç®€å…¥é—¨: 29. å‡½æ•°é€‰æ‹©å™¨Selector](https://github.com/AmazingAng/WTFSolidity/tree/main/29_Selector)ã€‚

### 4.1.2 å®å‚åŒ¹é…

åœ¨è°ƒç”¨é‡è½½å‡½æ•°æ—¶ï¼Œä¼šæŠŠè¾“å…¥çš„å®é™…å‚æ•°å’Œå‡½æ•°å‚æ•°çš„å˜é‡ç±»å‹åšåŒ¹é…ã€‚ å¦‚æœå‡ºç°å¤šä¸ªåŒ¹é…çš„é‡è½½å‡½æ•°ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­æœ‰ä¸¤ä¸ªå«`f()`çš„å‡½æ•°ï¼Œä¸€ä¸ªå‚æ•°ä¸º`uint8`ï¼Œå¦ä¸€ä¸ªä¸º`uint256`ï¼š

```solidity
    function f(uint8 _in) public pure returns (uint8 out) {
        out = _in;
    }

    function f(uint256 _in) public pure returns (uint256 out) {
        out = _in;
    }
```



æˆ‘ä»¬è°ƒç”¨`f(50)`ï¼Œå› ä¸º`50`æ—¢å¯ä»¥è¢«è½¬æ¢ä¸º`uint8`ï¼Œä¹Ÿå¯ä»¥è¢«è½¬æ¢ä¸º`uint256`ï¼Œå› æ­¤ä¼šæŠ¥é”™ã€‚



## 4.2 åº“åˆçº¦ï¼ˆlibraryï¼‰

### 4.2.1 åº“å‡½æ•°

åº“å‡½æ•°æ˜¯ä¸€ç§ç‰¹æ®Šçš„åˆçº¦ï¼Œä¸ºäº†æå‡`solidity`ä»£ç çš„å¤ç”¨æ€§å’Œå‡å°‘`gas`è€Œå­˜åœ¨ã€‚åº“åˆçº¦ä¸€èˆ¬éƒ½æ˜¯ä¸€äº›å¥½ç”¨çš„å‡½æ•°åˆé›†ï¼ˆ`åº“å‡½æ•°`ï¼‰ï¼Œç”±å¤§ç¥æˆ–è€…é¡¹ç›®æ–¹åˆ›ä½œï¼Œå’±ä»¬ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œä¼šç”¨å°±è¡Œäº†ã€‚

ä»–å’Œæ™®é€šåˆçº¦ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç‚¹ä¸åŒï¼š

1. ä¸èƒ½å­˜åœ¨çŠ¶æ€å˜é‡
2. ä¸èƒ½å¤Ÿç»§æ‰¿æˆ–è¢«ç»§æ‰¿
3. ä¸èƒ½æ¥æ”¶ä»¥å¤ªå¸
4. ä¸å¯ä»¥è¢«é”€æ¯

### 4.2.2 Stringåº“åˆçº¦

`Stringåº“åˆçº¦`æ˜¯å°†`uint256`ç±»å‹è½¬æ¢ä¸ºç›¸åº”çš„`string`ç±»å‹çš„ä»£ç åº“

ä»–ä¸»è¦åŒ…å«ä¸¤ä¸ªå‡½æ•°ï¼Œ`toString()`å°†`uint256`è½¬ä¸º`string`ï¼Œ`toHexString()`å°†`uint256`è½¬æ¢ä¸º`16è¿›åˆ¶`ï¼Œå†è½¬æ¢ä¸º`string`ã€‚

### 4.2.3 å¦‚ä½•ä½¿ç”¨åº“åˆçº¦

æˆ‘ä»¬ç”¨Stringåº“å‡½æ•°çš„toHexString()æ¥æ¼”ç¤ºä¸¤ç§ä½¿ç”¨åº“åˆçº¦ä¸­å‡½æ•°çš„åŠæ³•ã€‚

**1. åˆ©ç”¨using foræŒ‡ä»¤**

æŒ‡ä»¤`using A for B;`å¯ç”¨äºé™„åŠ åº“å‡½æ•°ï¼ˆä»åº“ Aï¼‰åˆ°ä»»ä½•ç±»å‹ï¼ˆBï¼‰ã€‚æ·»åŠ å®ŒæŒ‡ä»¤åï¼Œåº“`A`ä¸­çš„å‡½æ•°ä¼šè‡ªåŠ¨æ·»åŠ ä¸º`B`ç±»å‹å˜é‡çš„æˆå‘˜ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ã€‚æ³¨æ„ï¼šåœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œè¿™ä¸ªå˜é‡ä¼šè¢«å½“ä½œç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼š

```solidity
    // åˆ©ç”¨using foræŒ‡ä»¤
    using Strings for uint256;
    function getString1(uint256 _number) public pure returns(string memory){
        // åº“å‡½æ•°ä¼šè‡ªåŠ¨æ·»åŠ ä¸ºuint256å‹å˜é‡çš„æˆå‘˜
        return _number.toHexString();
    }
```



**2. é€šè¿‡åº“åˆçº¦åç§°è°ƒç”¨åº“å‡½æ•°**

```solidity
    // ç›´æ¥é€šè¿‡åº“åˆçº¦åè°ƒç”¨
    function getString2(uint256 _number) public pure returns(string memory){
        return Strings.toHexString(_number);
    }
```

### 4.2.4 å¸¸ç”¨çš„åº“åˆçº¦

è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ç”¨`ERC721`çš„å¼•ç”¨çš„åº“å‡½æ•°`String`ä¸ºä¾‹ä»‹ç»`solidity`ä¸­çš„åº“å‡½æ•°ï¼ˆ`Library`ï¼‰ã€‚99%çš„å¼€å‘è€…éƒ½ä¸éœ€è¦è‡ªå·±å»å†™åº“åˆçº¦ï¼Œä¼šç”¨å¤§ç¥å†™çš„å°±å¯ä»¥äº†ã€‚æˆ‘ä»¬åªéœ€è¦çŸ¥é“ä»€ä¹ˆæƒ…å†µè¯¥ç”¨ä»€ä¹ˆåº“åˆçº¦ã€‚å¸¸ç”¨çš„æœ‰ï¼š

1. [String](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/4a9cc8b4918ef3736229a5cc5a310bdc17bf759f/contracts/utils/Strings.sol)ï¼šå°†`uint256`è½¬æ¢ä¸º`String`
2. [Address](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/4a9cc8b4918ef3736229a5cc5a310bdc17bf759f/contracts/utils/Address.sol)ï¼šåˆ¤æ–­æŸä¸ªåœ°å€æ˜¯å¦ä¸ºåˆçº¦åœ°å€
3. [Create2](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/4a9cc8b4918ef3736229a5cc5a310bdc17bf759f/contracts/utils/Create2.sol)ï¼šæ›´å®‰å…¨çš„ä½¿ç”¨`Create2 EVM opcode`
4. [Arrays](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/4a9cc8b4918ef3736229a5cc5a310bdc17bf759f/contracts/utils/Arrays.sol)ï¼šè·Ÿæ•°ç»„ç›¸å…³çš„åº“å‡½æ•°



## 4.3 æ¥æ”¶ETH receive & fallback

`Solidity`æ”¯æŒä¸¤ç§ç‰¹æ®Šçš„å›è°ƒå‡½æ•°ï¼Œ`receive()`å’Œ`fallback()`ï¼Œä»–ä»¬ä¸»è¦åœ¨ä¸¤ç§æƒ…å†µä¸‹è¢«ä½¿ç”¨ï¼š

1. æ¥æ”¶ETH
2. å¤„ç†åˆçº¦ä¸­ä¸å­˜åœ¨çš„å‡½æ•°è°ƒç”¨ï¼ˆä»£ç†åˆçº¦proxy contractï¼‰

æ³¨æ„âš ï¸ï¼šåœ¨solidity 0.6.xç‰ˆæœ¬ä¹‹å‰ï¼Œè¯­æ³•ä¸Šåªæœ‰ `fallback()` å‡½æ•°ï¼Œç”¨æ¥æ¥æ”¶ç”¨æˆ·å‘é€çš„ETHæ—¶è°ƒç”¨ä»¥åŠåœ¨è¢«è°ƒç”¨å‡½æ•°ç­¾åæ²¡æœ‰åŒ¹é…åˆ°æ—¶ï¼Œæ¥è°ƒç”¨ã€‚ 0.6ç‰ˆæœ¬ä¹‹åï¼Œsolidityæ‰å°† `fallback()` å‡½æ•°æ‹†åˆ†æˆ `receive()` å’Œ `fallback()` ä¸¤ä¸ªå‡½æ•°ã€‚

æˆ‘ä»¬è¿™ä¸€è®²ä¸»è¦è®²æ¥æ”¶ETHçš„æƒ…å†µã€‚

### 4.3.1 æ¥æ”¶ETHå‡½æ•° receive

`receive()`åªç”¨äºå¤„ç†æ¥æ”¶`ETH`ã€‚ä¸€ä¸ªåˆçº¦æœ€å¤šæœ‰ä¸€ä¸ª`receive()`å‡½æ•°ï¼Œå£°æ˜æ–¹å¼ä¸ä¸€èˆ¬å‡½æ•°ä¸ä¸€æ ·ï¼Œä¸éœ€è¦`function`å…³é”®å­—ï¼š`receive() external payable { ... }`ã€‚`receive()`å‡½æ•°ä¸èƒ½æœ‰ä»»ä½•çš„å‚æ•°ï¼Œä¸èƒ½è¿”å›ä»»ä½•å€¼ï¼Œå¿…é¡»åŒ…å«`external`å’Œ`payable`ã€‚

å½“åˆçº¦æ¥æ”¶ETHçš„æ—¶å€™ï¼Œ`receive()`ä¼šè¢«è§¦å‘ã€‚`receive()`æœ€å¥½ä¸è¦æ‰§è¡Œå¤ªå¤šçš„é€»è¾‘å› ä¸ºå¦‚æœåˆ«äººç”¨`send`å’Œ`transfer`æ–¹æ³•å‘é€`ETH`çš„è¯ï¼Œ`gas`ä¼šé™åˆ¶åœ¨`2300`ï¼Œ`receive()`å¤ªå¤æ‚å¯èƒ½ä¼šè§¦å‘`Out of Gas`æŠ¥é”™ï¼›å¦‚æœç”¨`call`å°±å¯ä»¥è‡ªå®šä¹‰`gas`æ‰§è¡Œæ›´å¤æ‚çš„é€»è¾‘ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨`receive()`é‡Œå‘é€ä¸€ä¸ª`event`ï¼Œä¾‹å¦‚ï¼š

```solidity
    // å®šä¹‰äº‹ä»¶
    event Received(address Sender, uint Value);
    // æ¥æ”¶ETHæ—¶é‡Šæ”¾Receivedäº‹ä»¶
    receive() external payable {
        emit Received(msg.sender, msg.value);
    }
```



æœ‰äº›æ¶æ„åˆçº¦ï¼Œä¼šåœ¨`receive()` å‡½æ•°ï¼ˆè€ç‰ˆæœ¬çš„è¯ï¼Œå°±æ˜¯ `fallback()` å‡½æ•°ï¼‰åµŒå…¥æ¶æ„æ¶ˆè€—`gas`çš„å†…å®¹æˆ–è€…ä½¿å¾—æ‰§è¡Œæ•…æ„å¤±è´¥çš„ä»£ç ï¼Œå¯¼è‡´ä¸€äº›åŒ…å«é€€æ¬¾å’Œè½¬è´¦é€»è¾‘çš„åˆçº¦ä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œå› æ­¤å†™åŒ…å«é€€æ¬¾ç­‰é€»è¾‘çš„åˆçº¦æ—¶å€™ï¼Œä¸€å®šè¦æ³¨æ„è¿™ç§æƒ…å†µã€‚

### 4.3.1 å›é€€å‡½æ•° fallback

`fallback()`å‡½æ•°ä¼šåœ¨è°ƒç”¨åˆçº¦ä¸å­˜åœ¨çš„å‡½æ•°æ—¶è¢«è§¦å‘ã€‚å¯ç”¨äºæ¥æ”¶ETHï¼Œä¹Ÿå¯ä»¥ç”¨äºä»£ç†åˆçº¦`proxy contract`ã€‚`fallback()`å£°æ˜æ—¶ä¸éœ€è¦`function`å…³é”®å­—ï¼Œ**å¿…é¡»ç”±`external`ä¿®é¥°**ï¼Œä¸€èˆ¬ä¹Ÿä¼šç”¨`payable`ä¿®é¥°ï¼Œç”¨äºæ¥æ”¶ETH:`fallback() external payable { ... }`ã€‚

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ª`fallback()`å‡½æ•°ï¼Œè¢«è§¦å‘æ—¶å€™ä¼šé‡Šæ”¾`fallbackCalled`äº‹ä»¶ï¼Œå¹¶è¾“å‡º`msg.sender`ï¼Œ`msg.value`å’Œ`msg.data`:

```solidity
    // fallback
    fallback() external payable{
        emit fallbackCalled(msg.sender, msg.value, msg.data);
    }
```



### 4.3.3 æ€»ç»“

1ã€**receive**

> å‘é€äº¤æ˜“çš„æ—¶å€™åªè¦æ²¡æœ‰ä¸è¯¥äº¤æ˜“ç›¸å…³çš„æ•°æ®ï¼Œå°†è¢«è§¦å‘
>
> å½“å‘åˆçº¦å‘é€ä»¥å¤ªå¸æ—¶ï¼Œæˆ–è€…è°ƒç”¨åˆçº¦ä¸å­˜åœ¨çš„å‡½æ•°æ—¶ï¼Œå°±ä¼šè°ƒç”¨ `receive` å‡½æ•°æ¥å¤„ç†è¿™äº›ä»¥å¤ªå¸ã€‚

2ã€**fallback**

> ç”¨äºå¤„ç†å‘åˆçº¦å‘é€ä»¥å¤ªå¸æ—¶æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•å…¶ä»–å‡½æ•°è°ƒç”¨çš„æƒ…å†µã€‚
>
> ä» Solidity 0.6.0 ç‰ˆæœ¬å¼€å§‹ï¼Œ`fallback` å‡½æ•°è¢«æ ‡è®°ä¸ºå·²å¼ƒç”¨ï¼Œä¸å»ºè®®ç»§ç»­ä½¿ç”¨ã€‚

```solidity
    fallback() external payable {
        fund();
    }

    receive() external payable {
        fund();
    }
    
    // Explainer from: https://solidity-by-example.org/fallback/
    // Ether is sent to contract
    //      is msg.data empty?
    //          /   \ 
    //         yes  no
    //         /     \
    //    receive()?  fallback() 
    //     /   \ 
    //   yes   no
    //  /        \
    //receive()  fallback()

```

## 4.4 å‘é€ETH

`Solidity`æœ‰ä¸‰ç§æ–¹æ³•å‘å…¶ä»–åˆçº¦å‘é€`ETH`ï¼Œä»–ä»¬æ˜¯ï¼š`transfer()`ï¼Œ`send()`å’Œ`call()`ï¼Œå…¶ä¸­`call()`æ˜¯è¢«é¼“åŠ±çš„ç”¨æ³•ã€‚

**æ¥æ”¶ETHåˆçº¦**

æˆ‘ä»¬å…ˆéƒ¨ç½²ä¸€ä¸ªæ¥æ”¶`ETH`åˆçº¦`ReceiveETH`ã€‚`ReceiveETH`åˆçº¦é‡Œæœ‰ä¸€ä¸ªäº‹ä»¶`Log`ï¼Œè®°å½•æ”¶åˆ°çš„`ETH`æ•°é‡å’Œ`gas`å‰©ä½™ã€‚è¿˜æœ‰ä¸¤ä¸ªå‡½æ•°ï¼Œä¸€ä¸ªæ˜¯`receive()`å‡½æ•°ï¼Œæ”¶åˆ°`ETH`è¢«è§¦å‘ï¼Œå¹¶å‘é€`Log`äº‹ä»¶ï¼›å¦ä¸€ä¸ªæ˜¯æŸ¥è¯¢åˆçº¦`ETH`ä½™é¢çš„`getBalance()`å‡½æ•°ã€‚

```solidity
contract ReceiveETH {
    // æ”¶åˆ°ethäº‹ä»¶ï¼Œè®°å½•amountå’Œgas
    event Log(uint amount, uint gas);
    
    // receiveæ–¹æ³•ï¼Œæ¥æ”¶ethæ—¶è¢«è§¦å‘
    receive() external payable{
        emit Log(msg.value, gasleft());
    }
    
    // è¿”å›åˆçº¦ETHä½™é¢
    function getBalance() view public returns(uint) {
        return address(this).balance;
    }
}
```

éƒ¨ç½²`ReceiveETH`åˆçº¦åï¼Œè¿è¡Œ`getBalance()`å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰åˆçº¦çš„`ETH`ä½™é¢ä¸º`0`ã€‚

**å‘é€ETHåˆçº¦**

æˆ‘ä»¬å°†å®ç°ä¸‰ç§æ–¹æ³•å‘`ReceiveETH`åˆçº¦å‘é€`ETH`ã€‚é¦–å…ˆï¼Œå…ˆåœ¨å‘é€ETHåˆçº¦`SendETH`ä¸­å®ç°`payable`çš„`æ„é€ å‡½æ•°`å’Œ`receive()`ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨éƒ¨ç½²æ—¶å’Œéƒ¨ç½²åå‘åˆçº¦è½¬è´¦ã€‚

```solidity
contract SendETH {
    // æ„é€ å‡½æ•°ï¼Œpayableä½¿å¾—éƒ¨ç½²çš„æ—¶å€™å¯ä»¥è½¬ethè¿›å»
    constructor() payable{}
    // receiveæ–¹æ³•ï¼Œæ¥æ”¶ethæ—¶è¢«è§¦å‘
    receive() external payable{}
}
```



### 4.4.1 transfer

- ç”¨æ³•æ˜¯`æ¥æ”¶æ–¹åœ°å€.transfer(å‘é€ETHæ•°é¢)`ã€‚
- `transfer()`çš„`gas`é™åˆ¶æ˜¯`2300`ï¼Œè¶³å¤Ÿç”¨äºè½¬è´¦ï¼Œä½†å¯¹æ–¹åˆçº¦çš„`fallback()`æˆ–`receive()`å‡½æ•°ä¸èƒ½å®ç°å¤ªå¤æ‚çš„é€»è¾‘ã€‚
- `transfer()`å¦‚æœè½¬è´¦å¤±è´¥ï¼Œä¼šè‡ªåŠ¨`revert`ï¼ˆå›æ»šäº¤æ˜“ï¼‰ã€‚

ä»£ç æ ·ä¾‹ï¼Œæ³¨æ„é‡Œé¢çš„`_to`å¡«`ReceiveETH`åˆçº¦çš„åœ°å€ï¼Œ`amount`æ˜¯`ETH`è½¬è´¦é‡‘é¢ï¼š

```solidity
// ç”¨transfer()å‘é€ETH
function transferETH(address payable _to, uint256 amount) external payable{
    _to.transfer(amount);
}
```

éƒ¨ç½²`SendETH`åˆçº¦åï¼Œå¯¹`ReceiveETH`åˆçº¦å‘é€ETHï¼Œæ­¤æ—¶`amount`ä¸º10ï¼Œ`value`ä¸º0ï¼Œ`amount`>`value`ï¼Œè½¬è´¦å¤±è´¥ï¼Œå‘ç”Ÿ`revert`ã€‚





### 4.4.2 send

- ç”¨æ³•æ˜¯`æ¥æ”¶æ–¹åœ°å€.send(å‘é€ETHæ•°é¢)`ã€‚
- `send()`çš„`gas`é™åˆ¶æ˜¯`2300`ï¼Œè¶³å¤Ÿç”¨äºè½¬è´¦ï¼Œä½†å¯¹æ–¹åˆçº¦çš„`fallback()`æˆ–`receive()`å‡½æ•°ä¸èƒ½å®ç°å¤ªå¤æ‚çš„é€»è¾‘ã€‚
- `send()`å¦‚æœè½¬è´¦å¤±è´¥ï¼Œä¸ä¼š`revert`ã€‚
- `send()`çš„è¿”å›å€¼æ˜¯`bool`ï¼Œä»£è¡¨ç€è½¬è´¦æˆåŠŸæˆ–å¤±è´¥ï¼Œéœ€è¦é¢å¤–ä»£ç å¤„ç†ä¸€ä¸‹ã€‚

ä»£ç æ ·ä¾‹ï¼š

```solidity
// send()å‘é€ETH
function sendETH(address payable _to, uint256 amount) external payable{
    // å¤„ç†ä¸‹sendçš„è¿”å›å€¼ï¼Œå¦‚æœå¤±è´¥ï¼Œrevertäº¤æ˜“å¹¶å‘é€error
    bool success = _to.send(amount);
    if(!success){
        revert SendFailed();
    }
}
```

å¯¹`ReceiveETH`åˆçº¦å‘é€ETHï¼Œæ­¤æ—¶`amount`ä¸º10ï¼Œ`value`ä¸º0ï¼Œ`amount`>`value`ï¼Œè½¬è´¦å¤±è´¥ï¼Œå› ä¸ºç»è¿‡å¤„ç†ï¼Œæ‰€ä»¥å‘ç”Ÿ`revert`ã€‚



### 4.4.3 call

- ç”¨æ³•æ˜¯`æ¥æ”¶æ–¹åœ°å€.call{value: å‘é€ETHæ•°é¢}("")`ã€‚
- `call()`æ²¡æœ‰`gas`é™åˆ¶ï¼Œå¯ä»¥æ”¯æŒå¯¹æ–¹åˆçº¦`fallback()`æˆ–`receive()`å‡½æ•°å®ç°å¤æ‚é€»è¾‘ã€‚
- `call()`å¦‚æœè½¬è´¦å¤±è´¥ï¼Œä¸ä¼š`revert`ã€‚
- `call()`çš„è¿”å›å€¼æ˜¯`(bool, data)`ï¼Œå…¶ä¸­`bool`ä»£è¡¨ç€è½¬è´¦æˆåŠŸæˆ–å¤±è´¥ï¼Œéœ€è¦é¢å¤–ä»£ç å¤„ç†ä¸€ä¸‹ã€‚

ä»£ç æ ·ä¾‹ï¼š

```solidity
// call()å‘é€ETH
function callETH(address payable _to, uint256 amount) external payable{
    // å¤„ç†ä¸‹callçš„è¿”å›å€¼ï¼Œå¦‚æœå¤±è´¥ï¼Œrevertäº¤æ˜“å¹¶å‘é€error
    (bool success,) = _to.call{value: amount}("");
    if(!success){
        revert CallFailed();
    }
}
```

å¯¹`ReceiveETH`åˆçº¦å‘é€ETHï¼Œæ­¤æ—¶`amount`ä¸º10ï¼Œ`value`ä¸º0ï¼Œ`amount`>`value`ï¼Œè½¬è´¦å¤±è´¥ï¼Œå› ä¸ºç»è¿‡å¤„ç†ï¼Œæ‰€ä»¥å‘ç”Ÿ`revert`ã€‚





### 4.4.4 æ€»ç»“

è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä»‹ç»`solidity`ä¸‰ç§å‘é€`ETH`çš„æ–¹æ³•ï¼š`transfer`ï¼Œ`send`å’Œ`call`ã€‚

- `call`æ²¡æœ‰`gas`é™åˆ¶ï¼Œæœ€ä¸ºçµæ´»ï¼Œæ˜¯æœ€æå€¡çš„æ–¹æ³•ï¼›
- `transfer`æœ‰`2300 gas`é™åˆ¶ï¼Œä½†æ˜¯å‘é€å¤±è´¥ä¼šè‡ªåŠ¨`revert`äº¤æ˜“ï¼Œæ˜¯æ¬¡ä¼˜é€‰æ‹©ï¼›
- `send`æœ‰`2300 gas`é™åˆ¶ï¼Œè€Œä¸”å‘é€å¤±è´¥ä¸ä¼šè‡ªåŠ¨`revert`äº¤æ˜“ï¼Œå‡ ä¹æ²¡æœ‰äººç”¨å®ƒã€‚





## 4.5 è°ƒç”¨å…¶ä»–åˆçº¦

### 4.5.1 è°ƒç”¨å·²éƒ¨ç½²åˆçº¦

å¼€å‘è€…å†™æ™ºèƒ½åˆçº¦æ¥è°ƒç”¨å…¶ä»–åˆçº¦ï¼Œè¿™è®©ä»¥å¤ªåŠç½‘ç»œä¸Šçš„ç¨‹åºå¯ä»¥å¤ç”¨ï¼Œä»è€Œå»ºç«‹ç¹è£çš„ç”Ÿæ€ã€‚å¾ˆå¤š`web3`é¡¹ç›®ä¾èµ–äºè°ƒç”¨å…¶ä»–åˆçº¦ï¼Œæ¯”å¦‚æ”¶ç›Šå†œåœºï¼ˆ`yield farming`ï¼‰ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä»‹ç»å¦‚ä½•åœ¨å·²çŸ¥åˆçº¦ä»£ç ï¼ˆæˆ–æ¥å£ï¼‰å’Œåœ°å€æƒ…å†µä¸‹è°ƒç”¨ç›®æ ‡åˆçº¦çš„å‡½æ•°ã€‚

### 4.5.2 ç›®æ ‡åˆçº¦

æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç®€å•çš„åˆçº¦`OtherContract`æ¥è°ƒç”¨ã€‚

```solidity
contract OtherContract {
    uint256 private _x = 0; // çŠ¶æ€å˜é‡_x
    // æ”¶åˆ°ethçš„äº‹ä»¶ï¼Œè®°å½•amountå’Œgas
    event Log(uint amount, uint gas);
    
    // è¿”å›åˆçº¦ETHä½™é¢
    function getBalance() view public returns(uint) {
        return address(this).balance;
    }

    // å¯ä»¥è°ƒæ•´çŠ¶æ€å˜é‡_xçš„å‡½æ•°ï¼Œå¹¶ä¸”å¯ä»¥å¾€åˆçº¦è½¬ETH (payable)
    function setX(uint256 x) external payable{
        _x = x;
        // å¦‚æœè½¬å…¥ETHï¼Œåˆ™é‡Šæ”¾Logäº‹ä»¶
        if(msg.value > 0){
            emit Log(msg.value, gasleft());
        }
    }

    // è¯»å–_x
    function getX() external view returns(uint x){
        x = _x;
    }
}
```



è¿™ä¸ªåˆçº¦åŒ…å«ä¸€ä¸ªçŠ¶æ€å˜é‡`_x`ï¼Œä¸€ä¸ªäº‹ä»¶`Log`åœ¨æ”¶åˆ°`ETH`æ—¶è§¦å‘ï¼Œä¸‰ä¸ªå‡½æ•°ï¼š

- `getBalance()`: è¿”å›åˆçº¦`ETH`ä½™é¢ã€‚
- `setX()`: `external payable`å‡½æ•°ï¼Œå¯ä»¥è®¾ç½®`_x`çš„å€¼ï¼Œå¹¶å‘åˆçº¦å‘é€`ETH`ã€‚
- `getX()`: è¯»å–`_x`çš„å€¼ã€‚

### 4.5.3 è°ƒç”¨åˆçº¦

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨åˆçº¦çš„åœ°å€å’Œåˆçº¦ä»£ç ï¼ˆæˆ–æ¥å£ï¼‰æ¥åˆ›å»ºåˆçº¦çš„å¼•ç”¨ï¼š`_Name(_Address)`ï¼Œå…¶ä¸­`_Name`æ˜¯åˆçº¦åï¼Œ`_Address`æ˜¯åˆçº¦åœ°å€ã€‚ç„¶åç”¨åˆçº¦çš„å¼•ç”¨æ¥è°ƒç”¨å®ƒçš„å‡½æ•°ï¼š`_Name(_Address).f()`ï¼Œå…¶ä¸­`f()`æ˜¯è¦è°ƒç”¨çš„å‡½æ•°ã€‚

è°ƒç”¨`OtherContract`åˆçº¦æ­¥éª¤å¦‚ä¸‹ï¼š



ä¸‹é¢æˆ‘ä»¬ä»‹ç»4ä¸ªè°ƒç”¨åˆçº¦çš„ä¾‹å­ï¼Œåœ¨remixä¸­ç¼–è¯‘åˆçº¦åï¼Œåˆ†åˆ«éƒ¨ç½²`OtherContract`å’Œ`CallContract`ï¼š



#### 4.5.3.1 ä¼ å…¥åˆçº¦åœ°å€

æˆ‘ä»¬å¯ä»¥åœ¨å‡½æ•°é‡Œä¼ å…¥ç›®æ ‡åˆçº¦åœ°å€ï¼Œç”Ÿæˆç›®æ ‡åˆçº¦çš„å¼•ç”¨ï¼Œç„¶åè°ƒç”¨ç›®æ ‡å‡½æ•°ã€‚ä»¥è°ƒç”¨`OtherContract`åˆçº¦çš„`setX`å‡½æ•°ä¸ºä¾‹ï¼Œæˆ‘ä»¬åœ¨æ–°åˆçº¦ä¸­å†™ä¸€ä¸ª`callSetX`å‡½æ•°ï¼Œä¼ å…¥å·²éƒ¨ç½²å¥½çš„`OtherContract`åˆçº¦åœ°å€`_Address`å’Œ`setX`çš„å‚æ•°`x`ï¼š

```solidity
    function callSetX(address _Address, uint256 x) external{
        OtherContract(_Address).setX(x);
    }
```

å¤åˆ¶`OtherContract`åˆçº¦çš„åœ°å€ï¼Œå¡«å…¥`callSetX`å‡½æ•°çš„å‚æ•°ä¸­ï¼ŒæˆåŠŸè°ƒç”¨åï¼Œè°ƒç”¨`OtherContract`åˆçº¦ä¸­çš„`getX`éªŒè¯`x`å˜ä¸º123

#### 4.5.3.2 ä¼ å…¥åˆçº¦å˜é‡

æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å‡½æ•°é‡Œä¼ å…¥åˆçº¦çš„å¼•ç”¨ï¼Œåªéœ€è¦æŠŠä¸Šé¢å‚æ•°çš„`address`ç±»å‹æ”¹ä¸ºç›®æ ‡åˆçº¦åï¼Œæ¯”å¦‚`OtherContract`ã€‚ä¸‹é¢ä¾‹å­å®ç°äº†è°ƒç”¨ç›®æ ‡åˆçº¦çš„`getX()`å‡½æ•°ã€‚

**æ³¨æ„**è¯¥å‡½æ•°å‚æ•°`OtherContract _Address`åº•å±‚ç±»å‹ä»ç„¶æ˜¯`address`ï¼Œç”Ÿæˆçš„`ABI`ä¸­ã€è°ƒç”¨`callGetX`æ—¶ä¼ å…¥çš„å‚æ•°éƒ½æ˜¯`address`ç±»å‹

```solidity
    function callGetX(OtherContract _Address) external view returns(uint x){
        x = _Address.getX();
    }
```

å¤åˆ¶`OtherContract`åˆçº¦çš„åœ°å€ï¼Œå¡«å…¥`callGetX`å‡½æ•°çš„å‚æ•°ä¸­ï¼Œè°ƒç”¨åæˆåŠŸè·å–`x`çš„å€¼



#### 4.5.3.3 åˆ›å»ºåˆçº¦å˜é‡

æˆ‘ä»¬å¯ä»¥åˆ›å»ºåˆçº¦å˜é‡ï¼Œç„¶åé€šè¿‡å®ƒæ¥è°ƒç”¨ç›®æ ‡å‡½æ•°ã€‚ä¸‹é¢ä¾‹å­ï¼Œæˆ‘ä»¬ç»™å˜é‡`oc`å­˜å‚¨äº†`OtherContract`åˆçº¦çš„å¼•ç”¨ï¼š

```solidity
    function callGetX2(address _Address) external view returns(uint x){
        OtherContract oc = OtherContract(_Address);
        x = oc.getX();
    }
```

å¤åˆ¶`OtherContract`åˆçº¦çš„åœ°å€ï¼Œå¡«å…¥`callGetX2`å‡½æ•°çš„å‚æ•°ä¸­ï¼Œè°ƒç”¨åæˆåŠŸè·å–`x`çš„å€¼



#### 4.5.3.4 è°ƒç”¨åˆçº¦å¹¶å‘é€`ETH`

å¦‚æœç›®æ ‡åˆçº¦çš„å‡½æ•°æ˜¯`payable`çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨å®ƒæ¥ç»™åˆçº¦è½¬è´¦ï¼š`_Name(_Address).f{value: _Value}()`ï¼Œå…¶ä¸­`_Name`æ˜¯åˆçº¦åï¼Œ`_Address`æ˜¯åˆçº¦åœ°å€ï¼Œ`f`æ˜¯ç›®æ ‡å‡½æ•°åï¼Œ`_Value`æ˜¯è¦è½¬çš„`ETH`æ•°é¢ï¼ˆä»¥`wei`ä¸ºå•ä½ï¼‰ã€‚

`OtherContract`åˆçº¦çš„`setX`å‡½æ•°æ˜¯`payable`çš„ï¼Œåœ¨ä¸‹é¢è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬é€šè¿‡è°ƒç”¨`setX`æ¥å¾€ç›®æ ‡åˆçº¦è½¬è´¦ã€‚

```solidity
    function setXTransferETH(address otherContract, uint256 x) payable external{
        OtherContract(otherContract).setX{value: msg.value}(x);
    }
```

å¤åˆ¶`OtherContract`åˆçº¦çš„åœ°å€ï¼Œå¡«å…¥`setXTransferETH`å‡½æ•°çš„å‚æ•°ä¸­ï¼Œå¹¶è½¬å…¥10ETH

> è¿™é‡Œå‘é€åˆçº¦çš„åŸå› æ˜¯ï¼š
>
> å°½ç®¡æ²¡æœ‰æ˜¾å¼ä½¿ç”¨ `address.transfer` æˆ– `address.send`ï¼Œä½†æ˜¯ Solidity çš„å‡½æ•°è°ƒç”¨æœºåˆ¶ä¸­ï¼Œå½“è°ƒç”¨ä¸€ä¸ª `payable` å‡½æ•°å¹¶æŒ‡å®š `{value: msg.value}` æ—¶ï¼Œå®è´¨ä¸Šæ˜¯æ‰§è¡Œäº†ä½çº§åˆ«çš„ `CALL` æ“ä½œï¼Œå°† ETH è½¬å‘åˆ°äº†ç›®æ ‡åˆçº¦çš„å‡½æ•°ã€‚
>
> `OtherContract(otherContract).setX{value: msg.value}(x);`:
>
> - `OtherContract` æ˜¯ç›®æ ‡åˆçº¦çš„ç±»å‹ï¼ˆå‡è®¾ `OtherContract` æ˜¯ä¸€ä¸ªå®šä¹‰å¥½çš„åˆçº¦æ¥å£ï¼‰ã€‚
> - `otherContract` æ˜¯ç›®æ ‡åˆçº¦çš„åœ°å€ã€‚
> - `setX` æ˜¯ç›®æ ‡åˆçº¦ä¸­çš„å‡½æ•°ã€‚
> - `{value: msg.value}`ï¼šå°†å½“å‰åˆçº¦æ¥æ”¶åˆ°çš„ ETHï¼ˆ`msg.value`ï¼‰ä¼ é€’ç»™ç›®æ ‡åˆçº¦çš„ `setX` å‡½æ•°ã€‚
> - `(x)`ï¼šä¼ é€’å‚æ•° `x` ç»™ç›®æ ‡åˆçº¦çš„ `setX` å‡½æ•°ã€‚
>
> ```solidity
> (bool success, ) = otherContract.call{value: msg.value}(abi.encodeWithSignature("setX(uint256)", x));
> require(success, "Call failed");
> ```
>
> è¿™ä¸¤ä¸ªæ˜¯ç›¸ç­‰çš„



## 4.6 Call

`call` æ˜¯`address`ç±»å‹çš„ä½çº§æˆå‘˜å‡½æ•°ï¼Œå®ƒç”¨æ¥ä¸å…¶ä»–åˆçº¦äº¤äº’ã€‚å®ƒçš„è¿”å›å€¼ä¸º`(bool, data)`ï¼Œåˆ†åˆ«å¯¹åº”`call`æ˜¯å¦æˆåŠŸä»¥åŠç›®æ ‡å‡½æ•°çš„è¿”å›å€¼ã€‚

- `call`æ˜¯`solidity`å®˜æ–¹æ¨èçš„é€šè¿‡è§¦å‘`fallback`æˆ–`receive`å‡½æ•°å‘é€`ETH`çš„æ–¹æ³•ã€‚
- ä¸æ¨èç”¨`call`æ¥è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦ï¼Œå› ä¸ºå½“ä½ è°ƒç”¨ä¸å®‰å…¨åˆçº¦çš„å‡½æ•°æ—¶ï¼Œä½ å°±æŠŠä¸»åŠ¨æƒäº¤ç»™äº†å®ƒã€‚æ¨èçš„æ–¹æ³•ä»æ˜¯å£°æ˜åˆçº¦å˜é‡åè°ƒç”¨å‡½æ•°ï¼Œè§[ç¬¬21è®²ï¼šè°ƒç”¨å…¶ä»–åˆçº¦](https://github.com/AmazingAng/WTFSolidity/tree/main/21_CallContract)
- å½“æˆ‘ä»¬ä¸çŸ¥é“å¯¹æ–¹åˆçº¦çš„æºä»£ç æˆ–`ABI`ï¼Œå°±æ²¡æ³•ç”Ÿæˆåˆçº¦å˜é‡ï¼›è¿™æ—¶ï¼Œæˆ‘ä»¬ä»å¯ä»¥é€šè¿‡`call`è°ƒç”¨å¯¹æ–¹åˆçº¦çš„å‡½æ•°ã€‚

### 4.6.1 `call`çš„ä½¿ç”¨è§„åˆ™

`call`çš„ä½¿ç”¨è§„åˆ™å¦‚ä¸‹ï¼š

```text
ç›®æ ‡åˆçº¦åœ°å€.call(äºŒè¿›åˆ¶ç¼–ç );
```

å…¶ä¸­`äºŒè¿›åˆ¶ç¼–ç `åˆ©ç”¨ç»“æ„åŒ–ç¼–ç å‡½æ•°`abi.encodeWithSignature`è·å¾—ï¼š

```text
abi.encodeWithSignature("å‡½æ•°ç­¾å", é€—å·åˆ†éš”çš„å…·ä½“å‚æ•°)
```

`å‡½æ•°ç­¾å`ä¸º`"å‡½æ•°åï¼ˆé€—å·åˆ†éš”çš„å‚æ•°ç±»å‹)"`ã€‚ä¾‹å¦‚`abi.encodeWithSignature("f(uint256,address)", _x, _addr)`ã€‚

å¦å¤–`call`åœ¨è°ƒç”¨åˆçº¦æ—¶å¯ä»¥æŒ‡å®šäº¤æ˜“å‘é€çš„`ETH`æ•°é¢å’Œ`gas`ï¼š

```text
ç›®æ ‡åˆçº¦åœ°å€.call{value:å‘é€æ•°é¢, gas:gasæ•°é¢}(äºŒè¿›åˆ¶ç¼–ç );
```

çœ‹èµ·æ¥æœ‰ç‚¹å¤æ‚ï¼Œä¸‹é¢æˆ‘ä»¬ä¸¾ä¸ª`call`åº”ç”¨çš„ä¾‹å­ã€‚

### 4.6.2 ç›®æ ‡åˆçº¦

æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç®€å•çš„ç›®æ ‡åˆçº¦`OtherContract`å¹¶éƒ¨ç½²ï¼Œå¤šäº†`fallback`

```solidity
contract OtherContract {
    uint256 private _x = 0; // çŠ¶æ€å˜é‡x
    // æ”¶åˆ°ethçš„äº‹ä»¶ï¼Œè®°å½•amountå’Œgas
    event Log(uint amount, uint gas);
    
    fallback() external payable{}

    // è¿”å›åˆçº¦ETHä½™é¢
    function getBalance() view public returns(uint) {
        return address(this).balance;
    }

    // å¯ä»¥è°ƒæ•´çŠ¶æ€å˜é‡_xçš„å‡½æ•°ï¼Œå¹¶ä¸”å¯ä»¥å¾€åˆçº¦è½¬ETH (payable)
    function setX(uint256 x) external payable{
        _x = x;
        // å¦‚æœè½¬å…¥ETHï¼Œåˆ™é‡Šæ”¾Logäº‹ä»¶
        if(msg.value > 0){
            emit Log(msg.value, gasleft());
        }
    }

    // è¯»å–x
    function getX() external view returns(uint x){
        x = _x;
    }
}
```

è¿™ä¸ªåˆçº¦åŒ…å«ä¸€ä¸ªçŠ¶æ€å˜é‡`x`ï¼Œä¸€ä¸ªåœ¨æ”¶åˆ°`ETH`æ—¶è§¦å‘çš„äº‹ä»¶`Log`ï¼Œä¸‰ä¸ªå‡½æ•°ï¼š

- `getBalance()`: è¿”å›åˆçº¦`ETH`ä½™é¢ã€‚
- `setX()`: `external payable`å‡½æ•°ï¼Œå¯ä»¥è®¾ç½®`x`çš„å€¼ï¼Œå¹¶å‘åˆçº¦å‘é€`ETH`ã€‚
- `getX()`: è¯»å–`x`çš„å€¼ã€‚

### 4.6.3 åˆ©ç”¨`call`è°ƒç”¨ç›®æ ‡åˆçº¦

**1. Responseäº‹ä»¶**

æˆ‘ä»¬å†™ä¸€ä¸ª`Call`åˆçº¦æ¥è°ƒç”¨ç›®æ ‡åˆçº¦å‡½æ•°ã€‚é¦–å…ˆå®šä¹‰ä¸€ä¸ª`Response`äº‹ä»¶ï¼Œè¾“å‡º`call`è¿”å›çš„`success`å’Œ`data`ï¼Œæ–¹ä¾¿æˆ‘ä»¬è§‚å¯Ÿè¿”å›å€¼ã€‚

```solidity
// å®šä¹‰Responseäº‹ä»¶ï¼Œè¾“å‡ºcallè¿”å›çš„ç»“æœsuccesså’Œdata
event Response(bool success, bytes data);
```



**2. è°ƒç”¨setXå‡½æ•°**

æˆ‘ä»¬å®šä¹‰`callSetX`å‡½æ•°æ¥è°ƒç”¨ç›®æ ‡åˆçº¦çš„`setX()`ï¼Œè½¬å…¥`msg.value`æ•°é¢çš„`ETH`ï¼Œå¹¶é‡Šæ”¾`Response`äº‹ä»¶è¾“å‡º`success`å’Œ`data`ï¼š

```solidity
function callSetX(address payable _addr, uint256 x) public payable {
    // call setX()ï¼ŒåŒæ—¶å¯ä»¥å‘é€ETH
    (bool success, bytes memory data) = _addr.call{value: msg.value}(
        abi.encodeWithSignature("setX(uint256)", x)
    );

    emit Response(success, data); //é‡Šæ”¾äº‹ä»¶
}
```



æ¥ä¸‹æ¥æˆ‘ä»¬è°ƒç”¨`callSetX`æŠŠçŠ¶æ€å˜é‡`_x`æ”¹ä¸º5ï¼Œå‚æ•°ä¸º`OtherContract`åœ°å€å’Œ`5`ï¼Œç”±äºç›®æ ‡å‡½æ•°`setX()`æ²¡æœ‰è¿”å›å€¼ï¼Œå› æ­¤`Response`äº‹ä»¶è¾“å‡ºçš„`data`ä¸º`0x`ï¼Œä¹Ÿå°±æ˜¯ç©ºã€‚

**3. è°ƒç”¨getXå‡½æ•°**

ä¸‹é¢æˆ‘ä»¬è°ƒç”¨`getX()`å‡½æ•°ï¼Œå®ƒå°†è¿”å›ç›®æ ‡åˆçº¦`_x`çš„å€¼ï¼Œç±»å‹ä¸º`uint256`ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨`abi.decode`æ¥è§£ç `call`çš„è¿”å›å€¼`data`ï¼Œå¹¶è¯»å‡ºæ•°å€¼ã€‚

```solidity
function callGetX(address _addr) external returns(uint256){
    // call getX()
    (bool success, bytes memory data) = _addr.call(
        abi.encodeWithSignature("getX()")
    );

    emit Response(success, data); //é‡Šæ”¾äº‹ä»¶
    return abi.decode(data, (uint256));
}
```



ä»`Response`äº‹ä»¶çš„è¾“å‡ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`data`ä¸º`0x0000000000000000000000000000000000000000000000000000000000000005`ã€‚è€Œç»è¿‡`abi.decode`ï¼Œæœ€ç»ˆè¿”å›å€¼ä¸º`5`ã€‚

**4. è°ƒç”¨ä¸å­˜åœ¨çš„å‡½æ•°**

å¦‚æœæˆ‘ä»¬ç»™`call`è¾“å…¥çš„å‡½æ•°ä¸å­˜åœ¨äºç›®æ ‡åˆçº¦ï¼Œé‚£ä¹ˆç›®æ ‡åˆçº¦çš„`fallback`å‡½æ•°ä¼šè¢«è§¦å‘ã€‚

```solidity
function callNonExist(address _addr) external{
    // call getX()
    (bool success, bytes memory data) = _addr.call(
        abi.encodeWithSignature("foo(uint256)")
    );

    emit Response(success, data); //é‡Šæ”¾äº‹ä»¶
}
```



ä¸Šé¢ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬`call`äº†ä¸å­˜åœ¨çš„`foo`å‡½æ•°ã€‚`call`ä»èƒ½æ‰§è¡ŒæˆåŠŸï¼Œå¹¶è¿”å›`success`ï¼Œä½†å…¶å®è°ƒç”¨çš„ç›®æ ‡åˆçº¦`fallback`å‡½æ•°ã€‚

### 4.6.4 æ€»ç»“

è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ç”¨`call`è¿™ä¸€ä½çº§å‡½æ•°æ¥è°ƒç”¨å…¶ä»–åˆçº¦ã€‚`call`**ä¸æ˜¯è°ƒç”¨åˆçº¦çš„æ¨èæ–¹æ³•**ï¼Œå› ä¸ºä¸å®‰å…¨ã€‚ä½†ä»–èƒ½è®©æˆ‘ä»¬åœ¨ä¸çŸ¥é“æºä»£ç å’Œ`ABI`çš„æƒ…å†µä¸‹è°ƒç”¨ç›®æ ‡åˆçº¦ï¼Œå¾ˆæœ‰ç”¨ã€‚

æ¨è4.5 å£°æ˜åˆçº¦å˜é‡åè°ƒç”¨å‡½æ•°



## 4.7 Delegatecall

`delegatecall`ä¸`call`ç±»ä¼¼ï¼Œæ˜¯`solidity`ä¸­åœ°å€ç±»å‹çš„ä½çº§æˆå‘˜å‡½æ•°ã€‚`delegate`ä¸­æ˜¯å§”æ‰˜/ä»£è¡¨çš„æ„æ€ï¼Œé‚£ä¹ˆ`delegatecall`å§”æ‰˜äº†ä»€ä¹ˆï¼Ÿ

å½“ç”¨æˆ·`A`é€šè¿‡åˆçº¦`B`æ¥`call`åˆçº¦`C`çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„æ˜¯åˆçº¦`C`çš„å‡½æ•°ï¼Œ`è¯­å¢ƒ`(`Context`ï¼Œå¯ä»¥ç†è§£ä¸ºåŒ…å«å˜é‡å’ŒçŠ¶æ€çš„ç¯å¢ƒ)ä¹Ÿæ˜¯åˆçº¦`C`çš„ï¼š`msg.sender`æ˜¯`B`çš„åœ°å€ï¼Œå¹¶ä¸”å¦‚æœå‡½æ•°æ”¹å˜ä¸€äº›çŠ¶æ€å˜é‡ï¼Œäº§ç”Ÿçš„æ•ˆæœä¼šä½œç”¨äºåˆçº¦`C`çš„å˜é‡ä¸Šã€‚



![callçš„è¯­å¢ƒ](assets/VgMR533pA8WYtE5Lr65mQ.png)



è€Œå½“ç”¨æˆ·`A`é€šè¿‡åˆçº¦`B`æ¥`delegatecall`åˆçº¦`C`çš„æ—¶å€™ï¼Œæ‰§è¡Œçš„æ˜¯åˆçº¦`C`çš„å‡½æ•°ï¼Œä½†æ˜¯`è¯­å¢ƒ`ä»æ˜¯åˆçº¦`B`çš„ï¼š`msg.sender`æ˜¯`A`çš„åœ°å€ï¼Œå¹¶ä¸”å¦‚æœå‡½æ•°æ”¹å˜ä¸€äº›çŠ¶æ€å˜é‡ï¼Œäº§ç”Ÿçš„æ•ˆæœä¼šä½œç”¨äºåˆçº¦`B`çš„å˜é‡ä¸Šã€‚



![delegatecallçš„è¯­å¢ƒ](assets/JucQiWVixdlmJl6zHjCSI.png)

`delegatecall`è¯­æ³•å’Œ`call`ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ï¼š

```solidity
ç›®æ ‡åˆçº¦åœ°å€.delegatecall(äºŒè¿›åˆ¶ç¼–ç );
```

å…¶ä¸­`äºŒè¿›åˆ¶ç¼–ç `åˆ©ç”¨ç»“æ„åŒ–ç¼–ç å‡½æ•°`abi.encodeWithSignature`è·å¾—ï¼š

```solidity
abi.encodeWithSignature("å‡½æ•°ç­¾å", é€—å·åˆ†éš”çš„å…·ä½“å‚æ•°)
```

`å‡½æ•°ç­¾å`ä¸º`"å‡½æ•°åï¼ˆé€—å·åˆ†éš”çš„å‚æ•°ç±»å‹)"`ã€‚ä¾‹å¦‚`abi.encodeWithSignature("f(uint256,address)", _x, _addr)`ã€‚

å’Œ`call`ä¸ä¸€æ ·ï¼Œ`delegatecall`åœ¨è°ƒç”¨åˆçº¦æ—¶å¯ä»¥æŒ‡å®šäº¤æ˜“å‘é€çš„`gas`ï¼Œä½†ä¸èƒ½æŒ‡å®šå‘é€çš„`ETH`æ•°é¢

> **æ³¨æ„**ï¼š`delegatecall`æœ‰å®‰å…¨éšæ‚£ï¼Œä½¿ç”¨æ—¶è¦ä¿è¯å½“å‰åˆçº¦å’Œç›®æ ‡åˆçº¦çš„çŠ¶æ€å˜é‡å­˜å‚¨ç»“æ„ç›¸åŒï¼Œå¹¶ä¸”ç›®æ ‡åˆçº¦å®‰å…¨ï¼Œä¸ç„¶ä¼šé€ æˆèµ„äº§æŸå¤±ã€‚

### 4.7.1 ä»€ä¹ˆæƒ…å†µä¸‹ä¼šç”¨åˆ°`delegatecall`?

ç›®å‰`delegatecall`ä¸»è¦æœ‰ä¸¤ä¸ªåº”ç”¨åœºæ™¯ï¼š

1. ä»£ç†åˆçº¦ï¼ˆ`Proxy Contract`ï¼‰ï¼šå°†æ™ºèƒ½åˆçº¦çš„å­˜å‚¨åˆçº¦å’Œé€»è¾‘åˆçº¦åˆ†å¼€ï¼šä»£ç†åˆçº¦ï¼ˆ`Proxy Contract`ï¼‰å­˜å‚¨æ‰€æœ‰ç›¸å…³çš„å˜é‡ï¼Œå¹¶ä¸”ä¿å­˜é€»è¾‘åˆçº¦çš„åœ°å€ï¼›æ‰€æœ‰å‡½æ•°å­˜åœ¨é€»è¾‘åˆçº¦ï¼ˆ`Logic Contract`ï¼‰é‡Œï¼Œé€šè¿‡`delegatecall`æ‰§è¡Œã€‚å½“å‡çº§æ—¶ï¼Œåªéœ€è¦å°†ä»£ç†åˆçº¦æŒ‡å‘æ–°çš„é€»è¾‘åˆçº¦å³å¯ã€‚
2. EIP-2535 Diamondsï¼ˆé’»çŸ³ï¼‰ï¼šé’»çŸ³æ˜¯ä¸€ä¸ªæ”¯æŒæ„å»ºå¯åœ¨ç”Ÿäº§ä¸­æ‰©å±•çš„æ¨¡å—åŒ–æ™ºèƒ½åˆçº¦ç³»ç»Ÿçš„æ ‡å‡†ã€‚é’»çŸ³æ˜¯å…·æœ‰å¤šä¸ªå®æ–½åˆåŒçš„ä»£ç†åˆåŒã€‚ æ›´å¤šä¿¡æ¯è¯·æŸ¥çœ‹ï¼š[é’»çŸ³æ ‡å‡†ç®€ä»‹](https://eip2535diamonds.substack.com/p/introduction-to-the-diamond-standard)ã€‚

### 4.7.2 `delegatecall`ä¾‹å­

è°ƒç”¨ç»“æ„ï¼šä½ ï¼ˆ`A`ï¼‰é€šè¿‡åˆçº¦`B`è°ƒç”¨ç›®æ ‡åˆçº¦`C`ã€‚

#### 4.7.2.1 è¢«è°ƒç”¨çš„åˆçº¦C

æˆ‘ä»¬å…ˆå†™ä¸€ä¸ªç®€å•çš„ç›®æ ‡åˆçº¦`C`ï¼šæœ‰ä¸¤ä¸ª`public`å˜é‡ï¼š`num`å’Œ`sender`ï¼Œåˆ†åˆ«æ˜¯`uint256`å’Œ`address`ç±»å‹ï¼›æœ‰ä¸€ä¸ªå‡½æ•°ï¼Œå¯ä»¥å°†`num`è®¾å®šä¸ºä¼ å…¥çš„`_num`ï¼Œå¹¶ä¸”å°†`sender`è®¾ä¸º`msg.sender`ã€‚

```solidity
// è¢«è°ƒç”¨çš„åˆçº¦C
contract C {
    uint public num;
    address public sender;

    function setVars(uint _num) public payable {
        num = _num;
        sender = msg.sender;
    }
}
```

#### 4.7.2.2 å‘èµ·è°ƒç”¨çš„åˆçº¦B

é¦–å…ˆï¼Œåˆçº¦`B`å¿…é¡»å’Œç›®æ ‡åˆçº¦`C`çš„å˜é‡å­˜å‚¨å¸ƒå±€å¿…é¡»ç›¸åŒï¼Œä¸¤ä¸ªå˜é‡ï¼Œå¹¶ä¸”é¡ºåºä¸º`num`å’Œ`sender`

```solidity
contract B {
    uint public num;
    address public sender;
```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†åˆ«ç”¨`call`å’Œ`delegatecall`æ¥è°ƒç”¨åˆçº¦`C`çš„`setVars`å‡½æ•°ï¼Œæ›´å¥½çš„ç†è§£å®ƒä»¬çš„åŒºåˆ«ã€‚

`callSetVars`å‡½æ•°é€šè¿‡`call`æ¥è°ƒç”¨`setVars`ã€‚å®ƒæœ‰ä¸¤ä¸ªå‚æ•°`_addr`å’Œ`_num`ï¼Œåˆ†åˆ«å¯¹åº”åˆçº¦`C`çš„åœ°å€å’Œ`setVars`çš„å‚æ•°ã€‚

```solidity
    // é€šè¿‡callæ¥è°ƒç”¨Cçš„setVars()å‡½æ•°ï¼Œå°†æ”¹å˜åˆçº¦Cé‡Œçš„çŠ¶æ€å˜é‡
    function callSetVars(address _addr, uint _num) external payable{
        // call setVars()
        (bool success, bytes memory data) = _addr.call(
            abi.encodeWithSignature("setVars(uint256)", _num)
        );
    }
```

è€Œ`delegatecallSetVars`å‡½æ•°é€šè¿‡`delegatecall`æ¥è°ƒç”¨`setVars`ã€‚ä¸ä¸Šé¢çš„`callSetVars`å‡½æ•°ç›¸åŒï¼Œæœ‰ä¸¤ä¸ªå‚æ•°`_addr`å’Œ`_num`ï¼Œåˆ†åˆ«å¯¹åº”åˆçº¦`C`çš„åœ°å€å’Œ`setVars`çš„å‚æ•°ã€‚



```solidity
    // é€šè¿‡delegatecallæ¥è°ƒç”¨Cçš„setVars()å‡½æ•°ï¼Œå°†æ”¹å˜åˆçº¦Bé‡Œçš„çŠ¶æ€å˜é‡
    function delegatecallSetVars(address _addr, uint _num) external payable{
        // delegatecall setVars()
        (bool success, bytes memory data) = _addr.delegatecall(
            abi.encodeWithSignature("setVars(uint256)", _num)
        );
    }
}
```



## 4.8 åœ¨åˆçº¦ä¸­åˆ›å»ºæ–°åˆçº¦

åœ¨ä»¥å¤ªåŠé“¾ä¸Šï¼Œç”¨æˆ·ï¼ˆå¤–éƒ¨è´¦æˆ·ï¼Œ`EOA`ï¼‰å¯ä»¥åˆ›å»ºæ™ºèƒ½åˆçº¦ï¼Œæ™ºèƒ½åˆçº¦åŒæ ·ä¹Ÿå¯ä»¥åˆ›å»ºæ–°çš„æ™ºèƒ½åˆçº¦ã€‚å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€`uniswap`å°±æ˜¯åˆ©ç”¨å·¥å‚åˆçº¦ï¼ˆ`Factory`ï¼‰åˆ›å»ºäº†æ— æ•°ä¸ªå¸å¯¹åˆçº¦ï¼ˆ`Pair`ï¼‰ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä¼šç”¨ç®€åŒ–ç‰ˆçš„`uniswap`è®²å¦‚ä½•é€šè¿‡åˆçº¦åˆ›å»ºåˆçº¦ã€‚

### 4.8.1 `create`å¦‚ä½•ä½¿ç”¨

æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥åœ¨åˆçº¦ä¸­åˆ›å»ºæ–°åˆçº¦ï¼Œ`create`å’Œ`create2`ï¼Œè¿™é‡Œæˆ‘ä»¬è®²`create`ï¼Œä¸‹ä¸€è®²ä¼šä»‹ç»`create2`ã€‚

`create`çš„ç”¨æ³•å¾ˆç®€å•ï¼Œå°±æ˜¯`new`ä¸€ä¸ªåˆçº¦ï¼Œå¹¶ä¼ å…¥æ–°åˆçº¦æ„é€ å‡½æ•°æ‰€éœ€çš„å‚æ•°ï¼š

```solidity
Contract x = new Contract{value: _value}(params)
```

å…¶ä¸­`Contract`æ˜¯è¦åˆ›å»ºçš„åˆçº¦åï¼Œ`x`æ˜¯åˆçº¦å¯¹è±¡ï¼ˆåœ°å€ï¼‰ï¼Œå¦‚æœæ„é€ å‡½æ•°æ˜¯`payable`ï¼Œå¯ä»¥åˆ›å»ºæ—¶è½¬å…¥`_value`æ•°é‡çš„`ETH`ï¼Œ`params`æ˜¯æ–°åˆçº¦æ„é€ å‡½æ•°çš„å‚æ•°ã€‚



### 4.8.2 æç®€Uniswap

`Uniswap V2`[æ ¸å¿ƒåˆçº¦](https://github.com/Uniswap/v2-core/tree/master/contracts)ä¸­åŒ…å«ä¸¤ä¸ªåˆçº¦ï¼š

1. UniswapV2Pair: å¸å¯¹åˆçº¦ï¼Œç”¨äºç®¡ç†å¸å¯¹åœ°å€ã€æµåŠ¨æ€§ã€ä¹°å–ã€‚
2. UniswapV2Factory: å·¥å‚åˆçº¦ï¼Œç”¨äºåˆ›å»ºæ–°çš„å¸å¯¹ï¼Œå¹¶ç®¡ç†å¸å¯¹åœ°å€ã€‚

ä¸‹é¢æˆ‘ä»¬ç”¨`create`æ–¹æ³•å®ç°ä¸€ä¸ªæç®€ç‰ˆçš„`Uniswap`ï¼š`Pair`å¸å¯¹åˆçº¦è´Ÿè´£ç®¡ç†å¸å¯¹åœ°å€ï¼Œ`PairFactory`å·¥å‚åˆçº¦ç”¨äºåˆ›å»ºæ–°çš„å¸å¯¹ï¼Œå¹¶ç®¡ç†å¸å¯¹åœ°å€ã€‚

#### 4.8.2.1 `Pair`åˆçº¦

```solidity
contract Pair{
    address public factory; // å·¥å‚åˆçº¦åœ°å€
    address public token0; // ä»£å¸1
    address public token1; // ä»£å¸2

    constructor() payable {
        factory = msg.sender;
    }

    // called once by the factory at time of deployment
    function initialize(address _token0, address _token1) external {
        require(msg.sender == factory, 'UniswapV2: FORBIDDEN'); // sufficient check
        token0 = _token0;
        token1 = _token1;
    }
}
```

`Pair`åˆçº¦å¾ˆç®€å•ï¼ŒåŒ…å«3ä¸ªçŠ¶æ€å˜é‡ï¼š`factory`ï¼Œ`token0`å’Œ`token1`ã€‚

æ„é€ å‡½æ•°`constructor`åœ¨éƒ¨ç½²æ—¶å°†`factory`èµ‹å€¼ä¸ºå·¥å‚åˆçº¦åœ°å€ã€‚`initialize`å‡½æ•°ä¼šåœ¨`Pair`åˆçº¦åˆ›å»ºçš„æ—¶å€™è¢«å·¥å‚åˆçº¦è°ƒç”¨ä¸€æ¬¡ï¼Œå°†`token0`å’Œ`token1`æ›´æ–°ä¸ºå¸å¯¹ä¸­ä¸¤ç§ä»£å¸çš„åœ°å€ã€‚

> **æé—®**ï¼šä¸ºä»€ä¹ˆ`uniswap`ä¸åœ¨`constructor`ä¸­å°†`token0`å’Œ`token1`åœ°å€æ›´æ–°å¥½ï¼Ÿ
>
> **ç­”**ï¼šå› ä¸º`uniswap`ä½¿ç”¨çš„æ˜¯`create2`åˆ›å»ºåˆçº¦ï¼Œé™åˆ¶æ„é€ å‡½æ•°ä¸èƒ½æœ‰å‚æ•°ã€‚å½“ä½¿ç”¨`create`æ—¶ï¼Œ`Pair`åˆçº¦å…è®¸æ„é€ å‡½æ•°æœ‰å‚æ•°ï¼Œå¯ä»¥åœ¨`constructor`ä¸­å°†`token0`å’Œ`token1`åœ°å€æ›´æ–°å¥½ã€‚

#### 4.8.2.2 `PairFactory`

```solidity
contract PairFactory{
    mapping(address => mapping(address => address)) public getPair; // é€šè¿‡ä¸¤ä¸ªä»£å¸åœ°å€æŸ¥Pairåœ°å€
    address[] public allPairs; // ä¿å­˜æ‰€æœ‰Pairåœ°å€

    function createPair(address tokenA, address tokenB) external returns (address pairAddr) {
        // åˆ›å»ºæ–°åˆçº¦
        Pair pair = new Pair(); 
        // è°ƒç”¨æ–°åˆçº¦çš„initializeæ–¹æ³•
        pair.initialize(tokenA, tokenB);
        // æ›´æ–°åœ°å€map
        pairAddr = address(pair);
        allPairs.push(pairAddr);
        getPair[tokenA][tokenB] = pairAddr;
        getPair[tokenB][tokenA] = pairAddr;
    }
}
```

> éœ€è¦å…ˆå¯¼å…¥pairè¿™ä¸ªåˆçº¦

å·¥å‚åˆçº¦ï¼ˆ`PairFactory`ï¼‰æœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡`getPair`æ˜¯ä¸¤ä¸ªä»£å¸åœ°å€åˆ°å¸å¯¹åœ°å€çš„`map`ï¼Œæ–¹ä¾¿æ ¹æ®ä»£å¸æ‰¾åˆ°å¸å¯¹åœ°å€ï¼›`allPairs`æ˜¯å¸å¯¹åœ°å€çš„æ•°ç»„ï¼Œå­˜å‚¨äº†æ‰€æœ‰ä»£å¸åœ°å€ã€‚

`PairFactory`åˆçº¦åªæœ‰ä¸€ä¸ª`createPair`å‡½æ•°ï¼Œæ ¹æ®è¾“å…¥çš„ä¸¤ä¸ªä»£å¸åœ°å€`tokenA`å’Œ`tokenB`æ¥åˆ›å»ºæ–°çš„`Pair`åˆçº¦ã€‚å…¶ä¸­

```solidity
    Pair pair = new Pair(); 
```



å°±æ˜¯åˆ›å»ºåˆçº¦çš„ä»£ç ï¼Œéå¸¸ç®€å•ã€‚å¤§å®¶å¯ä»¥éƒ¨ç½²å¥½`PairFactory`åˆçº¦ï¼Œç„¶åç”¨ä¸‹é¢ä¸¤ä¸ªåœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨`createPair`ï¼Œçœ‹çœ‹åˆ›å»ºçš„å¸å¯¹åœ°å€æ˜¯ä»€ä¹ˆï¼š

```text
WBNBåœ°å€: 0x2c44b726ADF1963cA47Af88B284C06f30380fC78
BSCé“¾ä¸Šçš„PEOPLEåœ°å€:
0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c
```



## 4.9 Create2

`CREATE2` æ“ä½œç ä½¿æˆ‘ä»¬åœ¨æ™ºèƒ½åˆçº¦éƒ¨ç½²åœ¨ä»¥å¤ªåŠç½‘ç»œä¹‹å‰å°±èƒ½é¢„æµ‹åˆçº¦çš„åœ°å€ã€‚`Uniswap`åˆ›å»º`Pair`åˆçº¦ç”¨çš„å°±æ˜¯`CREATE2`è€Œä¸æ˜¯`CREATE`ã€‚è¿™ä¸€è®²ï¼Œæˆ‘å°†ä»‹ç»`CREATE2`çš„ç”¨æ³•

### 4.9.1 CREATEå¦‚ä½•è®¡ç®—åœ°å€

æ™ºèƒ½åˆçº¦å¯ä»¥ç”±å…¶ä»–åˆçº¦å’Œæ™®é€šè´¦æˆ·åˆ©ç”¨`CREATE`æ“ä½œç åˆ›å»ºã€‚ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œæ–°åˆçº¦çš„åœ°å€éƒ½ä»¥ç›¸åŒçš„æ–¹å¼è®¡ç®—ï¼šåˆ›å»ºè€…çš„åœ°å€(é€šå¸¸ä¸ºéƒ¨ç½²çš„é’±åŒ…åœ°å€æˆ–è€…åˆçº¦åœ°å€)å’Œ`nonce`(è¯¥åœ°å€å‘é€äº¤æ˜“çš„æ€»æ•°,å¯¹äºåˆçº¦è´¦æˆ·æ˜¯åˆ›å»ºçš„åˆçº¦æ€»æ•°,æ¯åˆ›å»ºä¸€ä¸ªåˆçº¦nonce+1))çš„å“ˆå¸Œã€‚

```text
æ–°åœ°å€ = hash(åˆ›å»ºè€…åœ°å€, nonce)
```

åˆ›å»ºè€…åœ°å€ä¸ä¼šå˜ï¼Œä½†`nonce`å¯èƒ½ä¼šéšæ—¶é—´è€Œæ”¹å˜ï¼Œå› æ­¤ç”¨`CREATE`åˆ›å»ºçš„åˆçº¦åœ°å€ä¸å¥½é¢„æµ‹ã€‚

```solidity
Contract x = new Contract{value: _value}(params)
```

### 4.9.2 CREATE2å¦‚ä½•è®¡ç®—åœ°å€

`CREATE2`çš„ç›®çš„æ˜¯ä¸ºäº†è®©åˆçº¦åœ°å€ç‹¬ç«‹äºæœªæ¥çš„äº‹ä»¶ã€‚ä¸ç®¡æœªæ¥åŒºå—é“¾ä¸Šå‘ç”Ÿäº†ä»€ä¹ˆï¼Œä½ éƒ½å¯ä»¥æŠŠåˆçº¦éƒ¨ç½²åœ¨äº‹å…ˆè®¡ç®—å¥½çš„åœ°å€ä¸Šã€‚ç”¨`CREATE2`åˆ›å»ºçš„åˆçº¦åœ°å€ç”±4ä¸ªéƒ¨åˆ†å†³å®šï¼š

- `0xFF`ï¼šä¸€ä¸ªå¸¸æ•°ï¼Œé¿å…å’Œ`CREATE`å†²çª
- åˆ›å»ºè€…åœ°å€
- `salt`ï¼ˆç›ï¼‰ï¼šä¸€ä¸ªåˆ›å»ºè€…ç»™å®šçš„æ•°å€¼
- å¾…éƒ¨ç½²åˆçº¦çš„å­—èŠ‚ç ï¼ˆ`bytecode`ï¼‰

```text
æ–°åœ°å€ = hash("0xFF",åˆ›å»ºè€…åœ°å€, salt, bytecode)
```

`CREATE2` ç¡®ä¿ï¼Œå¦‚æœåˆ›å»ºè€…ä½¿ç”¨ `CREATE2` å’Œæä¾›çš„ `salt` éƒ¨ç½²ç»™å®šçš„åˆçº¦`bytecode`ï¼Œå®ƒå°†å­˜å‚¨åœ¨ `æ–°åœ°å€` ä¸­ã€‚

### 4.9.3 å¦‚ä½•ä½¿ç”¨`CREATE2`

`CREATE2`çš„ç”¨æ³•å’Œä¹‹å‰è®²çš„`Create`ç±»ä¼¼ï¼ŒåŒæ ·æ˜¯`new`ä¸€ä¸ªåˆçº¦ï¼Œå¹¶ä¼ å…¥æ–°åˆçº¦æ„é€ å‡½æ•°æ‰€éœ€çš„å‚æ•°ï¼Œåªä¸è¿‡è¦å¤šä¼ ä¸€ä¸ª`salt`å‚æ•°ï¼š

```text
Contract x = new Contract{salt: _salt, value: _value}(params)
```

å…¶ä¸­`Contract`æ˜¯è¦åˆ›å»ºçš„åˆçº¦åï¼Œ`x`æ˜¯åˆçº¦å¯¹è±¡ï¼ˆåœ°å€ï¼‰ï¼Œ`_salt`æ˜¯æŒ‡å®šçš„ç›ï¼›å¦‚æœæ„é€ å‡½æ•°æ˜¯`payable`ï¼Œå¯ä»¥åˆ›å»ºæ—¶è½¬å…¥`_value`æ•°é‡çš„`ETH`ï¼Œ`params`æ˜¯æ–°åˆçº¦æ„é€ å‡½æ•°çš„å‚æ•°ã€‚

### 4.9.4 æç®€Uniswap2

æˆ‘ä»¬ç”¨`Create2`æ¥å®ç°æç®€`Uniswap`ã€‚

#### 4.9.4.1 `Pair`

```solidity
contract Pair{
    address public factory; // å·¥å‚åˆçº¦åœ°å€
    address public token0; // ä»£å¸1
    address public token1; // ä»£å¸2

    constructor() payable {
        factory = msg.sender;
    }

    // called once by the factory at time of deployment
    function initialize(address _token0, address _token1) external {
        require(msg.sender == factory, 'UniswapV2: FORBIDDEN'); // sufficient check
        token0 = _token0;
        token1 = _token1;
    }
}
```

`Pair`åˆçº¦å¾ˆç®€å•ï¼ŒåŒ…å«3ä¸ªçŠ¶æ€å˜é‡ï¼š`factory`ï¼Œ`token0`å’Œ`token1`ã€‚

æ„é€ å‡½æ•°`constructor`åœ¨éƒ¨ç½²æ—¶å°†`factory`èµ‹å€¼ä¸ºå·¥å‚åˆçº¦åœ°å€ã€‚`initialize`å‡½æ•°ä¼šåœ¨`Pair`åˆçº¦åˆ›å»ºçš„æ—¶å€™è¢«å·¥å‚åˆçº¦è°ƒç”¨ä¸€æ¬¡ï¼Œå°†`token0`å’Œ`token1`æ›´æ–°ä¸ºå¸å¯¹ä¸­ä¸¤ç§ä»£å¸çš„åœ°å€ã€‚

#### 4.9.4.2 `PairFactory2`

```solidity
contract PairFactory2{
        mapping(address => mapping(address => address)) public getPair; // é€šè¿‡ä¸¤ä¸ªä»£å¸åœ°å€æŸ¥Pairåœ°å€
        address[] public allPairs; // ä¿å­˜æ‰€æœ‰Pairåœ°å€

        function createPair2(address tokenA, address tokenB) external returns (address pairAddr) {
            require(tokenA != tokenB, 'IDENTICAL_ADDRESSES'); //é¿å…tokenAå’ŒtokenBç›¸åŒäº§ç”Ÿçš„å†²çª
            // è®¡ç®—ç”¨tokenAå’ŒtokenBåœ°å€è®¡ç®—salt
            (address token0, address token1) = tokenA < tokenB ? (tokenA, tokenB) : (tokenB, tokenA); //å°†tokenAå’ŒtokenBæŒ‰å¤§å°æ’åº
            bytes32 salt = keccak256(abi.encodePacked(token0, token1));
            // ç”¨create2éƒ¨ç½²æ–°åˆçº¦
            Pair pair = new Pair{salt: salt}(); 
            // è°ƒç”¨æ–°åˆçº¦çš„initializeæ–¹æ³•
            pair.initialize(tokenA, tokenB);
            // æ›´æ–°åœ°å€map
            pairAddr = address(pair);
            allPairs.push(pairAddr);
            getPair[tokenA][tokenB] = pairAddr;
            getPair[tokenB][tokenA] = pairAddr;
        }
```



å·¥å‚åˆçº¦ï¼ˆ`PairFactory2`ï¼‰æœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡`getPair`æ˜¯ä¸¤ä¸ªä»£å¸åœ°å€åˆ°å¸å¯¹åœ°å€çš„`map`ï¼Œæ–¹ä¾¿æ ¹æ®ä»£å¸æ‰¾åˆ°å¸å¯¹åœ°å€ï¼›`allPairs`æ˜¯å¸å¯¹åœ°å€çš„æ•°ç»„ï¼Œå­˜å‚¨äº†æ‰€æœ‰å¸å¯¹åœ°å€ã€‚

`PairFactory2`åˆçº¦åªæœ‰ä¸€ä¸ª`createPair2`å‡½æ•°ï¼Œä½¿ç”¨`CREATE2`æ ¹æ®è¾“å…¥çš„ä¸¤ä¸ªä»£å¸åœ°å€`tokenA`å’Œ`tokenB`æ¥åˆ›å»ºæ–°çš„`Pair`åˆçº¦ã€‚å…¶ä¸­

```solidity
    Pair pair = new Pair{salt: salt}(); 
```



å°±æ˜¯åˆ©ç”¨`CREATE2`åˆ›å»ºåˆçº¦çš„ä»£ç ï¼Œéå¸¸ç®€å•ï¼Œè€Œ`salt`ä¸º`token1`å’Œ`token2`çš„`hash`ï¼š

```solidity
            bytes32 salt = keccak256(abi.encodePacked(token0, token1));
```



#### 4.9.4.3 äº‹å…ˆè®¡ç®—`Pair`åœ°å€

```solidity
        // æå‰è®¡ç®—pairåˆçº¦åœ°å€
        function calculateAddr(address tokenA, address tokenB) public view returns(address predictedAddress){
            require(tokenA != tokenB, 'IDENTICAL_ADDRESSES'); //é¿å…tokenAå’ŒtokenBç›¸åŒäº§ç”Ÿçš„å†²çª
            // è®¡ç®—ç”¨tokenAå’ŒtokenBåœ°å€è®¡ç®—salt
            (address token0, address token1) = tokenA < tokenB ? (tokenA, tokenB) : (tokenB, tokenA); //å°†tokenAå’ŒtokenBæŒ‰å¤§å°æ’åº
            bytes32 salt = keccak256(abi.encodePacked(token0, token1));
            // è®¡ç®—åˆçº¦åœ°å€æ–¹æ³• hash()
            predictedAddress = address(uint160(uint(keccak256(abi.encodePacked(
                bytes1(0xff),
                address(this),
                salt,
                keccak256(type(Pair).creationCode)
            )))));
        
```

```text
WBNBåœ°å€: 0x2c44b726ADF1963cA47Af88B284C06f30380fC78
BSCé“¾ä¸Šçš„PEOPLEåœ°å€:
0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c
```



### 4.9.5 create2çš„å®é™…åº”ç”¨åœºæ™¯

1. äº¤æ˜“æ‰€ä¸ºæ–°ç”¨æˆ·é¢„ç•™åˆ›å»ºé’±åŒ…åˆçº¦åœ°å€ã€‚
2. ç”± `CREATE2` é©±åŠ¨çš„ `factory` åˆçº¦ï¼Œåœ¨`uniswapV2`ä¸­äº¤æ˜“å¯¹çš„åˆ›å»ºæ˜¯åœ¨ `Factory`ä¸­è°ƒç”¨`create2`å®Œæˆã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯: å®ƒå¯ä»¥å¾—åˆ°ä¸€ä¸ªç¡®å®šçš„`pair`åœ°å€, ä½¿å¾— `Router`ä¸­å°±å¯ä»¥é€šè¿‡ `(tokenA, tokenB)` è®¡ç®—å‡º`pair`åœ°å€, ä¸å†éœ€è¦æ‰§è¡Œä¸€æ¬¡ `Factory.getPair(tokenA, tokenB)` çš„è·¨åˆçº¦è°ƒç”¨ã€‚



## 4.10 åˆ é™¤åˆçº¦`selfdestruct`

`selfdestruct`å‘½ä»¤å¯ä»¥ç”¨æ¥åˆ é™¤æ™ºèƒ½åˆçº¦ï¼Œå¹¶å°†è¯¥åˆçº¦å‰©ä½™`ETH`è½¬åˆ°æŒ‡å®šåœ°å€ã€‚`selfdestruct`æ˜¯ä¸ºäº†åº”å¯¹åˆçº¦å‡ºé”™çš„æç«¯æƒ…å†µè€Œè®¾è®¡çš„ã€‚å®ƒæœ€æ—©è¢«å‘½åä¸º`suicide`ï¼ˆè‡ªæ€ï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªè¯å¤ªæ•æ„Ÿã€‚ä¸ºäº†ä¿æŠ¤æŠ‘éƒçš„ç¨‹åºå‘˜ï¼Œæ”¹åä¸º`selfdestruct`ã€‚

### 4.10.1 å¦‚ä½•ä½¿ç”¨`selfdestruct`

`selfdestruct`ä½¿ç”¨èµ·æ¥éå¸¸ç®€å•ï¼š

```solidity
selfdestruct(_addr)ï¼›
```

å…¶ä¸­`_addr`æ˜¯æ¥æ”¶åˆçº¦ä¸­å‰©ä½™`ETH`çš„åœ°å€ã€‚



### 4.10.2 ä¾‹å­

```solidity
contract DeleteContract {

    uint public value = 10;

    constructor() payable {}

    receive() external payable {}

    function deleteContract() external {
        // è°ƒç”¨selfdestructé”€æ¯åˆçº¦ï¼Œå¹¶æŠŠå‰©ä½™çš„ETHè½¬ç»™msg.sender
        selfdestruct(payable(msg.sender));
    }

    function getBalance() external view returns(uint balance){
        balance = address(this).balance;
    }
}
```

åœ¨`DeleteContract`åˆçº¦ä¸­ï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ª`public`çŠ¶æ€å˜é‡`value`ï¼Œä¸¤ä¸ªå‡½æ•°ï¼š`getBalance()`ç”¨äºè·å–åˆçº¦`ETH`ä½™é¢ï¼Œ`deleteContract()`ç”¨äºè‡ªæ¯åˆçº¦ï¼Œå¹¶æŠŠ`ETH`è½¬å…¥ç»™å‘èµ·äººã€‚

éƒ¨ç½²å¥½åˆçº¦åï¼Œæˆ‘ä»¬å‘`DeleteContract`åˆçº¦è½¬å…¥1 `ETH`ã€‚è¿™æ—¶ï¼Œ`getBalance()`ä¼šè¿”å›1 `ETH`ï¼Œ`value`å˜é‡æ˜¯10ã€‚

å½“æˆ‘ä»¬è°ƒç”¨`deleteContract()`å‡½æ•°ï¼Œåˆçº¦å°†è‡ªæ¯ï¼Œæ‰€æœ‰å˜é‡éƒ½æ¸…ç©ºï¼Œæ­¤æ—¶`value`å˜ä¸ºé»˜è®¤å€¼`0`ï¼Œ`getBalance()`ä¹Ÿè¿”å›ç©ºå€¼ã€‚

### 4.10.3 æ³¨æ„äº‹é¡¹

1. å¯¹å¤–æä¾›åˆçº¦é”€æ¯æ¥å£æ—¶ï¼Œæœ€å¥½è®¾ç½®ä¸ºåªæœ‰åˆçº¦æ‰€æœ‰è€…å¯ä»¥è°ƒç”¨ï¼Œå¯ä»¥ä½¿ç”¨å‡½æ•°ä¿®é¥°ç¬¦`onlyOwner`è¿›è¡Œå‡½æ•°å£°æ˜ã€‚
2. å½“åˆçº¦è¢«é”€æ¯åä¸æ™ºèƒ½åˆçº¦çš„äº¤äº’ä¹Ÿèƒ½æˆåŠŸï¼Œå¹¶ä¸”è¿”å›0ã€‚
3. å½“åˆçº¦ä¸­æœ‰`selfdestruct`åŠŸèƒ½æ—¶å¸¸å¸¸ä¼šå¸¦æ¥å®‰å…¨é—®é¢˜å’Œä¿¡ä»»é—®é¢˜ï¼Œåˆçº¦ä¸­çš„SelfdestructåŠŸèƒ½ä¼šä¸ºæ”»å‡»è€…æ‰“å¼€æ”»å‡»å‘é‡(ä¾‹å¦‚ä½¿ç”¨`selfdestruct`å‘ä¸€ä¸ªåˆçº¦é¢‘ç¹è½¬å…¥tokenè¿›è¡Œæ”»å‡»ï¼Œè¿™å°†å¤§å¤§èŠ‚çœäº†GASçš„è´¹ç”¨ï¼Œè™½ç„¶å¾ˆå°‘äººè¿™ä¹ˆåš)ï¼Œæ­¤å¤–ï¼Œæ­¤åŠŸèƒ½è¿˜ä¼šé™ä½ç”¨æˆ·å¯¹åˆçº¦çš„ä¿¡å¿ƒã€‚



### 4.10.4 æ€»ç»“

`selfdestruct`æ˜¯æ™ºèƒ½åˆçº¦çš„ç´§æ€¥æŒ‰é’®ï¼Œé”€æ¯åˆçº¦å¹¶å°†å‰©ä½™`ETH`è½¬ç§»åˆ°æŒ‡å®šè´¦æˆ·ã€‚å½“è‘—åçš„`The DAO`æ”»å‡»å‘ç”Ÿæ—¶ï¼Œä»¥å¤ªåŠçš„åˆ›å§‹äººä»¬ä¸€å®šåæ‚”è¿‡æ²¡æœ‰åœ¨åˆçº¦é‡ŒåŠ å…¥`selfdestruct`æ¥åœæ­¢é»‘å®¢çš„æ”»å‡»å§ã€‚



## 4.11 ABIç¼–ç è§£ç 

`ABI` (Application Binary Interfaceï¼Œåº”ç”¨äºŒè¿›åˆ¶æ¥å£)æ˜¯ä¸ä»¥å¤ªåŠæ™ºèƒ½åˆçº¦äº¤äº’çš„æ ‡å‡†ã€‚æ•°æ®åŸºäºä»–ä»¬çš„ç±»å‹ç¼–ç ï¼›å¹¶ä¸”ç”±äºç¼–ç åä¸åŒ…å«ç±»å‹ä¿¡æ¯ï¼Œè§£ç æ—¶éœ€è¦æ³¨æ˜å®ƒä»¬çš„ç±»å‹ã€‚

`Solidity`ä¸­ï¼Œ`ABIç¼–ç `æœ‰4ä¸ªå‡½æ•°ï¼š`abi.encode`, `abi.encodePacked`, `abi.encodeWithSignature`, `abi.encodeWithSelector`ã€‚è€Œ`ABIè§£ç `æœ‰1ä¸ªå‡½æ•°ï¼š`abi.decode`ï¼Œç”¨äºè§£ç `abi.encode`çš„æ•°æ®ã€‚



æˆ‘ä»¬å°†ç”¨ç¼–ç 4ä¸ªå˜é‡ï¼Œä»–ä»¬çš„ç±»å‹åˆ†åˆ«æ˜¯`uint256`, `address`, `string`, `uint256[2]`ï¼š

```solidity
    uint x = 10;
    address addr = 0x7A58c0Be72BE218B41C608b7Fe7C5bB630736C71;
    string name = "0xAA";
    uint[2] array = [5, 6]; 
```



### 4.11.1 `abi.encode`

å°†ç»™å®šå‚æ•°åˆ©ç”¨[ABIè§„åˆ™](https://learnblockchain.cn/docs/solidity/abi-spec.html)ç¼–ç ã€‚`ABI`è¢«è®¾è®¡å‡ºæ¥è·Ÿæ™ºèƒ½åˆçº¦äº¤äº’ï¼Œä»–å°†æ¯ä¸ªå‚æ•°å¡«å……ä¸º32å­—èŠ‚çš„æ•°æ®ï¼Œå¹¶æ‹¼æ¥åœ¨ä¸€èµ·ã€‚å¦‚æœä½ è¦å’Œåˆçº¦äº¤äº’ï¼Œä½ è¦ç”¨çš„å°±æ˜¯`abi.encode`ã€‚

```solidity
    function encode() public view returns(bytes memory result) {
        result = abi.encode(x, addr, name, array);
    }
```



ç¼–ç çš„ç»“æœä¸º`0x000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000007a58c0be72be218b41c608b7fe7c5bb630736c7100000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000043078414100000000000000000000000000000000000000000000000000000000`ï¼Œç”±äº`abi.encode`å°†æ¯ä¸ªæ•°æ®éƒ½å¡«å……ä¸º32å­—èŠ‚ï¼Œä¸­é—´æœ‰å¾ˆå¤š`0`ã€‚

### 4.11.2 `abi.encodePacked`

å°†ç»™å®šå‚æ•°æ ¹æ®å…¶æ‰€éœ€æœ€ä½ç©ºé—´ç¼–ç ã€‚å®ƒç±»ä¼¼ `abi.encode`ï¼Œä½†æ˜¯ä¼šæŠŠå…¶ä¸­å¡«å……çš„å¾ˆå¤š`0`çœç•¥ã€‚æ¯”å¦‚ï¼Œåªç”¨1å­—èŠ‚æ¥ç¼–ç `uint`ç±»å‹ã€‚å½“ä½ æƒ³çœç©ºé—´ï¼Œå¹¶ä¸”ä¸ä¸åˆçº¦äº¤äº’çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨`abi.encodePacked`ï¼Œä¾‹å¦‚ç®—ä¸€äº›æ•°æ®çš„`hash`æ—¶ã€‚

```solidity
    function encodePacked() public view returns(bytes memory result) {
        result = abi.encodePacked(x, addr, name, array);
    }
```



ç¼–ç çš„ç»“æœä¸º`0x000000000000000000000000000000000000000000000000000000000000000a7a58c0be72be218b41c608b7fe7c5bb630736c713078414100000000000000000000000000000000000000000000000000000000000000050000000000000000000000000000000000000000000000000000000000000006`ï¼Œç”±äº`abi.encodePacked`å¯¹ç¼–ç è¿›è¡Œäº†å‹ç¼©ï¼Œé•¿åº¦æ¯”`abi.encode`çŸ­å¾ˆå¤šã€‚

### 4.11.3 `abi.encodeWithSignature`

ä¸`abi.encode`åŠŸèƒ½ç±»ä¼¼ï¼Œåªä¸è¿‡ç¬¬ä¸€ä¸ªå‚æ•°ä¸º`å‡½æ•°ç­¾å`ï¼Œæ¯”å¦‚`"foo(uint256,address)"`ã€‚å½“è°ƒç”¨å…¶ä»–åˆçº¦çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ã€‚

```solidity
    function encodeWithSignature() public view returns(bytes memory result) {
        result = abi.encodeWithSignature("foo(uint256,address,string,uint256[2])", x, addr, name, array);
    }
```



ç¼–ç çš„ç»“æœä¸º`0xe87082f1000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000007a58c0be72be218b41c608b7fe7c5bb630736c7100000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000043078414100000000000000000000000000000000000000000000000000000000`ï¼Œç­‰åŒäºåœ¨`abi.encode`ç¼–ç ç»“æœå‰åŠ ä¸Šäº†4å­—èŠ‚çš„`å‡½æ•°é€‰æ‹©å™¨`[è¯´æ˜](https://www.wtf.academy/docs/solidity-102/ABIEncode/#fn-è¯´æ˜)ã€‚ [è¯´æ˜](https://www.wtf.academy/docs/solidity-102/ABIEncode/#fn-è¯´æ˜): å‡½æ•°é€‰æ‹©å™¨å°±æ˜¯é€šè¿‡å‡½æ•°åå’Œå‚æ•°è¿›è¡Œç­¾åå¤„ç†(Keccakâ€“Sha3)æ¥æ ‡è¯†å‡½æ•°ï¼Œå¯ä»¥ç”¨äºä¸åŒåˆçº¦ä¹‹é—´çš„å‡½æ•°è°ƒç”¨

### 4.11.4 `abi.encodeWithSelector`

ä¸`abi.encodeWithSignature`åŠŸèƒ½ç±»ä¼¼ï¼Œåªä¸è¿‡ç¬¬ä¸€ä¸ªå‚æ•°ä¸º`å‡½æ•°é€‰æ‹©å™¨`ï¼Œä¸º`å‡½æ•°ç­¾å`Keccakå“ˆå¸Œçš„å‰4ä¸ªå­—èŠ‚ã€‚

```solidity
    function encodeWithSelector() public view returns(bytes memory result) {
        result = abi.encodeWithSelector(bytes4(keccak256("foo(uint256,address,string,uint256[2])")), x, addr, name, array);
    }
```



ç¼–ç çš„ç»“æœä¸º`0xe87082f1000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000007a58c0be72be218b41c608b7fe7c5bb630736c7100000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000005000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000043078414100000000000000000000000000000000000000000000000000000000`ï¼Œä¸`abi.encodeWithSignature`ç»“æœä¸€æ ·ã€‚

### 4.11.5 ABIè§£ç 

`abi.decode`ç”¨äºè§£ç `abi.encode`ç”Ÿæˆçš„äºŒè¿›åˆ¶ç¼–ç ï¼Œå°†å®ƒè¿˜åŸæˆåŸæœ¬çš„å‚æ•°ã€‚

```solidity
    function decode(bytes memory data) public pure returns(uint dx, address daddr, string memory dname, uint[2] memory darray) {
        (dx, daddr, dname, darray) = abi.decode(data, (uint, address, string, uint[2]));
    }
```



### 4.11.6 ABIçš„ä½¿ç”¨åœºæ™¯

1. åœ¨åˆçº¦å¼€å‘ä¸­ï¼ŒABIå¸¸é…åˆcallæ¥å®ç°å¯¹åˆçº¦çš„åº•å±‚è°ƒç”¨ã€‚

```solidity
    bytes4 selector = contract.getValue.selector;

    bytes memory data = abi.encodeWithSelector(selector, _x);
    (bool success, bytes memory returnedData) = address(contract).staticcall(data);
    require(success);

    return abi.decode(returnedData, (uint256));
```

1. ethers.jsä¸­å¸¸ç”¨ABIå®ç°åˆçº¦çš„å¯¼å…¥å’Œå‡½æ•°è°ƒç”¨ã€‚

```solidity
    const wavePortalContract = new ethers.Contract(contractAddress, contractABI, signer);
    /*
        * Call the getAllWaves method from your Smart Contract
        */
    const waves = await wavePortalContract.getAllWaves();
```



1. å¯¹ä¸å¼€æºåˆçº¦è¿›è¡Œåç¼–è¯‘åï¼ŒæŸäº›å‡½æ•°æ— æ³•æŸ¥åˆ°å‡½æ•°ç­¾åï¼Œå¯é€šè¿‡ABIè¿›è¡Œè°ƒç”¨ã€‚

- 0x533ba33a() æ˜¯ä¸€ä¸ªåç¼–è¯‘åæ˜¾ç¤ºçš„å‡½æ•°ï¼Œåªæœ‰å‡½æ•°ç¼–ç åçš„ç»“æœï¼Œå¹¶ä¸”æ— æ³•æŸ¥åˆ°å‡½æ•°ç­¾å

è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å¯ä»¥é€šè¿‡ABIå‡½æ•°é€‰æ‹©å™¨æ¥è°ƒç”¨

```solidity
    bytes memory data = abi.encodeWithSelector(bytes4(0x533ba33a));

    (bool success, bytes memory returnedData) = address(contract).staticcall(data);
    require(success);

    return abi.decode(returnedData, (uint256));
```



### 4.11.7 æ€»ç»“

åœ¨ä»¥å¤ªåŠä¸­ï¼Œæ•°æ®å¿…é¡»ç¼–ç æˆå­—èŠ‚ç æ‰èƒ½å’Œæ™ºèƒ½åˆçº¦äº¤äº’ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬ä»‹ç»äº†4ç§`abiç¼–ç `æ–¹æ³•å’Œ1ç§`abiè§£ç `æ–¹æ³•ã€‚



## 4.12 Hash

```solidity
bytes32 hash = keccak256(abi.encodePacked(_account, _tokenId));
```

> ä½¿ç”¨ `keccak256(abi.encodePacked(_account, _tokenId))` çš„ä¸»è¦åŸå› æ˜¯ä¸ºäº†ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç¡®ä¿æ•°æ®å®Œæ•´æ€§ï¼Œå¹¶é˜²æ­¢å“ˆå¸Œç¢°æ’ã€‚è¿™ç§æ–¹æ³•å¹¿æ³›åº”ç”¨äºä»¥å¤ªåŠæ™ºèƒ½åˆçº¦ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¶‰åŠå¤šä¸ªå˜é‡ç»„åˆçš„æƒ…å†µä¸‹ï¼Œå¦‚ NFT å’Œä»£å¸åˆçº¦ã€‚



ä¸€ä¸ªå¥½çš„å“ˆå¸Œå‡½æ•°åº”è¯¥å…·æœ‰ä»¥ä¸‹å‡ ä¸ªç‰¹æ€§ï¼š

- å•å‘æ€§ï¼šä»è¾“å…¥çš„æ¶ˆæ¯åˆ°å®ƒçš„å“ˆå¸Œçš„æ­£å‘è¿ç®—ç®€å•ä¸”å”¯ä¸€ç¡®å®šï¼Œè€Œåè¿‡æ¥éå¸¸éš¾ï¼Œåªèƒ½é æš´åŠ›æšä¸¾ã€‚
- çµæ•æ€§ï¼šè¾“å…¥çš„æ¶ˆæ¯æ”¹å˜ä¸€ç‚¹å¯¹å®ƒçš„å“ˆå¸Œæ”¹å˜å¾ˆå¤§ã€‚
- é«˜æ•ˆæ€§ï¼šä»è¾“å…¥çš„æ¶ˆæ¯åˆ°å“ˆå¸Œçš„è¿ç®—é«˜æ•ˆã€‚
- å‡ä¸€æ€§ï¼šæ¯ä¸ªå“ˆå¸Œå€¼è¢«å–åˆ°çš„æ¦‚ç‡åº”è¯¥åŸºæœ¬ç›¸ç­‰ã€‚
- æŠ—ç¢°æ’æ€§ï¼š
  - å¼±æŠ—ç¢°æ’æ€§ï¼šç»™å®šä¸€ä¸ªæ¶ˆæ¯`x`ï¼Œæ‰¾åˆ°å¦ä¸€ä¸ªæ¶ˆæ¯`x'`ä½¿å¾—`hash(x) = hash(x')`æ˜¯å›°éš¾çš„ã€‚
  - å¼ºæŠ—ç¢°æ’æ€§ï¼šæ‰¾åˆ°ä»»æ„`x`å’Œ`x'`ï¼Œä½¿å¾—`hash(x) = hash(x')`æ˜¯å›°éš¾çš„ã€‚

### 4.12.1 Keccak256

`Keccak256`å‡½æ•°æ˜¯`solidity`ä¸­æœ€å¸¸ç”¨çš„å“ˆå¸Œå‡½æ•°ï¼Œç”¨æ³•éå¸¸ç®€å•ï¼š

```solidity
å“ˆå¸Œ = keccak256(æ•°æ®);
```



#### 4.12.1.1 Keccak256å’Œsha3

è¿™æ˜¯ä¸€ä¸ªå¾ˆæœ‰è¶£çš„äº‹æƒ…ï¼š

1. sha3ç”±keccakæ ‡å‡†åŒ–è€Œæ¥ï¼Œåœ¨å¾ˆå¤šåœºåˆä¸‹Keccakå’ŒSHA3æ˜¯åŒä¹‰è¯ï¼Œä½†åœ¨2015å¹´8æœˆSHA3æœ€ç»ˆå®Œæˆæ ‡å‡†åŒ–æ—¶ï¼ŒNISTè°ƒæ•´äº†å¡«å……ç®—æ³•ã€‚**æ‰€ä»¥SHA3å°±å’Œkeccakè®¡ç®—çš„ç»“æœä¸ä¸€æ ·**ï¼Œè¿™ç‚¹åœ¨å®é™…å¼€å‘ä¸­è¦æ³¨æ„ã€‚
2. ä»¥å¤ªåŠåœ¨å¼€å‘çš„æ—¶å€™sha3è¿˜åœ¨æ ‡å‡†åŒ–ä¸­ï¼Œæ‰€ä»¥é‡‡ç”¨äº†keccakï¼Œæ‰€ä»¥Ethereumå’ŒSolidityæ™ºèƒ½åˆçº¦ä»£ç ä¸­çš„SHA3æ˜¯æŒ‡Keccak256ï¼Œè€Œä¸æ˜¯æ ‡å‡†çš„NIST-SHA3ï¼Œä¸ºäº†é¿å…æ··æ·†ï¼Œç›´æ¥åœ¨åˆçº¦ä»£ç ä¸­å†™æˆKeccak256æ˜¯æœ€æ¸…æ™°çš„ã€‚

#### 4.12.1.2 ç”Ÿæˆæ•°æ®å”¯ä¸€æ ‡è¯†

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨`keccak256`æ¥ç”Ÿæˆä¸€äº›æ•°æ®çš„å”¯ä¸€æ ‡è¯†ã€‚æ¯”å¦‚æˆ‘ä»¬æœ‰å‡ ä¸ªä¸åŒç±»å‹çš„æ•°æ®ï¼š`uint`ï¼Œ`string`ï¼Œ`address`ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆç”¨`abi.encodePacked`æ–¹æ³•å°†ä»–ä»¬æ‰“åŒ…ç¼–ç ï¼Œç„¶åå†ç”¨`keccak256`æ¥ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼š

```solidity
    function hash(
        uint _num,
        string memory _string,
        address _addr
    ) public pure returns (bytes32) {
        return keccak256(abi.encodePacked(_num, _string, _addr));
    }
```



#### 4.12.1.3 å¼±æŠ—ç¢°æ’æ€§

æˆ‘ä»¬ç”¨`keccak256`æ¼”ç¤ºä¸€ä¸‹ä¹‹å‰è®²åˆ°çš„å¼±æŠ—ç¢°æ’æ€§ï¼Œå³ç»™å®šä¸€ä¸ªæ¶ˆæ¯`x`ï¼Œæ‰¾åˆ°å¦ä¸€ä¸ªæ¶ˆæ¯`x'`ä½¿å¾—`hash(x) = hash(x')`æ˜¯å›°éš¾çš„ã€‚

æˆ‘ä»¬ç»™å®šä¸€ä¸ªæ¶ˆæ¯`0xAA`ï¼Œè¯•å›¾å»æ‰¾å¦ä¸€ä¸ªæ¶ˆæ¯ï¼Œä½¿å¾—å®ƒä»¬çš„å“ˆå¸Œå€¼ç›¸ç­‰ï¼š

```solidity
    // å¼±æŠ—ç¢°æ’æ€§
    function weak(
        string memory string1
    )public view returns (bool){
        return keccak256(abi.encodePacked(string1)) == _msg;
    }
```



### 4.12.1.4 å¼ºæŠ—ç¢°æ’æ€§

æˆ‘ä»¬ç”¨`keccak256`æ¼”ç¤ºä¸€ä¸‹ä¹‹å‰è®²åˆ°çš„å¼ºæŠ—ç¢°æ’æ€§ï¼Œå³æ‰¾åˆ°ä»»æ„ä¸åŒçš„`x`å’Œ`x'`ï¼Œä½¿å¾—`hash(x) = hash(x')`æ˜¯å›°éš¾çš„ã€‚

æˆ‘ä»¬æ„é€ ä¸€ä¸ªå‡½æ•°`strong`ï¼Œæ¥æ”¶ä¸¤ä¸ªä¸åŒçš„`string`å‚æ•°`string1`å’Œ`string2`ï¼Œç„¶ååˆ¤æ–­å®ƒä»¬çš„å“ˆå¸Œæ˜¯å¦ç›¸åŒï¼š

```solidity
    // å¼ºæŠ—ç¢°æ’æ€§
    function strong(
        string memory string1,
        string memory string2
    )public pure returns (bool){
        return keccak256(abi.encodePacked(string1)) == keccak256(abi.encodePacked(string2));
    }
```



## 4.13 å‡½æ•°é€‰æ‹©å™¨Selector

å½“æˆ‘ä»¬è°ƒç”¨æ™ºèƒ½åˆçº¦æ—¶ï¼Œæœ¬è´¨ä¸Šæ˜¯å‘ç›®æ ‡åˆçº¦å‘é€äº†ä¸€æ®µ`calldata`ï¼Œåœ¨remixä¸­å‘é€ä¸€æ¬¡äº¤æ˜“åï¼Œå¯ä»¥åœ¨è¯¦ç»†ä¿¡æ¯ä¸­çœ‹è§`input`å³ä¸ºæ­¤æ¬¡äº¤æ˜“çš„`calldata`

![tx input in remix](assets/29-1-0cdac97a91d23b8b328265d1df3a56b5.png)

å‘é€çš„`calldata`ä¸­å‰4ä¸ªå­—èŠ‚æ˜¯`selector`ï¼ˆå‡½æ•°é€‰æ‹©å™¨ï¼‰ã€‚è¿™ä¸€è®²ï¼Œæˆ‘ä»¬å°†ä»‹ç»`selector`æ˜¯ä»€ä¹ˆï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ã€‚

### 4.13.1 `msg.data`

`msg.data`æ˜¯`solidity`ä¸­çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå€¼ä¸ºå®Œæ•´çš„`calldata`ï¼ˆè°ƒç”¨å‡½æ•°æ—¶ä¼ å…¥çš„æ•°æ®ï¼‰ã€‚

åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`Log`äº‹ä»¶æ¥è¾“å‡ºè°ƒç”¨`mint`å‡½æ•°çš„`calldata`ï¼š

```solidity
    // event è¿”å›msg.data
    event Log(bytes data);

    function mint(address to) external{
        emit Log(msg.data);
    }
```



å½“å‚æ•°ä¸º`0x2c44b726ADF1963cA47Af88B284C06f30380fC78`æ—¶ï¼Œè¾“å‡ºçš„`calldata`ä¸º

```text
0x6a6278420000000000000000000000002c44b726adf1963ca47af88b284c06f30380fc78
```



è¿™æ®µå¾ˆä¹±çš„å­—èŠ‚ç å¯ä»¥åˆ†æˆä¸¤éƒ¨åˆ†ï¼š

```text
å‰4ä¸ªå­—èŠ‚ä¸ºå‡½æ•°é€‰æ‹©å™¨selectorï¼š
0x6a627842

åé¢32ä¸ªå­—èŠ‚ä¸ºè¾“å…¥çš„å‚æ•°ï¼š
0x0000000000000000000000002c44b726adf1963ca47af88b284c06f30380fc78
```

å…¶å®`calldata`å°±æ˜¯å‘Šè¯‰æ™ºèƒ½åˆçº¦ï¼Œæˆ‘è¦è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼Œä»¥åŠå‚æ•°æ˜¯ä»€ä¹ˆã€‚

### 4.13.2 `method id`ã€`selector`å’Œ`å‡½æ•°ç­¾å`

`method id`å®šä¹‰ä¸º`å‡½æ•°ç­¾å`çš„`Keccak`å“ˆå¸Œåçš„å‰4ä¸ªå­—èŠ‚ï¼Œå½“`selector`ä¸`method id`ç›¸åŒ¹é…æ—¶ï¼Œå³è¡¨ç¤ºè°ƒç”¨è¯¥å‡½æ•°ï¼Œé‚£ä¹ˆ`å‡½æ•°ç­¾å`æ˜¯ä»€ä¹ˆï¼Ÿ

å…¶å®åœ¨[4.5 è°ƒç”¨å…¶ä»–åˆçº¦](# 4.5 è°ƒç”¨å…¶ä»–åˆçº¦)ä¸­ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»äº†**å‡½æ•°ç­¾å**ï¼Œä¸º`"å‡½æ•°åï¼ˆé€—å·åˆ†éš”çš„å‚æ•°ç±»å‹)"`ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸Šé¢ä»£ç ä¸­`mint`çš„å‡½æ•°ç­¾åä¸º`"mint(address)"`ã€‚åœ¨åŒä¸€ä¸ªæ™ºèƒ½åˆçº¦ä¸­ï¼Œä¸åŒçš„å‡½æ•°æœ‰ä¸åŒçš„å‡½æ•°ç­¾åï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å‡½æ•°ç­¾åæ¥ç¡®å®šè¦è°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚

**æ³¨æ„**ï¼Œåœ¨å‡½æ•°ç­¾åä¸­ï¼Œ`uint`å’Œ`int`è¦å†™ä¸º`uint256`å’Œ`int256`ã€‚

æˆ‘ä»¬å†™ä¸€ä¸ªå‡½æ•°ï¼Œæ¥éªŒè¯`mint`å‡½æ•°çš„`method id`æ˜¯å¦ä¸º`0x6a627842`ã€‚å¤§å®¶å¯ä»¥è¿è¡Œä¸‹é¢çš„å‡½æ•°ï¼Œçœ‹çœ‹ç»“æœã€‚

```solidity
    function mintSelector() external pure returns(bytes4 mSelector){
        return bytes4(keccak256("mint(address)"));
    }
```

ç»“æœæ­£æ˜¯`0x6a627842`ï¼š



### 4.13.3 ä½¿ç”¨`selector`

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨`selector`æ¥è°ƒç”¨ç›®æ ‡å‡½æ•°ã€‚ä¾‹å¦‚æˆ‘æƒ³è°ƒç”¨`mint`å‡½æ•°ï¼Œæˆ‘åªéœ€è¦åˆ©ç”¨`abi.encodeWithSelector`å°†`mint`å‡½æ•°çš„`method id`ä½œä¸º`selector`å’Œå‚æ•°æ‰“åŒ…ç¼–ç ï¼Œä¼ ç»™`call`å‡½æ•°ï¼š

```solidity
    function callWithSignature() external returns(bool, bytes memory){
        (bool success, bytes memory data) = address(this).call(abi.encodeWithSelector(0x6a627842, 0x2c44b726ADF1963cA47Af88B284C06f30380fC78));
        return(success, data);
    }
```



åœ¨æ—¥å¿—ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`mint`å‡½æ•°è¢«æˆåŠŸè°ƒç”¨ï¼Œå¹¶è¾“å‡º`Log`äº‹ä»¶ã€‚







# 5 å®æˆ˜

[å®æˆ˜](å®æˆ˜.md)





# 6 ç¼–è¯‘

1. **ABIï¼ˆApplication Binary Interfaceï¼‰**ï¼šABI æè¿°äº†åˆçº¦çš„å¤–éƒ¨æ¥å£ï¼ŒåŒ…æ‹¬åˆçº¦çš„å‡½æ•°ã€äº‹ä»¶ç­‰ä¿¡æ¯ã€‚å®ƒå®šä¹‰äº†åˆçº¦å¦‚ä½•ä¸å…¶ä»–åˆçº¦æˆ–è€…å¤–éƒ¨è°ƒç”¨è€…è¿›è¡Œäº¤äº’ã€‚ABI åœ¨ JSON æ–‡ä»¶ä¸­ä»¥é”®å€¼å¯¹çš„å½¢å¼è¡¨ç¤ºï¼ŒåŒ…å«äº†**å‡½æ•°çš„åç§°**ã€**å‚æ•°ç±»å‹**ã€**è¿”å›å€¼ç±»å‹**ç­‰ä¿¡æ¯ã€‚
   
2. **Dataï¼ˆBytecodeï¼‰**ï¼šè¿™éƒ¨åˆ†æ•°æ®æ˜¯åˆçº¦çš„å­—èŠ‚ç ï¼ˆbytecodeï¼‰ï¼Œå®ƒæ˜¯åˆçº¦ç¼–è¯‘åçš„äºŒè¿›åˆ¶ä»£ç ã€‚å­—èŠ‚ç åŒ…å«äº†åˆçº¦çš„**å®é™…æ‰§è¡Œä»£ç **ï¼ŒåŒ…æ‹¬**å‡½æ•°å®ç°**ã€**å˜é‡åˆå§‹åŒ–**ç­‰ã€‚éƒ¨ç½²åˆçº¦æ—¶ï¼Œéœ€è¦å°†å­—èŠ‚ç å‘é€åˆ°ä»¥å¤ªåŠç½‘ç»œä¸Šï¼Œä»¥ä¾›ç½‘ç»œæ‰§è¡Œåˆçº¦éƒ¨ç½²æ“ä½œã€‚
   
3. **Deploy**ï¼šè¿™ä¸ªéƒ¨åˆ†åŒ…å«äº†åˆçº¦çš„éƒ¨ç½²ç›¸å…³ä¿¡æ¯ï¼Œä¾‹å¦‚åˆçº¦çš„**æ„é€ å‡½æ•°å‚æ•°**ã€**åˆçº¦ä½œè€…**ç­‰ã€‚è¿™äº›ä¿¡æ¯åœ¨éƒ¨ç½²åˆçº¦æ—¶å¯èƒ½ä¼šç”¨åˆ°ï¼Œä»¥ç¡®ä¿åˆçº¦èƒ½å¤Ÿæ­£ç¡®éƒ¨ç½²åˆ°ä»¥å¤ªåŠç½‘ç»œä¸Šã€‚

### é“¾ä¸Šæ“ä½œ

é“¾ä¸Šæ“ä½œæ˜¯æŒ‡éœ€è¦åœ¨åŒºå—é“¾ç½‘ç»œä¸­è¿›è¡Œçš„æ“ä½œï¼Œè¿™äº›æ“ä½œä¼šè¢«çŸ¿å·¥ï¼ˆæˆ–éªŒè¯è€…ï¼‰è®°å½•åœ¨åŒºå—é“¾ä¸Šï¼Œå¹¶éœ€è¦æ¶ˆè€—Gasï¼ˆä»¥å¤ªåŠç½‘ç»œä¸­çš„äº¤æ˜“è´¹ç”¨ï¼‰ã€‚

- **æ™ºèƒ½åˆçº¦æ‰§è¡Œ**ï¼šä»»ä½•è°ƒç”¨æ™ºèƒ½åˆçº¦å‡½æ•°çš„æ“ä½œï¼Œéƒ½ä¼šåœ¨åŒºå—é“¾ä¸Šæ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œè½¬è´¦ã€æ‰§è¡Œæ™ºèƒ½åˆçº¦ä¸­çš„å‡½æ•°ç­‰ã€‚è¿™äº›æ“ä½œéƒ½ä¼šè¢«è®°å½•åœ¨åŒºå—é“¾çš„äº¤æ˜“è®°å½•ä¸­ã€‚
- **äº¤æ˜“æäº¤**ï¼šç”¨æˆ·ç­¾åå¹¶æäº¤åˆ°åŒºå—é“¾ç½‘ç»œçš„äº¤æ˜“ï¼Œæ¯”å¦‚å‘é€ETHæˆ–å…¶ä»–ä»£å¸çš„äº¤æ˜“ã€‚è¿™äº›äº¤æ˜“ä¼šè¢«çŸ¿å·¥æ‰“åŒ…å¹¶è®°å½•åœ¨åŒºå—é“¾ä¸­ã€‚
- **çŠ¶æ€æ›´æ–°**ï¼šä»»ä½•å¯¼è‡´åŒºå—é“¾çŠ¶æ€å˜åŒ–çš„æ“ä½œï¼Œæ¯”å¦‚æ”¹å˜è´¦æˆ·ä½™é¢ã€æ›´æ–°æ™ºèƒ½åˆçº¦å­˜å‚¨çš„æ•°æ®ç­‰ã€‚

### é“¾ä¸‹æ“ä½œ

é“¾ä¸‹æ“ä½œæ˜¯æŒ‡åœ¨åŒºå—é“¾ç½‘ç»œä¹‹å¤–è¿›è¡Œçš„æ“ä½œï¼Œè¿™äº›æ“ä½œä¸ä¼šè¢«ç›´æ¥è®°å½•åœ¨åŒºå—é“¾ä¸Šï¼Œé€šå¸¸åœ¨ç”¨æˆ·çš„è®¾å¤‡æˆ–ä¸­å¿ƒåŒ–æœåŠ¡å™¨ä¸Šè¿›è¡Œã€‚

- **æ•°æ®ç­¾å**ï¼šä½¿ç”¨ç§é’¥å¯¹æ•°æ®è¿›è¡Œç­¾åã€‚è¿™æ˜¯ç”¨æˆ·åœ¨æœ¬åœ°è®¾å¤‡ä¸Šè¿›è¡Œçš„æ“ä½œï¼ŒåŒºå—é“¾ä¸ä¼šè®°å½•è¿™ä¸ªè¿‡ç¨‹ã€‚
- **äº¤æ˜“å‡†å¤‡**ï¼šåœ¨æœ¬åœ°æˆ–æœåŠ¡å™¨ä¸Šå‡†å¤‡äº¤æ˜“æ•°æ®ï¼ŒåŒ…æ‹¬è®¡ç®—Gasè´¹ç”¨ã€è®¾ç½®æ¥æ”¶åœ°å€ç­‰ã€‚
- **æ•°æ®å­˜å‚¨**ï¼šåœ¨é“¾ä¸‹æ•°æ®åº“æˆ–æ–‡ä»¶ç³»ç»Ÿä¸­å­˜å‚¨æ•°æ®ï¼Œä¸ä¼šç›´æ¥å½±å“åŒºå—é“¾çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œä¸­å¿ƒåŒ–æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“æ“ä½œã€‚